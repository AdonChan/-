{"title": "Storm thrift获取性能数据报错及解决 - 八牛博客 ", "index": "python,thrift,流计算-storm", "content": "现象\n\n我们想通过Storm提供的thrift接口来获取Toplogy的性能数据，比如emiited了多少，延迟是多少之类。但在使用Python开发过程中，发现getClusterInfo这个方法，会报错，thrift版本0.7，Storm版本为0.9.0.1，错误如下：\n\nTraceback (most recent call last):\n  File \"/home/frankyao/git/StormMetrics/main.py\", line 31, in <module>\n    topology_info = nimbus.getTopologyInfo(topology.id)\n  File \"./gen-py/storm/Nimbus.py\", line 584, in getTopologyInfo\n    return self.recv_getTopologyInfo()\n  File \"./gen-py/storm/Nimbus.py\", line 602, in recv_getTopologyInfo\n    result.read(self._iprot)\n  File \"./gen-py/storm/Nimbus.py\", line 2830, in read\n    self.success.read(iprot)\n  File \"./gen-py/storm/ttypes.py\", line 2724, in read\n    _elem265.read(iprot)\n  File \"./gen-py/storm/ttypes.py\", line 2600, in read\n    self.stats.read(iprot)\n  File \"./gen-py/storm/ttypes.py\", line 2391, in read\n    self.specific.read(iprot)\n  File \"./gen-py/storm/ttypes.py\", line 2280, in read\n    self.bolt.read(iprot)\n  File \"./gen-py/storm/ttypes.py\", line 1979, in read\n    _val128[_key134] = _val135\nTypeError: unhashable instance\n\n\n使用thrift 0.7还是失败\n\n这个问题看上去是thrift的问题，在Storm的源码中的storm-core/src/getthrift.sh里，发现应该使用thrift 0.7：\n\nthrift7 --gen java:beans,hashcode,nocamel --gen py:utf8strings storm.thrift\n\n\n随后我安装thrift 0.7，发现还是不行，依然报上面的错。\n\n在查了Google后，发现有一个大哥在今年二月也碰到这个问题，并且解决了。需要使用storm提供的thrift，并且要打上一个thrift的patch。\n\n解决方案\n\n\n\n使用storm提供的thrift：https://github.com/nathanmarz/thrift/archive/storm.zip\n\nwget https://github.com/nathanmarz/thrift/archive/storm.zip\nunzip storm.zip\ncd thrift-storm\n\n\n\n打上这个patch：https://issues.apache.org/jira/secure/attachment/12501771/thrift-1382.patch\n\nwget https://issues.apache.org/jira/secure/attachment/12501771/thrift-1382.patch\npatch -p0 < thrift-1382.patch\n\n\n\n安装thrift-storm\n\nsudo ./bootstrap.sh\nsudo ./configure\nsudo make\nsudo make install\n\n\n\n重新使用thrift生成python包\n\nthrift --gen py storm.thrift\n\n\n\n顺便想到的\n\n我想起了Storm在以前还依赖zeromq的时候，是zeromq还是jzmq来着，不能使用官方版本，要使用storm提供的一个特定版本。这个问题坑了很多人，在使用netty后，这个问题已经解决。\n\nStorm要获取这些运行时的性能数据，一定要使用thrift（或者抓取ui用dom分析，但这个非常麻烦），这个问题也是非常的坑爹。\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "0"}