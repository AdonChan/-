{"title": "scrapy爬虫使用Ghost.py动态获取cookie - magicfolks ", "index": "python,scrapy", "content": "前言\n前段时间在用scrapy爬取某个网站时一直报521错误，在seeting.py里设置HTTPERROR_ALLOWED_CODES= [521]后会发现返回的response是一段加密的js代码。这段js代码是动态取得cookie信息的（但是只有一个value,故放弃了使用python库去执行js的打算）,最后利用浏览器打开网页将其cookie手动添加到爬虫中会正常返回数据，最后找到了Ghost.py这个库去模拟浏览器打开网站行为并动态获取cookie信息的办法。\n具体步骤\n.安装Ghost.pysudo pip install Ghost.py==0.1.2\n返回最新的cookie\nfrom ghost import Ghost\nfrom scrapy import log\nimport re\nclass Cookieutil:\n\n    def __init__(self,url):\n        log.msg('init cookieutil class ,will be get %s cookie information!' %url, log.INFO)\n        gh = Ghost(download_images=False,display=False)\n        gh.open(url)\n        gh.open(url)\n        gh.save_cookies(\"cookie.txt\")\n        gh.exit()\n    def getCookie(self):\n        cookie = ''\n        with open(\"cookie.txt\") as f:\n            temp = f.readlines()\n            for index in temp:\n                cookie += self.parse_oneline(index).replace('\\\"','')\n        return cookie[:-1]\n    def parse_oneline(self,src):\n        oneline = ''\n        if re.search(\"Set-Cookie\",src):\n            oneline = src.split(';')[0].split(':')[-1].strip()+';'\n        return oneline\nscrapy的spider定时生成和调用cookie信息\n这里只贴上主要的代码\n    headers={\n        'Cookie':'',\n        'User-Agent':'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/535.2 (KHTML, like Gecko) Chrome/15.0.874.121 Safari/535.2',\n    }\n    headers['Cookie'] = Cookieutil('http://www.dmoz.org.cn/').getCookie()\n     def parse_page(self,response):\n        if int(time.time())-self.begin_time>3600:\n            print 'get a new cookie arrgment'\n            print self.headers['Cookie']\n            self.begin_time = int(time.time())\n            try:\n                self.headers['Cookie'] = Cookieutil('http://www.dmoz.org.cn/').getCookie()\n            except:\n                time.sleep(120)\n                self.headers['Cookie'] = Cookieutil('http://www.dmoz.org.cn/').getCookie()\n结语\n不过有个比较纠结的问题是Ghost.py需要依赖webkit,以致于在本地开发中能够正常运行，但是放到服务器中直接报错（Exception: Ghost.py requires PySide or PyQt4）。目前为止还没找到好的解决办法\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "1"}