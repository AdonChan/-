{"title": "🌧️未雨绸缪.再也不怕手贱删数据了 MySql数据回滚事纪 - 个人文章 ", "index": "mysql,binlog,python,excel", "content": "案发当天，中午2点的天气很是炎热，知了拼命的鸣叫，仿佛要和天气叫板，公司的老空调还算没有拖后腿，整个工作区温度适宜，我在整理一批刚结束的爬虫数据，一切都是那么正常，毫无征兆。\n复制sql语句，修改表名、列名，run~\n次奥 ！2.03s 删除了10万数据，数据虽然不多但是爬的辛苦啊，顿时感觉天气燥热，浑身是汗，呼吸困难，什么也不想干，就想骂人；\n一直以为这种事情不会发生在我身上，对于数据回滚的知识也一直是片空白，现在终于明白了，哪个CTO年轻的时候没有删过几个库，没干过这种蠢事说明你还 So Young；\n扯止。\n\n使用事务安全操作\n始于 BEGIN; 终于 ROLLBACK / COMMIT;\n\n啥也别说运行一次BEGIN;\n执行增/删/改sql语句，然后使用select查看是否操作正确；\n如果正确运行一次COMMIT; 否则运行一次ROLLBACK;\n\n举个栗子🌰🐿️\n操作之前的数据：\nSELECT * from sys_user where id = 2 ;\n结果：2    123456 mshu 123456  11855079819 2018-04-30 11:41:03  无不良记录    100    100\nROLLBACK；  使用\nBEGIN;\nDELETE FROM sys_user where id = 2;\nSELECT * from sys_user where id = 2 ;\n结果：\nROLLBACK;\nSELECT * from sys_user where id = 2 ;\n结果：2    123456 mshu 123456  11855079819 2018-04-30 11:41:03  无不良记录    100    100\nCOMMIT; 使用\nBEGIN;\nDELETE FROM sys_user where id = 2;\nSELECT * from sys_user where id = 2 ;\n结果：\nCOMMIT;\nSELECT * from sys_user where id = 2 ;\n结果：\n\n\n人都是懒惰的，每次操作sql,都要运行BEGIN；ROLLBACK / COMMIT实在太麻烦，当遇到概率事件时，人们往往会把有利于自己的一边的概率放大。                    ——Mshu\nMysql是有日志记录功能的，但是默认关闭，就像著名哲学家Mshu说的那样，Mysql也认为误操作是个概率事件，如果记录操作日志的话，时间久、频率高就会需要很大的空间，而且用不到的话就是一堆垃圾，所以它放小了不利自己的概率，认为没有必要开启。\n我猜我在这里鬼扯让读者感到很无聊，但是我真的觉得在这里扯很舒服，所以我认为这篇文章被人读到的概率也很小。\n为了保证文章顺利发表，言归正传\n开启logbin\n使用MySQL的日志记录功能，首先要确定是否开启了logbin，mysq命令：\nshow variables like '%log_bin%' \n结果：\n\n\nVariable\nvalue\n\n\n\nlog_bin\nON\n\n\nsql_log_bin\nON\n\n\nlog_bin_basename\nC:ProgramDataMySQLMySQL Server 5.7Datamysql-log\n\n\nlog_bin_index\nC:ProgramDataMySQLMySQL Server 5.7Datamysql-log.index\n\n\n\n很欣慰的看到我已经开启了logbin😊；\n怎么开启？\n如果没有开启需要修改my.ini文件，至于这个文件在哪，Linux当然使用whereis,Window的话，还是MySQL命令：\nshow variables like '%data%' \n结果：\n\n\nVariable\nvalue\n\n\ndatadir\nC:ProgramDataMySQLMySQL Server 5.7Data\\\n\n\n就在这个目录的父目录下。\n怎么修改？\n加菊花，呸，加句话：log-bin=mysql-log\n# Binary Logging.\n# log-bin\nlog-bin=mysql-log\n等号后面随便取，这将会是你的日志文件名，如我所取mysql-log\n重启服务器\n重启之后操作一番增删改后，可以看到日志文件，目录就在show variables like '%data%'显示的 datadir指向的文件夹里\n文件名为你刚刚设置的名字加00000加数字的二进制文件\n如：mysql-log.000001\n这就是MySQL的日志文件。\n针对日志文件show一波命令\n\n\nflush logs\n至此生成新的日志文件\n\n\nreset master\n清空日志文件\n\n\n听说在此之前需要保证两个设置是对的\n\n存储引擎：InnoDB\n日志格式：ROW\n\n由于我的MySQL默认都是对的，我就没有测试，就简单介绍一下吧：\n查看存储引擎\nshow engines;\n查看日志格式\nshow variables like '%binlog_format%';\n\n\nmysqlog\n怎么阅读日志文件？\n下面开始画重点，这也是我写这篇文章的重要目的既然日志文件是二进制，怎么使用呢，感兴趣的小伙伴可以了解一下mysqlbinlog命令，这里不做重点；重点是我写的一个小工具，使用简单，操作流畅，令人心旷神怡。\n功能介绍：根据MySQL二进制日志文件，生成人类可以理解的操作记录文件，以excel人性化呈现；而你只需要提供二进制文件以及数据库ip、用户名、和密码即可项目使用python3开发，所以你电脑要安装python；\n项目目录：\n\n使用步骤：\n\n/log0000/文件夹内放你要解析的二进制日志文件\n在main.py文件中填入config配置（数据库ip、用户名、和密码）\n运行主方法，在/result/文件下可得到解析结果。\n\n运行结果：\n包含时间、增删改的类型且用不同颜色区分明显，数据库，表，需要回滚的sql语句，以及当时执行的语句；一目了然。\n\n本工具主要是用来解析mysql的操作日志，除了生成当时执行的sql语句外，还有为了数据回滚的sql语句，都是标准的sql,可以直接复制运行。给使用者来分析和回滚，我把它命名为mysqlog，<---链接为GitHub地址。\n数据回滚很重要，误删数据别哭闹。MysqLog福带到，让你眉开又眼笑。好言相劝若不理，删库跑路就是你。\n免责声明\n本项目作者放荡不羁，不能保证项目准确无误，数据无价，对于生成的sql，请适当检查后使用。\n\n                ", "mainLikeNum": ["3 "], "mainBookmarkNum": "3"}