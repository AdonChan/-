{"title": "Fabric 实践：local 并发执行 - yexiaoxiaobai ", "index": "python,fabric", "content": "环境：\nfabric 服务器：10.10.1.1\n目标服务器组：test.com （10.10.1.2-21）一共 20 台服务器\n\n需求：\n\n我需要把我 fabric 服务器上的某些文件同步到 test.com 集群，但是我又需要并发执行，而不是通过 for 循环或者是串行的方式。\n\n先直接上代码再针对性的解释：\n\n#!/usr/bin/python env\n#-*- coding: utf-8 -*-\n\nfrom fabric.api import env\nfrom fabric.api import run\nfrom fabric.api import put\nfrom fabric.api import execute\nfrom fabric.api import roles\nfrom fabric.api import parallel\nfrom fabric.api import cd\nfrom fabric.api import lcd\nfrom fabric.api import task\nfrom fabric.api import local\nfrom fabric.api import settings\nfrom fabric.api import hide\nfrom fabric.colors import red ### 使输出有色彩\nfrom fabric.colors import green\n\n### 下面这个角色在我实际的使用中，我是不需要填写的，因为我实际使用是从 CMDB 动态获取集群的服务器列表的。为了测试，所以弄了下面的\n\nenv.user = 'test'\nenv.password = 'test'\nenv.roledefs = {\n   'test.com':['10.10.1.2','10.10.1.3','10.10.1.4','10.10.1.5',......],# 省略下，\n}\n\n\n######### reload data and rsync data###########\ndef rsync_test(host): ### 传入 host 主机 IP 参数\n    with settings(hide('running','stdout'), warn_only=True): ## hide 是表示不输入信息到 sreen，可以写 'everything'，'stderr','running' 等等\n        with lcd('/tmp/'):\n           result = local('rsync -Pav test \"%s\":/tmp/' % host) ### 根据不同的主机 rsync 到不同的主机服务器\n           if result.return_code == 0: ##可以根据上面数据是否成功执行下一步操作。\n               print (green(\"-------------------------\"))\n               print (red(\"*******主机 %s 同步数据成功******\" % host))\n               print (green(\"-------------------------\"))\n           else:\n               print (green(\"-------------------------\"))\n               print (red(\"*******主机 %s 同步数据失败******\" % host))\n               print (green(\"-------------------------\"))\n\n@task\n@roles('test.com')\n@parallel(pool_size=16)\ndef execute_rsync():\n    execute(rsync_test, env.host) ### 读取 @roles('test.com') 里面的主机，并把 host 传递给 rsync_test 函数，并且 @parallel(pool_size=16) 来并发\n\n\n@roles('test.com')\n@parallel(pool_size=5)\ndef echo_hello():\n    run('echo \"hello world!\"')\n\n\n\n执行任务：\n\nfab execute_rsync\n\n\n输出是：\n\n#### 省略抹除了一些信息\n\n同步数据成功******\n-------------------------\n\nDone.\n\nreal    0m1.263s\nuser    0m0.793s\nsys     0m0.689s\n\n\n如果没有使用并发的话，执行时间为：\n\n-------------------------\n\nDone.\n\nreal    0m3.680s\nuser    0m0.664s\nsys     0m0.512s\n\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "7"}