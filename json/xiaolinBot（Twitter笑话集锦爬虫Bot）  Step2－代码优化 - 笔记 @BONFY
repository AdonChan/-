{"title": "xiaolinBot（Twitter笑话集锦爬虫Bot）  Step2－代码优化 - 笔记 @BONFY ", "index": "robot,twitter,python爬虫,python", "content": "Step2 - 代码优化\n简介\n这篇我们简要的讨论一下代码优化，这里主要讨论两点\n\n过程到函数\n加入对media的处理\nPEP8\n\n我们在Step1中的编码是面向过程的，这个不利于复用，所以我们简单的将我们前面的代码函数化，方便以后扩展及别人的调用\n另外，Python代码最好符合PEP8规范，方便自己和别人阅读\n编码\n创建 utils/common.py\nimport os\nimport requests\n\nPROXIES = None\n\nHEADERS = {\n    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1)'\n                  ' AppleWebKit/537.36 (KHTML, like Gecko) '\n                  'Chrome/38.0.2125.122 Safari/537.36',\n    'Accept': 'text/html,application/xhtml+xml,'\n              'application/xml;q=0.9,image/webp,*/*;q=0.8',\n    'Accept-Encoding': 'gzip,deflate,sdch',\n    'Accept-Language': 'zh-CN,zh;q=0.8'\n}\n\n\n################################\n#\n# requests Operation\n#\n################################\n\n\ndef GetPage(url, proxies=PROXIES, headers=HEADERS):\n    r = requests.get(url, proxies=proxies, headers=headers)\n    assert r.status_code == 200\n    return r.text\n\n\ndef GetMedia(\n        url, proxies=PROXIES, headers=HEADERS, chunk_size=512,\n        media_type='pic'):\n    r = requests.get(url, proxies=proxies, headers=headers, stream=True)\n    filename = 'download/' + media_type + '/' + os.path.basename(url)\n    with open(filename, 'wb') as fd:\n        for chunk in r.iter_content(chunk_size):\n            fd.write(chunk)\n    return filename\n这里主要封装了两个方法： GetPage 与 GetMedia\nGetPage: 传入页面url 获得 整个页面\nGetMeida: 传入图片或者视频的url， 下载媒体文件到 download/pic 或者  download/video（主要为了后续支持百思不得姐的视频）\nmain.py 更改为：\n# coding: utf-8\n\nfrom pyquery import PyQuery as pq\nfrom utils.common import GetMedia, GetPage\n\n__author__ = 'BONFY CHEN <foreverbonfy@163.com>'\n\n\n####################\n#\n# main function\n#\n####################\n\ndef qiushi():\n    url = 'http://www.qiushibaike.com/'\n    page = GetPage(url)\n    d = pq(page)\n    contents = d(\"div .article\")\n    for item in contents:\n        i = pq(item)\n        pic_url = i(\"div .thumb img\").attr.src\n        content = i(\"div .content\").text()\n        id = i.attr.id\n        if pic_url:\n            pic_path = GetMedia(pic_url)\n            print('pic - {id}: {content} \\npic下载到{pic_path}'.format(\n                id=id, content=content, pic_path=pic_path))\n        else:\n            print('text - {id}: {content}'.format(id=id, content=content))\n\n\ndef main():\n    qiushi()\n\n\nif __name__ == '__main__':\n    main()\n运行结果：\n\nPEP8\n$ pip install pep8\n$ pep8 xiaolinBot\n然后如果有不符合规范的代码，会显示提示，然后去更改就行了\n\n完整代码\n详情见 https://github.com/bonfy/xiaolinBot\n欢迎关注一起交流\n敬请期待下一篇： 适配器\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "3"}