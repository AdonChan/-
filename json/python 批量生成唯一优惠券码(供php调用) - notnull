{"title": "python 批量生成唯一优惠券码(供php调用) - notnull ", "index": "php,python", "content": "python 批量生成优惠券码并写入数据表\n说明:这篇文章主要讲的是个人工作中遇到的解决问题的方法,而非程序写的多优美。要完善的地方太多了，大家嘴下留情\nwhy do this\n为什么要这么做？优惠券码直接在用的时候用程序直接生成不就OK了吗?\n好,那么问题来了,我们的系统需要一次性发送几十万张优惠券,怎么破。这里引来这个问题(php编写的web程序)\n1.通过php函数来生成几十万个优惠券码,然后分批次比如每次1000插入到数据表中,主要考虑到这几十万的码会占用大量内存,而且php执行时间也会过长,虽然可以设置超时时间,但总归不是better的解决方案\n2.现有各个系统中都存在自己优惠券码的生成规则,但是数据表却是同一张,有了这个优惠码池,各个系统就无需再自己生成优惠码,而是直接要用多少读取多少即可。\n引申出优惠券码池表(保证code值唯一)\n数据表结构\nCREATE TABLE `prefix_coupon_pool` (\n  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT '自增ID',\n  `code` varchar(32) NOT NULL COMMENT '优惠券码 唯一性约束',\n  `is_assigned` tinyint(1) DEFAULT '0' COMMENT '0:未分配 1:已分配',\n  `created_at` int(10) unsigned DEFAULT '0' COMMENT '生成时间',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `index_code` (`code`)\n) ENGINE=InnoDB AUTO_INCREMENT=0 DEFAULT CHARSET=utf8;\npython 代码说明\n1.安装python-dotenv用来获取.env配置\ngit:https://github.com/theskumar/python-dotenv\n2.建立.env文件\n  DB_HOST=localhost\n  DB_DATABASE=test\n  DB_USERNAME=root\n  DB_PASSWORD=root\n  DB_PORT=3306\n调用方法 ./pymakecoupon.py pp 6 10000\n\npp:优惠券前缀\n6：优惠券长度\n10000:生成个数\npython源码如下\n#!/usr/bin/env python\n#coding:utf-8\n\nimport random\nimport string\nfrom os.path import join, dirname\nfrom dotenv import load_dotenv\nfrom mysql import connector\nimport mysql\nimport os\nimport time\nimport sys\n\n\noriginCode = string.ascii_lowercase\nfailedRecord = 0\n\ndef getConnection():\n    dotenv_path = join(dirname(__file__), '.env')\n    print dotenv_path\n    load_dotenv(dotenv_path)\n    host = os.environ.get('DB_HOST')\n    user = os.environ.get('DB_USERNAME')\n    password = os.environ.get('DB_PASSWORD')\n    database = os.environ.get('DB_DATABASE')\n    port = os.environ.get('DB_PORT')\n    try:\n        connect = connector.connect(host=host, user=user, password=password, database=database, port=port)\n        return connect\n    except mysql.connector.Error as e:\n        print e\n        return False\n    except Exception as e:\n        return False\n\ndef makeCouponCode(prefix='p', length = 6):\n    str = prefix\n    if length == 0:\n        pass\n    for index in range(length):\n        str += random.choice(originCode)\n    return str\n\nif __name__ == '__main__':\n    args = sys.argv\n    codeList = []\n    if len(args) != 4:\n        print '参数错误,调用方式为:./pymakecoupon.py p10 6 100'\n        exit()\n    try:\n        prefix = args[1]\n        length = int(args[2])\n        count = int(args[3])\n    except IndexError as e:\n        print '参数错误'\n\n    msg = '将生成前缀为:%s,优惠券长度为:%s,总共%s个优惠券码'\n    msg = msg % (prefix, length, count)\n    print msg\n    inputPrompt = raw_input('y/n\\n')\n    if inputPrompt == 'y':\n        pass\n    else:\n        print 'bye'\n        exit\n\n    connect = getConnection()\n    if connect == False:\n        sys.exit(0)\n    cursor = connect.cursor()\n    codeString = ''\n    now = int(time.time())\n    for index in range(1,count+1):\n        pass\n        code = makeCouponCode(prefix,length)\n        codeTemplate = '(\\'%s\\',%s)'\n        code = codeTemplate % (code,now)\n        codeList.append(code)\n        print code\n        if index % 1000 == 0:\n            codeString = \",\".join(codeList)\n            sql = 'INSERT IGNORE INTO prefix_coupon_pool(code,created_at)VALUES %s'\n            sql = sql % (codeString)\n            cursor.execute(sql)\n            connect.commit()\n    connect.close\n\n\n\n\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "8"}