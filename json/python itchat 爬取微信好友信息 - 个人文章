{"title": "python itchat 爬取微信好友信息 - 个人文章 ", "index": "python爬虫,python", "content": "原文链接：https://mp.weixin.qq.com/s/4EXgR4GkriTnAzVxluJxmg\n\n「itchat」一个开源的微信个人接口，今天我们就用itchat爬取微信好友信息，无图言虚空  三张图分别是「微信好友头像拼接图」、「性别统计图」、「个性签名统计图」  \n「微信好友头像拼接图」  \n「性别统计图」  \n「个性签名统计图」  \n安装\npip3 install itchat\n主要用到的方法：  itchat.login() 微信扫描二维码登录  itchat.get_friends() 返回完整的好友列表，每个好友为一个字典, 其中第一项为本人的账号信息，传入update=True, 将更新好友列表并返回, get_friends(update=True)  itchat.get_head_img(userName=\"\") 根据userName获取好友头像\n微信好友头像拼接图\n获取好友信息，get_head_img拿到每个好友的头像，保存文件，将头像缩小拼接至一张大图。  先获取好友头像：\ndef headImg():\n    itchat.login()\n    friends = itchat.get_friends(update=True)\n    # itchat.get_head_img() 获取到头像二进制，并写入文件，保存每张头像\n    for count, f in enumerate(friends):\n        # 根据userName获取头像\n        img = itchat.get_head_img(userName=f[\"UserName\"])\n        imgFile = open(\"img/\" + str(count) + \".jpg\", \"wb\")\n        imgFile.write(img)\n        imgFile.close()\n这里需要提前在同目录下新建了文件夹img，否则会报No such file or directory错误，img用于保存头像图片，遍历好友列表，根据下标count命名头像，到这里可以看到文件夹里已经保存了所有好友的头像。  \n接下来就是对头像进行拼接 \n遍历文件夹的图片，random.shuffle(imgs)将图片顺序打乱\n用640*640的大图来平均分每一张头像，计算出每张正方形小图的长宽，压缩头像，拼接图片，一行排满，换行拼接，好友头像多的话，可以适当增加大图的面积，具体代码如下：\ndef createImg():\n    x = 0\n    y = 0\n    imgs = os.listdir(\"img\")\n    random.shuffle(imgs)\n    # 创建640*640的图片用于填充各小图片\n    newImg = Image.new('RGBA', (640, 640))\n    # 以640*640来拼接图片，math.sqrt()开平方根计算每张小图片的宽高，\n    width = int(math.sqrt(640 * 640 / len(imgs)))\n    # 每行图片数\n    numLine = int(640 / width)\n\n    for i in imgs:\n        img = Image.open(\"img/\" + i)\n        # 缩小图片\n        img = img.resize((width, width), Image.ANTIALIAS)\n        # 拼接图片，一行排满，换行拼接\n        newImg.paste(img, (x * width, y * width))\n        x += 1\n        if x >= numLine:\n            x = 0\n            y += 1\n\n    newImg.save(\"all.png\")\n\n好友头像图成型，头像是随机打乱拼接的  \n\n性别统计图\n同样itchat.login()登录获取好友信息，根据Sex字段判断性别，1 代表男性（man），2 代表女性（women），3 未知（unknown）\ndef getSex():\n    itchat.login()\n    friends = itchat.get_friends(update=True)\n    sex = dict()\n    for f in friends:\n        if f[\"Sex\"] == 1: #男\n            sex[\"man\"] = sex.get(\"man\", 0) + 1\n        elif f[\"Sex\"] == 2: #女\n            sex[\"women\"] = sex.get(\"women\", 0) + 1\n        else: #未知\n            sex[\"unknown\"] = sex.get(\"unknown\", 0) + 1\n    # 柱状图展示\n    for i, key in enumerate(sex):\n        plt.bar(key, sex[key])\n    plt.show()\n性别统计柱状图\n个性签名统计图\n获取好友信息，Signature字段是好友的签名，将个性签名保存到.txt文件，部分签名里有表情之类的会变成emoji 类的词，将这些还有特殊符号的替换掉。\ndef getSignature():\n    itchat.login()\n    friends = itchat.get_friends(update=True)\n    file = open('sign.txt', 'a', encoding='utf-8')\n    for f in friends:\n        signature = f[\"Signature\"].strip().replace(\"emoji\", \"\").replace(\"span\", \"\").replace(\"class\", \"\")\n        # 正则匹配\n        rec = re.compile(\"1f\\d+\\w*|[<>/=]\")\n        signature = rec.sub(\"\", signature)\n        file.write(signature + \"\\n\")\n\nsign.txt文件里写入了所有好友的个性签名，使用wordcloud包生成词云图，pip install wordcloud  同样可以采用jieba分词生成词图，不使用分词的话就是句子展示，使用jieba分词的话可以适当把max_font_size属性调大，比如100。   需要注意的是运行不要在虚拟环境下，deactivate 退出虚拟环境再跑，详细代码如下：\n\n# 生成词云图\ndef create_word_cloud(filename):\n    # 读取文件内容\n    text = open(\"{}.txt\".format(filename), encoding='utf-8').read()\n\n    # 注释部分采用结巴分词\n    # wordlist = jieba.cut(text, cut_all=True)\n    # wl = \" \".join(wordlist)\n\n    # 设置词云\n    wc = WordCloud(\n        # 设置背景颜色\n        background_color=\"white\",\n        # 设置最大显示的词云数\n        max_words=2000,\n        # 这种字体都在电脑字体中，window在C:\\Windows\\Fonts\\下，mac下可选/System/Library/Fonts/PingFang.ttc 字体\n        font_path='C:\\\\Windows\\\\Fonts\\\\simfang.ttf',\n        height=500,\n        width=500,\n        # 设置字体最大值\n        max_font_size=60,\n        # 设置有多少种随机生成状态，即有多少种配色方案\n        random_state=30,\n    )\n\n    myword = wc.generate(text)  # 生成词云 如果用结巴分词的话，使用wl 取代 text， 生成词云图\n    # 展示词云图\n    plt.imshow(myword)\n    plt.axis(\"off\")\n    plt.show()\n    wc.to_file('signature.png')  # 把词云保存下\n\n句子图\n\n使用jieba分词产生的词云图  看来，「努力」 「生活」 还是很重要的  \nitchat 除了以上的信息，还有省市区等等信息都可以抓取，另外还可以实现机器人自动聊天等功能，这里就不一一概述了。  \n最后附上github地址：https://github.com/taixiang/itchat_wechat  \n欢迎关注我的博客：https://blog.manjiexiang.cn/  欢迎关注微信号：春风十里不如认识你  \n\n                ", "mainLikeNum": ["1 "], "mainBookmarkNum": "4"}