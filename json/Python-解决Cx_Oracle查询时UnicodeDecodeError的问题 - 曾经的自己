{"title": "Python-解决Cx_Oracle查询时UnicodeDecodeError的问题 - 曾经的自己 ", "index": "datatables,oracle,python", "content": "近期在项目中,要对1张100多万条记录的表进行查询,然后进行一些数据的统计,但是在这个过程中,发现只查询出来几条数据就出现了UnicodeDecodeError了。  在这里,我们使用sqlalchemy库进行查询,其内部还是Cx_Oracle来进行对应的操作,使用的Python版本为3.5.0,宿主系统为Windows 2008 Server,然后进行类似如下的操作:\nfrom sqlalchemy import create_engine\n\nengine = create_engine('oracle://demo:123456@192.168.1.202/TEST')\nconn = engine.connect()\nsql = 'select t.type from TS t'\nresult = conn.execute(sql)\nfor row in result:\n    print(row['type'])\n在这里,我们首先创建1个到数据库的连接,然后进行对应的查询操作。很不幸的是,只查询不到10条记录就出现了1个UnicodeDecodeError错误了。  本来以为是数据库的服务器编码问题,因此在create_engine函数中追加了encoding参数,将其更改为:\nengine = create_engine('oracle://demo:123456@192.168.1.202/TEST',encoding=\"UTF-8\")\n而另外1种可用的方式直接在连接路径中指定编码,类似如下:\nengine = create_engine('oracle://demo:123456@192.168.1.202/TEST?charset=utf-8')\n但是问题还是没有解决。在网上搜索了一下都没有找到适应的解决方案,突然想起来之前在使用Mysql数据库(个人喜欢Postgresql多一些)的时候,出现乱码的时候,我们常常会进行如下的操作:\nset names gbk;\n\n我们通过这种方式设置客户端的编码,而不是服务器端的编码,来解决终端下出现乱码的情况(由于Postgresql默认数据库就是UTF-8因此出现乱码的可能性较低)。而另外在Linux下安装Oracle的客户端时,设置了1个NLS_LANG的环境变量,详情可以参考Ubuntu14.04安装Oracle Instant Client这篇文章,当然这篇文章有一些细节的东西没有介绍。  一般情况下,我们在cmd中进行如下的设置:\nsetenv NLS_LANG=SIMPLIFIED CHINESE_CHINA.ZHS16GBK\n\n我们指定Oracle消息使用的语言为简体中文,而客户端的字符集为GBK。  另外,我们还可以执行如下的语句来确保上述的操作是正确的:\nSELECT * FROM v$nls_parameters;\n\n由于上述数据库服务器是部署在Windows上的,因此其结果自然为GBK,因此如果我们客户端使用UTF8字符集进行解码,自然而言会出现解码的错误。  我们需要注意的是,只有在数据库服务器端与客户端的编码一致的情况下,我们才能正常的显示非ASCII编码,而在sqlalchemy中默认会将查询的字符串强制将其转换为Unicode。因此类似Python3的如下过程:\n>>> a='中国'.encode('gbk')\n>>> a\nb'\\xd6\\xd0\\xb9\\xfa'\n而在sqlalchemy中由于强制进行编码转换,因此类似执行如下的过程:\n>>> a.decode('utf-8')\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xd6 in position 0: invalid continuation byte\n因此就出现上述的问题了。而正常的情况应该指定其编码为GBK:\n>>> a.decode('gbk')\n'中国'\n而设定NLS_LANG就是相当于修改上述的编码为GBK。  \n参考文章:\nhttp://docs.oracle.com/cd/E12...docs.sqlalchemy.org/en/latest/core/engines.html\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "0"}