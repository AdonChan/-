{"title": "10分钟上线 - 利用函数计算构建微信小程序的Server端 - 个人文章 ", "index": "javascript,python,微信小程序,serverless", "content": "前言\n这篇文章适合所有的想微信小程序开发新手、老鸟以及想准备学习开发微信小程序的程序猿。本文以开发一个类似\"语音口令红包“小程序为例，向您讲解如何使用阿里云函数计算快速构建微信小程序的服务端。通过本文，您将会了解以下内容:\n\ndemo概览\n传统服务器架构 VS Serverless架构\nServerless架构详解\ndemo开发配置步骤\n\n\ndemo概览\n在本教程中，我们讲解如何利用函数计算一步一步来构建微信小程序的server端，其中小程序参考\"口令红包\", 实现一个简单版本，该demo中可以展示口令生成，口令转发，口令语音验证。\n微信语音红包小程序是基于微信小程序而开发的语音红包，发起者可以写下想要让别人说的话（口令），并且将钱塞入此红包中，其他用户只要读出这句话（口令）就可以获得红包。语音红包可以发到特定的好友、微信群以及朋友圈，朋友需要根据文字口令说出相应的语音，才能获得红包。这种互动行为,在朋友圈或者微信群社交的场景下，可以极大调动互动活跃度，规则简单方便，体验趣味十足，口令的形式丰富多样(恶搞、示爱、祝贺、说口号、甚至是广告语)，这些都让口令红包一直维持很高的热度。\ndemo客户端小程序具体效果截图如下:\n生成口令\n\n转发口令\n\n录音验证口令\n\n\n传统服务器架构 VS Serverless架构\n正常来说，除了少数纯客户端的微信小程序运用，绝大部分的小程序都有自己的server端。用户开发server端服务，常常面临开发效率，运维成本高，机器资源弹性伸缩等痛点，而使用Serverless架构可以很好的解决上述问题。下面是传统架构和Serverless架构的对比：\n\n\nItem\nServerless\n传统方式搭建服务\n\n\n\n维护成本\n维护成本低，无需管理服务器等基础设施，只需编写代码并上传，程序员从底层设备维护中解放出来，只考虑实际业务逻辑即可。\n维护成本高，自行维护服务器，需要处理服务器宕机、服务器扩容等一系列底层琐碎的事情\n\n\n可用性\n可用性高，函数计算为用户准备弹性、可靠的计算资源，具有根据流量自动scale特性，对有明显波峰波谷的运用效果奇佳\n服务器故障会对应用服务产生严重影响\n\n\n费用\n按需付费，只为实际使用的计算资源付费，代码未运行则不产生费用\n需要支付服务器的费用，代码运行与否都要收费\n\n\n\n阿里云函数计算是一个事件驱动的全托管计算服务。通过函数计算，您无需管理服务器等基础设施，只需编写代码并上传。函数计算会为您准备好计算资源，以弹性、可靠的方式运行您的代码，并提供日志查询，性能监控，报警等功能。借助于函数计算，您可以快速构建任何类型的应用和服务，无需管理和运维。\n\nServerless架构详解\n\n方案大致如上图所示， 主要分为以下三个模块：\nLogin & Auth\n微信建议登录时序图如下, 其中第三方服务器用FC实现：\n\n语音识别(包含音频格式转换)\nffmpeg进行音频格式转换百度语言识别开发文档\n\n方案图下部虚线框柱的是可以拓展的模块，本demo中不展示，用户可以根据需求接入\n比如微信小程序直接上传文件到oss保存，函数计算可以从oss拉取对应的数据做处理；如果需要数据库功能，可以采用ots\n\ndemo开发配置步骤\n准备工作：\n1，开通阿里云账号，同时需要开通的产品有函数计算, api网关\n2，购买独立域名,同时需对域名备案，以及购买阿里云免费ssl证书,购买步骤可参考免费申请阿里云DV SSL证书\n3，开通微信小程序开发认证,以及百度语音识别\n4，从github下载相应的源码，里面client目录表示客户端，server表示用于创建函数。\nFC端\n1，利用源码中的server目录创建服务端函数，比如函数名为wechatEntry，有以下两种方案创建函数：\n利用控制台打包上传,设置对应的handler, 函数计算控制台使用可参考hello world, 特别是控制台上传代码包创建函数部分。下面是重要步骤截图:\n\n\n函数计算熟悉fcli的工具的老用户可以使用函数计算命令行工具fcli, fcli使用说明\n\nfcli function create -f wechatEntry  -h main.handler -d server -t python2.7 -s wechat\n注意：上面两种方案创建函数之前都需先把函数中main.py中相关开发配置改成自己申请的，包括微信小程序开发者相关配配置，百度语音识别相关配置\n\n2, 以函数计算作为 API 网关后端服务\n\napi网关支持https服务，具体可以参考api网关支持https\n\n函数计算作为api网关后端服务\napi网关中设置函数对应的api分组配置独立域名\n\n\n最后效果图以及调试界面如下：\n\nclient端\n按照微信小程序官方教程，创建对应的小程序账号以及工程，需要注意的是要把api网关中配置的域名添加到微信小程序的开发配置中:\n\n直接用微信小程序开发工具打开，修改对应请求域名和appid即可，打开如下图所示：\n\n总结\n利用函数计算可以快速搭建微信小程序的serverless运用，结合oss，ots可以丰富server的功能，免服务器，免运维，成本低，不用担心流量，只需要函数就可以实现，你值的拥有！\ngithub源码地址\n一些补充FAQ, 仅供参考\n怎么调试fc？\nfc可以接入sls，通过sls日志，可以查看你函数运行的情况，具体可以参考函数访问日志服务\n如果录入的语音文件很大，时间很长，导致语音识别服务时间很长，怎么办？\n可以参考函数计算流式处理大文件的分治思想对语音分割进行流式处理，或者直接选用有流式处理的语音识别的服务。\n如果想对语音文件或者其他文件做备份处理，怎么办？\n可以参考微信小程序中客户端utils文件夹下面的uploadAliyun.js\n声明\n\n微信小程序使用的图片和部分样式素材来自互联网，在此声明，这个demo仅仅是做学习交流展示使用，并没有涉及商业化，如果原作者看到，请在文章下面留言或者给我发邮件，我注明引用地址。\n欢迎大家通过扫码加入我们用户群中，搭建过程中有问题或者有其他问题可以在群里提出来。\n\n\n\n                ", "mainLikeNum": ["1 "], "mainBookmarkNum": "1"}