{"title": "Python爬虫小实践：寻找失踪人口，爬取失踪儿童信息并写成csv文件，方便存入数据库 - Python爬虫 ", "index": "java,c++,python,javascript,php", "content": "前两天有人私信我，让我爬这个网站，http://bbs.baobeihuijia.com/f...上的失踪儿童信息，准备根据失踪儿童的失踪时的地理位置来更好的寻找失踪儿童，这种事情本就应该义不容辞,如果对网站服务器造成负荷，还请谅解。\n这次依然是用第三方爬虫包BeautifulSoup，还有Selenium+Chrome，Selenium+PhantomJS来爬取信息。通过分析网站的框架，依然分三步来进行。\n步骤一：获取http://bbs.baobeihuijia.com/f...这个版块上的所有分页页面链接步骤二：获取每一个分页链接上所发的帖子的链接步骤三：获取每一个帖子链接上要爬取的信息，编号，姓名，性别，出生日期，失踪时身高，失踪时间，失踪地点，以及是否报案\n起先用的BeautifulSoup，但是被管理员设置了网站重定向，然后就采用selenium的方式，在这里还是对网站管理员说一声抱歉。\n1、获取http://bbs.baobeihuijia.com/f...这个版块上的所有分页页面链接\n\n通过分析：发现分页的页面链接处于<div class=\"pg\">下，所以写了以下的代码BeautifulSoup形式：\n[python] view plain copy\n1.def GetALLPageUrl(siteUrl):  \n2.    #设置代理IP访问  \n3.    #代理IP可以上http://http.zhimaruanjian.com/获取  \n4.    proxy_handler=urllib.request.ProxyHandler({'https':'111.76.129.200:808'})  \n5.    proxy_auth_handler=urllib.request.ProxyBasicAuthHandler()  \n6.    opener = urllib.request.build_opener(urllib.request.HTTPHandler, proxy_handler)  \n7.    urllib.request.install_opener(opener)  \n8.    #获取网页信息  \n9.    req=request.Request(siteUrl,headers=headers1 or headers2 or headers3)  \n10.    html=urlopen(req)  \n11.    bsObj=BeautifulSoup(html.read(),\"html.parser\")  \n12.    html.close()  \n13.    #http://bbs.baobeihuijia.com/forum-191-1.html变成http://bbs.baobeihuijia.com，以便组成页面链接  \n14.    siteindex=siteUrl.rfind(\"/\")  \n15.    tempsiteurl=siteUrl[0:siteindex+1]#http://bbs.baobeihuijia.com/  \n16.    tempbianhaoqian=siteUrl[siteindex+1:-6]#forum-191-  \n17.  \n18.    #爬取想要的信息  \n19.    bianhao=[]#存储页面编号  \n20.    pageUrl=[]#存储页面链接  \n21.    templist1=bsObj.find(\"div\",{\"class\":\"pg\"})  \n22.    for templist2 in templist1.findAll(\"a\",href=re.compile(\"forum-([0-9]+)-([0-9]+).html\")):  \n23.        lianjie=templist2.attrs['href']  \n24.        #print(lianjie)  \n25.        index1=lianjie.rfind(\"-\")#查找-在字符串中的位置  \n26.        index2=lianjie.rfind(\".\")#查找.在字符串中的位置  \n27.        tempbianhao=lianjie[index1+1:index2]  \n28.        bianhao.append(int(tempbianhao))  \n29.    bianhaoMax=max(bianhao)#获取页面的最大编号  \n30.  \n31.    for i in range(1,bianhaoMax+1):  \n32.        temppageUrl=tempsiteurl+tempbianhaoqian+str(i)+\".html\"#组成页面链接  \n33.        #print(temppageUrl)  \n34.        pageUrl.append(temppageUrl)  \n35.    return pageUrl#返回页面链接列表  \n\nSelenium形式：\n\n[python] view plain copy\n1.#得到当前板块所有的页面链接  \n2.#siteUrl为当前版块的页面链接  \n3.def GetALLPageUrl(siteUrl):  \n4.    #设置代理IP访问  \n5.    #代理IP可以上http://http.zhimaruanjian.com/获取  \n6.    proxy_handler=urllib.request.ProxyHandler({'post':'123.207.143.51:8080'})  \n7.    proxy_auth_handler=urllib.request.ProxyBasicAuthHandler()  \n8.    opener = urllib.request.build_opener(urllib.request.HTTPHandler, proxy_handler)  \n9.    urllib.request.install_opener(opener)  \n10.  \n11.    try:  \n12.        #掉用第三方包selenium打开浏览器登陆  \n13.        #driver=webdriver.Chrome()#打开chrome  \n14.       driver=webdriver.Chrome()#打开无界面浏览器Chrome  \n15.       #driver=webdriver.PhantomJS()#打开无界面浏览器PhantomJS  \n16.       driver.set_page_load_timeout(10)  \n17.       #driver.implicitly_wait(30)  \n18.       try:  \n19.           driver.get(siteUrl)#登陆两次  \n20.           driver.get(siteUrl)  \n21.       except TimeoutError:  \n22.           driver.refresh()  \n23.  \n24.       #print(driver.page_source)  \n25.       html=driver.page_source#将浏览器执行后的源代码赋给html  \n26.        #获取网页信息  \n27.    #抓捕网页解析过程中的错误  \n28.       try:  \n29.           #req=request.Request(tieziUrl,headers=headers5)  \n30.           #html=urlopen(req)  \n31.           bsObj=BeautifulSoup(html,\"html.parser\")  \n32.           #print(bsObj.find('title').get_text())  \n33.           #html.close()  \n34.       except UnicodeDecodeError as e:  \n35.           print(\"-----UnicodeDecodeError url\",siteUrl)  \n36.       except urllib.error.URLError as e:  \n37.           print(\"-----urlError url:\",siteUrl)  \n38.       except socket.timeout as e:  \n39.           print(\"-----socket timout:\",siteUrl)  \n40.  \n41.  \n42.  \n43.       while(bsObj.find('title').get_text() == \"页面重载开启\"):  \n44.           print(\"当前页面不是重加载后的页面，程序会尝试刷新一次到跳转后的页面\\n\")  \n45.           driver.get(siteUrl)  \n46.           html=driver.page_source#将浏览器执行后的源代码赋给html  \n47.           bsObj=BeautifulSoup(html,\"html.parser\")  \n48.    except Exception as e:  \n49.  \n50.        driver.close() # Close the current window.  \n51.        driver.quit()#关闭chrome浏览器  \n52.        #time.sleep()  \n53.  \n54.    driver.close() # Close the current window.  \n55.    driver.quit()#关闭chrome浏览器  \n56.  \n57.  \n58.    #http://bbs.baobeihuijia.com/forum-191-1.html变成http://bbs.baobeihuijia.com，以便组成页面链接  \n59.    siteindex=siteUrl.rfind(\"/\")  \n60.    tempsiteurl=siteUrl[0:siteindex+1]#http://bbs.baobeihuijia.com/  \n61.    tempbianhaoqian=siteUrl[siteindex+1:-6]#forum-191-  \n62.  \n63.    #爬取想要的信息  \n64.    bianhao=[]#存储页面编号  \n65.    pageUrl=[]#存储页面链接  \n66.  \n67.    templist1=bsObj.find(\"div\",{\"class\":\"pg\"})  \n68.    #if templist1==None:  \n69.        #return  \n70.    for templist2 in templist1.findAll(\"a\",href=re.compile(\"forum-([0-9]+)-([0-9]+).html\")):  \n71.        if templist2==None:  \n72.            continue  \n73.        lianjie=templist2.attrs['href']  \n74.        #print(lianjie)  \n75.        index1=lianjie.rfind(\"-\")#查找-在字符串中的位置  \n76.        index2=lianjie.rfind(\".\")#查找.在字符串中的位置  \n77.        tempbianhao=lianjie[index1+1:index2]  \n78.        bianhao.append(int(tempbianhao))  \n79.    bianhaoMax=max(bianhao)#获取页面的最大编号  \n80.  \n81.    for i in range(1,bianhaoMax+1):  \n82.        temppageUrl=tempsiteurl+tempbianhaoqian+str(i)+\".html\"#组成页面链接  \n83.        print(temppageUrl)  \n84.        pageUrl.append(temppageUrl)  \n85.    return pageUrl#返回页面链接列表  \n\n2.获取每一个分页链接上所发的帖子的链接\n\n每个帖子的链接都位于href下所以写了以下的代码：BeautifulSoup形式：\n[python] view plain copy\n1.#得到当前版块页面所有帖子的链接  \n2.def GetCurrentPageTieziUrl(PageUrl):  \n3.    #设置代理IP访问  \n4.    #代理IP可以上http://http.zhimaruanjian.com/获取  \n5.    proxy_handler=urllib.request.ProxyHandler({'post':'121.22.252.85:8000'})  \n6.    proxy_auth_handler=urllib.request.ProxyBasicAuthHandler()  \n7.    opener = urllib.request.build_opener(urllib.request.HTTPHandler, proxy_handler)  \n8.    urllib.request.install_opener(opener)  \n9.    #获取网页信息  \n10.    req=request.Request(PageUrl,headers=headers1 or headers2 or headers3)  \n11.    html=urlopen(req)  \n12.    bsObj=BeautifulSoup(html.read(),\"html.parser\")  \n13.    html.close()  \n14.    #http://bbs.baobeihuijia.com/forum-191-1.html变成http://bbs.baobeihuijia.com，以便组成帖子链接  \n15.    siteindex=PageUrl.rfind(\"/\")  \n16.    tempsiteurl=PageUrl[0:siteindex+1]#http://bbs.baobeihuijia.com/  \n17.    #print(tempsiteurl)  \n18.    TieziUrl=[]  \n19.    #爬取想要的信息  \n20.    for templist1 in bsObj.findAll(\"tbody\",id=re.compile(\"normalthread_([0-9]+)\")) :  \n21.        for templist2 in templist1.findAll(\"a\",{\"class\":\"s xst\"}):  \n22.            tempteiziUrl=tempsiteurl+templist2.attrs['href']#组成帖子链接  \n23.            print(tempteiziUrl)  \n24.            TieziUrl.append(tempteiziUrl)  \n25.    return TieziUrl#返回帖子链接列表  \n\nSelenium形式：\n\n[python] view plain copy\n1.#得到当前版块页面所有帖子的链接  \n2.def GetCurrentPageTieziUrl(PageUrl):  \n3.    #设置代理IP访问  \n4.    #代理IP可以上http://http.zhimaruanjian.com/获取  \n5.    proxy_handler=urllib.request.ProxyHandler({'post':'110.73.30.157:8123'})  \n6.    proxy_auth_handler=urllib.request.ProxyBasicAuthHandler()  \n7.    opener = urllib.request.build_opener(urllib.request.HTTPHandler, proxy_handler)  \n8.    urllib.request.install_opener(opener)  \n9.  \n10.    try:  \n11.        #掉用第三方包selenium打开浏览器登陆  \n12.        #driver=webdriver.Chrome()#打开chrome  \n13.       driver=webdriver.Chrome()#打开无界面浏览器Chrome  \n14.       #driver=webdriver.PhantomJS()#打开无界面浏览器PhantomJS  \n15.       driver.set_page_load_timeout(10)  \n16.       try:  \n17.           driver.get(PageUrl)#登陆两次  \n18.           driver.get(PageUrl)  \n19.       except TimeoutError:  \n20.           driver.refresh()  \n21.  \n22.       #print(driver.page_source)  \n23.       html=driver.page_source#将浏览器执行后的源代码赋给html  \n24.        #获取网页信息  \n25.    #抓捕网页解析过程中的错误  \n26.       try:  \n27.           #req=request.Request(tieziUrl,headers=headers5)  \n28.           #html=urlopen(req)  \n29.           bsObj=BeautifulSoup(html,\"html.parser\")  \n30.           #html.close()  \n31.       except UnicodeDecodeError as e:  \n32.           print(\"-----UnicodeDecodeError url\",PageUrl)  \n33.       except urllib.error.URLError as e:  \n34.           print(\"-----urlError url:\",PageUrl)  \n35.       except socket.timeout as e:  \n36.           print(\"-----socket timout:\",PageUrl)  \n37.  \n38.       n=0  \n39.       while(bsObj.find('title').get_text() == \"页面重载开启\"):  \n40.           print(\"当前页面不是重加载后的页面，程序会尝试刷新一次到跳转后的页面\\n\")  \n41.           driver.get(PageUrl)  \n42.           html=driver.page_source#将浏览器执行后的源代码赋给html  \n43.           bsObj=BeautifulSoup(html,\"html.parser\")  \n44.           n=n+1  \n45.           if n==10:  \n46.               driver.close() # Close the current window.  \n47.               driver.quit()#关闭chrome浏览器  \n48.               return 1  \n49.  \n50.    except Exception as e:  \n51.        driver.close() # Close the current window.  \n52.        driver.quit()#关闭chrome浏览器  \n53.        time.sleep(1)  \n54.  \n55.    driver.close() # Close the current window.  \n56.    driver.quit()#关闭chrome浏览器  \n57.  \n58.  \n59.    #http://bbs.baobeihuijia.com/forum-191-1.html变成http://bbs.baobeihuijia.com，以便组成帖子链接  \n60.    siteindex=PageUrl.rfind(\"/\")  \n61.    tempsiteurl=PageUrl[0:siteindex+1]#http://bbs.baobeihuijia.com/  \n62.    #print(tempsiteurl)  \n63.    TieziUrl=[]  \n64.    #爬取想要的信息  \n65.    for templist1 in bsObj.findAll(\"tbody\",id=re.compile(\"normalthread_([0-9]+)\")) :  \n66.        if templist1==None:  \n67.            continue  \n68.        for templist2 in templist1.findAll(\"a\",{\"class\":\"s xst\"}):  \n69.            if templist2==None:  \n70.                continue  \n71.            tempteiziUrl=tempsiteurl+templist2.attrs['href']#组成帖子链接  \n72.            print(tempteiziUrl)  \n73.            TieziUrl.append(tempteiziUrl)  \n74.    return TieziUrl#返回帖子链接列表  \n3.获取每一个帖子链接上要爬取的信息，编号，姓名，性别，出生日期，失踪时身高，失踪时间，失踪地点，以及是否报案，并写入CSV中\n\n通过查看每一个帖子的链接，发现其失踪人口信息都在<ul>标签下，所以编写了以下的代码BeautifulSoup形式：\n[python] view plain copy\n1.#得到当前页面失踪人口信息  \n2.#pageUrl为当前帖子页面链接  \n3.def CurrentPageMissingPopulationInformation(tieziUrl):  \n4.    #设置代理IP访问  \n5.    #代理IP可以上http://http.zhimaruanjian.com/获取  \n6.    proxy_handler=urllib.request.ProxyHandler({'post':'210.136.17.78:8080'})  \n7.    proxy_auth_handler=urllib.request.ProxyBasicAuthHandler()  \n8.    opener = urllib.request.build_opener(urllib.request.HTTPHandler, proxy_handler)  \n9.    urllib.request.install_opener(opener)  \n10.    #获取网页信息  \n11.    req=request.Request(tieziUrl,headers=headers1 or headers2 or headers3)  \n12.    html=urlopen(req)  \n13.    bsObj=BeautifulSoup(html.read(),\"html.parser\")  \n14.    html.close()  \n15.    #查找想要的信息  \n16.    templist1=bsObj.find(\"td\",{\"class\":\"t_f\"}).ul  \n17.    if templist1==None:#判断是否不包含ul字段，如果不，跳出函数  \n18.        return  \n19.    mycsv=['NULL','NULL','NULL','NULL','NULL','NULL','NULL','NULL']#初始化提取信息列表  \n20.    for templist2 in templist1.findAll(\"font\",size=re.compile(\"^([0-9]+)*$\")):  \n21.        if len(templist2)==0:  \n22.            continue  \n23.        tempText=templist2.get_text()  \n24.        #print(tempText[0:4])  \n25.        if \"宝贝回家编号\" in tempText[0:6]:  \n26.            print(tempText)  \n27.            index=tempText.find(\"：\")  \n28.            tempText=tempText[index+1:]  \n29.            #mycsv.append(tempText)  \n30.            if len(tempText)==0:  \n31.                tempText=\"NULL\"  \n32.            mycsv[0]=tempText  \n33.        if \"寻亲编号\" in tempText[0:6]:  \n34.            print(tempText)  \n35.            index=tempText.find(\"：\")  \n36.            tempText=tempText[index+1:]  \n37.            if len(tempText)==0:  \n38.                tempText=\"NULL\"  \n39.            #mycsv.append(tempText)  \n40.            mycsv[0]=tempText  \n41.        if \"登记编号\" in tempText[0:6]:  \n42.            print(tempText)  \n43.            index=tempText.find(\"：\")  \n44.            tempText=tempText[index+1:]  \n45.            if len(tempText)==0:  \n46.                tempText=\"NULL\"  \n47.            #mycsv.append(tempText)  \n48.            mycsv[0]=tempText  \n49.        if \"姓\" in tempText[0:6]:  \n50.            print(tempText)  \n51.            index=tempText.find(\"：\")  \n52.            tempText=tempText[index+1:]  \n53.            #mycsv.append(tempText)  \n54.            mycsv[1]=tempText  \n55.        if\"性\" in tempText[0:6]:  \n56.            print(tempText)  \n57.            index=tempText.find(\"：\")  \n58.            tempText=tempText[index+1:]  \n59.            #mycsv.append(tempText)  \n60.            mycsv[2]=tempText  \n61.        if \"出生日期\" in tempText[0:6]:  \n62.            print(tempText)  \n63.            index=tempText.find(\"：\")  \n64.            tempText=tempText[index+1:]  \n65.            #mycsv.append(tempText)  \n66.            mycsv[3]=tempText  \n67.        if \"失踪时身高\" in tempText[0:6]:  \n68.            print(tempText)  \n69.            index=tempText.find(\"：\")  \n70.            tempText=tempText[index+1:]  \n71.            #mycsv.append(tempText)  \n72.            mycsv[4]=tempText  \n73.        if \"失踪时间\" in tempText[0:6]:  \n74.            print(tempText)  \n75.            index=tempText.find(\"：\")  \n76.            tempText=tempText[index+1:]  \n77.            #mycsv.append(tempText)  \n78.            mycsv[5]=tempText  \n79.        if \"失踪日期\" in tempText[0:6]:  \n80.            print(tempText)  \n81.            index=tempText.find(\"：\")  \n82.            tempText=tempText[index+1:]  \n83.            #mycsv.append(tempText)  \n84.            mycsv[5]=tempText  \n85.        if \"失踪地点\" in tempText[0:6]:  \n86.            print(tempText)  \n87.            index=tempText.find(\"：\")  \n88.            tempText=tempText[index+1:]  \n89.            #mycsv.append(tempText)  \n90.            mycsv[6]=tempText  \n91.        if \"是否报案\" in tempText[0:6]:  \n92.            print(tempText)  \n93.            index=tempText.find(\"：\")  \n94.            tempText=tempText[index+1:]  \n95.            #mycsv.append(tempText)  \n96.            mycsv[7]=tempText  \n97.    try:  \n98.        writer.writerow((str(mycsv[0]),str(mycsv[1]),str(mycsv[2]),str(mycsv[3]),str(mycsv[4]),str(mycsv[5]),str(mycsv[6]),str(mycsv[7])))#写入CSV文件  \n99.    finally:  \n100.        time.sleep(1)#设置爬完之后的睡眠时间，这里先设置为1秒 \n \nSelenium形式：\n[python] view plain copy\n1.#得到当前页面失踪人口信息  \n2.#pageUrl为当前帖子页面链接  \n3.def CurrentPageMissingPopulationInformation(tieziUrl):  \n4.    #设置代理IP访问  \n5.    #代理IP可以上http://http.zhimaruanjian.com/获取  \n6.    proxy_handler=urllib.request.ProxyHandler({'post':'128.199.169.17:80'})  \n7.    proxy_auth_handler=urllib.request.ProxyBasicAuthHandler()  \n8.    opener = urllib.request.build_opener(urllib.request.HTTPHandler, proxy_handler)  \n9.    urllib.request.install_opener(opener)  \n10.  \n11.    try:  \n12.        #掉用第三方包selenium打开浏览器登陆  \n13.        #driver=webdriver.Chrome()#打开chrome  \n14.       driver=webdriver.Chrome()#打开无界面浏览器Chrome  \n15.       #driver=webdriver.PhantomJS()#打开无界面浏览器PhantomJS  \n16.       driver.set_page_load_timeout(10)  \n17.       #driver.implicitly_wait(30)  \n18.       try:  \n19.           driver.get(tieziUrl)#登陆两次  \n20.           driver.get(tieziUrl)  \n21.       except TimeoutError:  \n22.           driver.refresh()  \n23.  \n24.       #print(driver.page_source)  \n25.       html=driver.page_source#将浏览器执行后的源代码赋给html  \n26.        #获取网页信息  \n27.    #抓捕网页解析过程中的错误  \n28.       try:  \n29.           #req=request.Request(tieziUrl,headers=headers5)  \n30.           #html=urlopen(req)  \n31.           bsObj=BeautifulSoup(html,\"html.parser\")  \n32.           #html.close()  \n33.       except UnicodeDecodeError as e:  \n34.           print(\"-----UnicodeDecodeError url\",tieziUrl)  \n35.       except urllib.error.URLError as e:  \n36.           print(\"-----urlError url:\",tieziUrl)  \n37.       except socket.timeout as e:  \n38.           print(\"-----socket timout:\",tieziUrl)  \n39.  \n40.  \n41.       while(bsObj.find('title').get_text() == \"页面重载开启\"):  \n42.           print(\"当前页面不是重加载后的页面，程序会尝试刷新一次到跳转后的页面\\n\")  \n43.           driver.get(tieziUrl)  \n44.           html=driver.page_source#将浏览器执行后的源代码赋给html  \n45.           bsObj=BeautifulSoup(html,\"html.parser\")  \n46.    except Exception as e:  \n47.        driver.close() # Close the current window.  \n48.        driver.quit()#关闭chrome浏览器  \n49.        time.sleep(0.5)  \n50.  \n51.    driver.close() # Close the current window.  \n52.    driver.quit()#关闭chrome浏览器  \n53.  \n54.  \n55.    #查找想要的信息  \n56.    templist1=bsObj.find(\"td\",{\"class\":\"t_f\"}).ul  \n57.    if templist1==None:#判断是否不包含ul字段，如果不，跳出函数  \n58.        print(\"当前帖子页面不包含ul字段\")  \n59.        return 1  \n60.    mycsv=['NULL','NULL','NULL','NULL','NULL','NULL','NULL','NULL']#初始化提取信息列表  \n61.    for templist2 in templist1.findAll(\"font\",size=re.compile(\"^([0-9]+)*$\")):  \n62.        tempText=templist2.get_text()  \n63.        #print(tempText[0:4])  \n64.        if \"宝贝回家编号\" in tempText[0:6]:  \n65.            print(tempText)  \n66.            index=tempText.find(\"：\")  \n67.            tempText=tempText[index+1:]  \n68.            #mycsv.append(tempText)  \n69.            if len(tempText)==0:  \n70.                tempText=\"NULL\"  \n71.            mycsv[0]=tempText  \n72.        if \"寻亲编号\" in tempText[0:6]:  \n73.            print(tempText)  \n74.            index=tempText.find(\"：\")  \n75.            tempText=tempText[index+1:]  \n76.            if len(tempText)==0:  \n77.                tempText=\"NULL\"  \n78.            #mycsv.append(tempText)  \n79.            mycsv[0]=tempText  \n80.        if \"登记编号\" in tempText[0:6]:  \n81.            print(tempText)  \n82.            index=tempText.find(\"：\")  \n83.            tempText=tempText[index+1:]  \n84.            if len(tempText)==0:  \n85.                tempText=\"NULL\"  \n86.            #mycsv.append(tempText)  \n87.            mycsv[0]=tempText  \n88.        if \"姓\" in tempText[0:6]:  \n89.            print(tempText)  \n90.            index=tempText.find(\"：\")  \n91.            tempText=tempText[index+1:]  \n92.            #mycsv.append(tempText)  \n93.            mycsv[1]=tempText  \n94.        if\"性\" in tempText[0:6]:  \n95.            print(tempText)  \n96.            index=tempText.find(\"：\")  \n97.            tempText=tempText[index+1:]  \n98.            #mycsv.append(tempText)  \n99.            mycsv[2]=tempText  \n100.        if \"出生日期\" in tempText[0:6]:  \n101.            print(tempText)  \n102.            index=tempText.find(\"：\")  \n103.            tempText=tempText[index+1:]  \n104.            #mycsv.append(tempText)  \n105.            mycsv[3]=tempText  \n106.        if \"失踪时身高\" in tempText[0:6]:  \n107.            print(tempText)  \n108.            index=tempText.find(\"：\")  \n109.            tempText=tempText[index+1:]  \n110.            #mycsv.append(tempText)  \n111.            mycsv[4]=tempText  \n112.        if \"失踪时间\" in tempText[0:6]:  \n113.            print(tempText)  \n114.            index=tempText.find(\"：\")  \n115.            tempText=tempText[index+1:]  \n116.            #mycsv.append(tempText)  \n117.            mycsv[5]=tempText  \n118.        if \"失踪日期\" in tempText[0:6]:  \n119.            print(tempText)  \n120.            index=tempText.find(\"：\")  \n121.            tempText=tempText[index+1:]  \n122.            #mycsv.append(tempText)  \n123.            mycsv[5]=tempText  \n124.        if \"失踪地点\" in tempText[0:6]:  \n125.            print(tempText)  \n126.            index=tempText.find(\"：\")  \n127.            tempText=tempText[index+1:]  \n128.            #mycsv.append(tempText)  \n129.            mycsv[6]=tempText  \n130.        if \"是否报案\" in tempText[0:6]:  \n131.            print(tempText)  \n132.            index=tempText.find(\"：\")  \n133.            tempText=tempText[index+1:]  \n134.            #mycsv.append(tempText)  \n135.            mycsv[7]=tempText  \n136.    try:  \n137.        writer.writerow((str(mycsv[0]),str(mycsv[1]),str(mycsv[2]),str(mycsv[3]),str(mycsv[4]),str(mycsv[5]),str(mycsv[6]),str(mycsv[7])))#写入CSV文件  \n138.        csvfile.flush()#马上将这条数据写入csv文件中  \n139.    finally:  \n140.        print(\"当前帖子信息写入完成\\n\")  \n141.        time.sleep(5)#设置爬完之后的睡眠时间，这里先设置为1秒  \n\n现附上所有代码，此代码仅供参考，不能用于商业用途，网络爬虫易给网站服务器造成巨大负荷，任何人使用本代码所引起的任何后果，本人不予承担法律责任。贴出代码的初衷是供大家学习爬虫，大家只是研究下网络框架即可，不要使用此代码去加重网站负荷，本人由于不当使用，已被封IP，前车之鉴，爬取失踪人口信息只是为了从空间上分析人口失踪的规律，由此给网站造成的什么不便，请见谅。\n附上所有代码：\n[python] view plain copy\n1.#__author__ = 'Administrator'  \n2.#coding=utf-8  \n3.import io  \n4.import os  \n5.import sys  \n6.import math  \n7.import urllib  \n8.from urllib.request import  urlopen  \n9.from urllib.request import urlretrieve  \n10.from urllib  import request  \n11.from bs4 import BeautifulSoup  \n12.import re  \n13.import time  \n14.import socket  \n15.import csv  \n16.from selenium import webdriver  \n17.  \n18.socket.setdefaulttimeout(5000)#设置全局超时函数  \n19.  \n20.  \n21.  \n22.sys.stdout = io.TextIOWrapper(sys.stdout.buffer,encoding='gb18030')  \n23.#sys.stdout = io.TextIOWrapper(sys.stdout.buffer,encoding='utf-8')  \n24.#设置不同的headers,伪装为不同的浏览器  \n25.headers1={'User-Agent':'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:23.0) Gecko/20100101 Firefox/23.0'}  \n26.headers2={'User-Agent':'Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36'}  \n27.headers3={'User-Agent':'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.64 Safari/537.11'}  \n28.headers4={'User-Agent':'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.104 Safari/537.36 Core/1.53.2372.400 QQBrowser/9.5.10548.400'}  \n29.headers5={'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',  \n30.'Connection':'keep-alive',  \n31.'Host':'bbs.baobeihuijia.com',  \n32.'Referer':'http://bbs.baobeihuijia.com/forum-191-1.html',  \n33.'Upgrade-Insecure-Requests':'1',  \n34.'User-Agent':'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36'}  \n35.  \n36.headers6={'Host': 'bbs.baobeihuijia.com',  \n37.'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64; rv:51.0) Gecko/20100101 Firefox/51.0',  \n38.'Accept': 'textml,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',  \n39.'Connection': 'keep-alive',  \n40.'Upgrade-Insecure-Requests':' 1'  \n41.}  \n42.#得到当前页面失踪人口信息  \n43.#pageUrl为当前帖子页面链接  \n44.def CurrentPageMissingPopulationInformation(tieziUrl):  \n45.    #设置代理IP访问  \n46.    #代理IP可以上http://http.zhimaruanjian.com/获取  \n47.    proxy_handler=urllib.request.ProxyHandler({'post':'128.199.169.17:80'})  \n48.    proxy_auth_handler=urllib.request.ProxyBasicAuthHandler()  \n49.    opener = urllib.request.build_opener(urllib.request.HTTPHandler, proxy_handler)  \n50.    urllib.request.install_opener(opener)  \n51.  \n52.    try:  \n53.        #掉用第三方包selenium打开浏览器登陆  \n54.        #driver=webdriver.Chrome()#打开chrome  \n55.       driver=webdriver.Chrome()#打开无界面浏览器Chrome  \n56.       #driver=webdriver.PhantomJS()#打开无界面浏览器PhantomJS  \n57.       driver.set_page_load_timeout(10)  \n58.       #driver.implicitly_wait(30)  \n59.       try:  \n60.           driver.get(tieziUrl)#登陆两次  \n61.           driver.get(tieziUrl)  \n62.       except TimeoutError:  \n63.           driver.refresh()  \n64.  \n65.       #print(driver.page_source)  \n66.       html=driver.page_source#将浏览器执行后的源代码赋给html  \n67.        #获取网页信息  \n68.    #抓捕网页解析过程中的错误  \n69.       try:  \n70.           #req=request.Request(tieziUrl,headers=headers5)  \n71.           #html=urlopen(req)  \n72.           bsObj=BeautifulSoup(html,\"html.parser\")  \n73.           #html.close()  \n74.       except UnicodeDecodeError as e:  \n75.           print(\"-----UnicodeDecodeError url\",tieziUrl)  \n76.       except urllib.error.URLError as e:  \n77.           print(\"-----urlError url:\",tieziUrl)  \n78.       except socket.timeout as e:  \n79.           print(\"-----socket timout:\",tieziUrl)  \n80.  \n81.  \n82.       while(bsObj.find('title').get_text() == \"页面重载开启\"):  \n83.           print(\"当前页面不是重加载后的页面，程序会尝试刷新一次到跳转后的页面\\n\")  \n84.           driver.get(tieziUrl)  \n85.           html=driver.page_source#将浏览器执行后的源代码赋给html  \n86.           bsObj=BeautifulSoup(html,\"html.parser\")  \n87.    except Exception as e:  \n88.        driver.close() # Close the current window.  \n89.        driver.quit()#关闭chrome浏览器  \n90.        time.sleep(0.5)  \n91.  \n92.    driver.close() # Close the current window.  \n93.    driver.quit()#关闭chrome浏览器  \n94.  \n95.  \n96.    #查找想要的信息  \n97.    templist1=bsObj.find(\"td\",{\"class\":\"t_f\"}).ul  \n98.    if templist1==None:#判断是否不包含ul字段，如果不，跳出函数  \n99.        print(\"当前帖子页面不包含ul字段\")  \n100.        return 1  \n101.    mycsv=['NULL','NULL','NULL','NULL','NULL','NULL','NULL','NULL']#初始化提取信息列表  \n102.    for templist2 in templist1.findAll(\"font\",size=re.compile(\"^([0-9]+)*$\")):  \n103.        tempText=templist2.get_text()  \n104.        #print(tempText[0:4])  \n105.        if \"宝贝回家编号\" in tempText[0:6]:  \n106.            print(tempText)  \n107.            index=tempText.find(\"：\")  \n108.            tempText=tempText[index+1:]  \n109.            #mycsv.append(tempText)  \n110.            if len(tempText)==0:  \n111.                tempText=\"NULL\"  \n112.            mycsv[0]=tempText  \n113.        if \"寻亲编号\" in tempText[0:6]:  \n114.            print(tempText)  \n115.            index=tempText.find(\"：\")  \n116.            tempText=tempText[index+1:]  \n117.            if len(tempText)==0:  \n118.                tempText=\"NULL\"  \n119.            #mycsv.append(tempText)  \n120.            mycsv[0]=tempText  \n121.        if \"登记编号\" in tempText[0:6]:  \n122.            print(tempText)  \n123.            index=tempText.find(\"：\")  \n124.            tempText=tempText[index+1:]  \n125.            if len(tempText)==0:  \n126.                tempText=\"NULL\"  \n127.            #mycsv.append(tempText)  \n128.            mycsv[0]=tempText  \n129.        if \"姓\" in tempText[0:6]:  \n130.            print(tempText)  \n131.            index=tempText.find(\"：\")  \n132.            tempText=tempText[index+1:]  \n133.            #mycsv.append(tempText)  \n134.            mycsv[1]=tempText  \n135.        if\"性\" in tempText[0:6]:  \n136.            print(tempText)  \n137.            index=tempText.find(\"：\")  \n138.            tempText=tempText[index+1:]  \n139.            #mycsv.append(tempText)  \n140.            mycsv[2]=tempText  \n141.        if \"出生日期\" in tempText[0:6]:  \n142.            print(tempText)  \n143.            index=tempText.find(\"：\")  \n144.            tempText=tempText[index+1:]  \n145.            #mycsv.append(tempText)  \n146.            mycsv[3]=tempText  \n147.        if \"失踪时身高\" in tempText[0:6]:  \n148.            print(tempText)  \n149.            index=tempText.find(\"：\")  \n150.            tempText=tempText[index+1:]  \n151.            #mycsv.append(tempText)  \n152.            mycsv[4]=tempText  \n153.        if \"失踪时间\" in tempText[0:6]:  \n154.            print(tempText)  \n155.            index=tempText.find(\"：\")  \n156.            tempText=tempText[index+1:]  \n157.            #mycsv.append(tempText)  \n158.            mycsv[5]=tempText  \n159.        if \"失踪日期\" in tempText[0:6]:  \n160.            print(tempText)  \n161.            index=tempText.find(\"：\")  \n162.            tempText=tempText[index+1:]  \n163.            #mycsv.append(tempText)  \n164.            mycsv[5]=tempText  \n165.        if \"失踪地点\" in tempText[0:6]:  \n166.            print(tempText)  \n167.            index=tempText.find(\"：\")  \n168.            tempText=tempText[index+1:]  \n169.            #mycsv.append(tempText)  \n170.            mycsv[6]=tempText  \n171.        if \"是否报案\" in tempText[0:6]:  \n172.            print(tempText)  \n173.            index=tempText.find(\"：\")  \n174.            tempText=tempText[index+1:]  \n175.            #mycsv.append(tempText)  \n176.            mycsv[7]=tempText  \n177.    try:  \n178.        writer.writerow((str(mycsv[0]),str(mycsv[1]),str(mycsv[2]),str(mycsv[3]),str(mycsv[4]),str(mycsv[5]),str(mycsv[6]),str(mycsv[7])))#写入CSV文件  \n179.        csvfile.flush()#马上将这条数据写入csv文件中  \n180.    finally:  \n181.        print(\"当前帖子信息写入完成\\n\")  \n182.        time.sleep(5)#设置爬完之后的睡眠时间，这里先设置为1秒  \n183.  \n184.  \n185.#得到当前板块所有的页面链接  \n186.#siteUrl为当前版块的页面链接  \n187.def GetALLPageUrl(siteUrl):  \n188.    #设置代理IP访问  \n189.    #代理IP可以上http://http.zhimaruanjian.com/获取  \n190.    proxy_handler=urllib.request.ProxyHandler({'post':'123.207.143.51:8080'})  \n191.    proxy_auth_handler=urllib.request.ProxyBasicAuthHandler()  \n192.    opener = urllib.request.build_opener(urllib.request.HTTPHandler, proxy_handler)  \n193.    urllib.request.install_opener(opener)  \n194.  \n195.    try:  \n196.        #掉用第三方包selenium打开浏览器登陆  \n197.        #driver=webdriver.Chrome()#打开chrome  \n198.       driver=webdriver.Chrome()#打开无界面浏览器Chrome  \n199.       #driver=webdriver.PhantomJS()#打开无界面浏览器PhantomJS  \n200.       driver.set_page_load_timeout(10)  \n201.       #driver.implicitly_wait(30)  \n202.       try:  \n203.           driver.get(siteUrl)#登陆两次  \n204.           driver.get(siteUrl)  \n205.       except TimeoutError:  \n206.           driver.refresh()  \n207.  \n208.       #print(driver.page_source)  \n209.       html=driver.page_source#将浏览器执行后的源代码赋给html  \n210.        #获取网页信息  \n211.    #抓捕网页解析过程中的错误  \n212.       try:  \n213.           #req=request.Request(tieziUrl,headers=headers5)  \n214.           #html=urlopen(req)  \n215.           bsObj=BeautifulSoup(html,\"html.parser\")  \n216.           #print(bsObj.find('title').get_text())  \n217.           #html.close()  \n218.       except UnicodeDecodeError as e:  \n219.           print(\"-----UnicodeDecodeError url\",siteUrl)  \n220.       except urllib.error.URLError as e:  \n221.           print(\"-----urlError url:\",siteUrl)  \n222.       except socket.timeout as e:  \n223.           print(\"-----socket timout:\",siteUrl)  \n224.  \n225.  \n226.  \n227.       while(bsObj.find('title').get_text() == \"页面重载开启\"):  \n228.           print(\"当前页面不是重加载后的页面，程序会尝试刷新一次到跳转后的页面\\n\")  \n229.           driver.get(siteUrl)  \n230.           html=driver.page_source#将浏览器执行后的源代码赋给html  \n231.           bsObj=BeautifulSoup(html,\"html.parser\")  \n232.    except Exception as e:  \n233.  \n234.        driver.close() # Close the current window.  \n235.        driver.quit()#关闭chrome浏览器  \n236.        #time.sleep()  \n237.  \n238.    driver.close() # Close the current window.  \n239.    driver.quit()#关闭chrome浏览器  \n240.  \n241.  \n242.    #http://bbs.baobeihuijia.com/forum-191-1.html变成http://bbs.baobeihuijia.com，以便组成页面链接  \n243.    siteindex=siteUrl.rfind(\"/\")  \n244.    tempsiteurl=siteUrl[0:siteindex+1]#http://bbs.baobeihuijia.com/  \n245.    tempbianhaoqian=siteUrl[siteindex+1:-6]#forum-191-  \n246.  \n247.    #爬取想要的信息  \n248.    bianhao=[]#存储页面编号  \n249.    pageUrl=[]#存储页面链接  \n250.  \n251.    templist1=bsObj.find(\"div\",{\"class\":\"pg\"})  \n252.    #if templist1==None:  \n253.        #return  \n254.    for templist2 in templist1.findAll(\"a\",href=re.compile(\"forum-([0-9]+)-([0-9]+).html\")):  \n255.        if templist2==None:  \n256.            continue  \n257.        lianjie=templist2.attrs['href']  \n258.        #print(lianjie)  \n259.        index1=lianjie.rfind(\"-\")#查找-在字符串中的位置  \n260.        index2=lianjie.rfind(\".\")#查找.在字符串中的位置  \n261.        tempbianhao=lianjie[index1+1:index2]  \n262.        bianhao.append(int(tempbianhao))  \n263.    bianhaoMax=max(bianhao)#获取页面的最大编号  \n264.  \n265.    for i in range(1,bianhaoMax+1):  \n266.        temppageUrl=tempsiteurl+tempbianhaoqian+str(i)+\".html\"#组成页面链接  \n267.        print(temppageUrl)  \n268.        pageUrl.append(temppageUrl)  \n269.    return pageUrl#返回页面链接列表  \n270.  \n271.#得到当前版块页面所有帖子的链接  \n272.def GetCurrentPageTieziUrl(PageUrl):  \n273.    #设置代理IP访问  \n274.    #代理IP可以上http://http.zhimaruanjian.com/获取  \n275.    proxy_handler=urllib.request.ProxyHandler({'post':'110.73.30.157:8123'})  \n276.    proxy_auth_handler=urllib.request.ProxyBasicAuthHandler()  \n277.    opener = urllib.request.build_opener(urllib.request.HTTPHandler, proxy_handler)  \n278.    urllib.request.install_opener(opener)  \n279.  \n280.    try:  \n281.        #掉用第三方包selenium打开浏览器登陆  \n282.        #driver=webdriver.Chrome()#打开chrome  \n283.       driver=webdriver.Chrome()#打开无界面浏览器Chrome  \n284.       #driver=webdriver.PhantomJS()#打开无界面浏览器PhantomJS  \n285.       driver.set_page_load_timeout(10)  \n286.       try:  \n287.           driver.get(PageUrl)#登陆两次  \n288.           driver.get(PageUrl)  \n289.       except TimeoutError:  \n290.           driver.refresh()  \n291.  \n292.       #print(driver.page_source)  \n293.       html=driver.page_source#将浏览器执行后的源代码赋给html  \n294.        #获取网页信息  \n295.    #抓捕网页解析过程中的错误  \n296.       try:  \n297.           #req=request.Request(tieziUrl,headers=headers5)  \n298.           #html=urlopen(req)  \n299.           bsObj=BeautifulSoup(html,\"html.parser\")  \n300.           #html.close()  \n301.       except UnicodeDecodeError as e:  \n302.           print(\"-----UnicodeDecodeError url\",PageUrl)  \n303.       except urllib.error.URLError as e:  \n304.           print(\"-----urlError url:\",PageUrl)  \n305.       except socket.timeout as e:  \n306.           print(\"-----socket timout:\",PageUrl)  \n307.  \n308.       n=0  \n309.       while(bsObj.find('title').get_text() == \"页面重载开启\"):  \n310.           print(\"当前页面不是重加载后的页面，程序会尝试刷新一次到跳转后的页面\\n\")  \n311.           driver.get(PageUrl)  \n312.           html=driver.page_source#将浏览器执行后的源代码赋给html  \n313.           bsObj=BeautifulSoup(html,\"html.parser\")  \n314.           n=n+1  \n315.           if n==10:  \n316.               driver.close() # Close the current window.  \n317.               driver.quit()#关闭chrome浏览器  \n318.               return 1  \n319.  \n320.    except Exception as e:  \n321.        driver.close() # Close the current window.  \n322.        driver.quit()#关闭chrome浏览器  \n323.        time.sleep(1)  \n324.  \n325.    driver.close() # Close the current window.  \n326.    driver.quit()#关闭chrome浏览器  \n327.  \n328.  \n329.    #http://bbs.baobeihuijia.com/forum-191-1.html变成http://bbs.baobeihuijia.com，以便组成帖子链接  \n330.    siteindex=PageUrl.rfind(\"/\")  \n331.    tempsiteurl=PageUrl[0:siteindex+1]#http://bbs.baobeihuijia.com/  \n332.    #print(tempsiteurl)  \n333.    TieziUrl=[]  \n334.    #爬取想要的信息  \n335.    for templist1 in bsObj.findAll(\"tbody\",id=re.compile(\"normalthread_([0-9]+)\")) :  \n336.        if templist1==None:  \n337.            continue  \n338.        for templist2 in templist1.findAll(\"a\",{\"class\":\"s xst\"}):  \n339.            if templist2==None:  \n340.                continue  \n341.            tempteiziUrl=tempsiteurl+templist2.attrs['href']#组成帖子链接  \n342.            print(tempteiziUrl)  \n343.            TieziUrl.append(tempteiziUrl)  \n344.    return TieziUrl#返回帖子链接列表  \n345.  \n346.  \n347.  \n348.#CurrentPageMissingPopulationInformation(\"http://bbs.baobeihuijia.com/thread-213126-1-1.html\")  \n349.#GetALLPageUrl(\"http://bbs.baobeihuijia.com/forum-191-1.html\")  \n350.#GetCurrentPageTieziUrl(\"http://bbs.baobeihuijia.com/forum-191-1.html\")  \n351.  \n352.if __name__ == '__main__':  \n353.    csvfile=open(\"E:/MissingPeople.csv\",\"w+\",newline=\"\",encoding='gb18030')  \n354.    writer=csv.writer(csvfile)  \n355.    writer.writerow(('宝贝回家编号','姓名','性别','出生日期','失踪时身高','失踪时间','失踪地点','是否报案'))  \n356.    pageurl=GetALLPageUrl(\"https://bbs.baobeihuijia.com/forum-191-1.html\")#寻找失踪宝贝  \n357.    #pageurl=GetALLPageUrl(\"http://bbs.baobeihuijia.com/forum-189-1.html\")#被拐宝贝回家  \n358.    time.sleep(5)  \n359.    print(\"所有页面链接获取成功！\\n\")  \n360.    n=0  \n361.    for templist1 in pageurl:  \n362.        #print(templist1)  \n363.        tieziurl=GetCurrentPageTieziUrl(templist1)  \n364.        time.sleep(5)  \n365.        print(\"当前页面\"+str(templist1)+\"所有帖子链接获取成功！\\n\")  \n366.        if tieziurl ==1:  \n367.            print(\"不能得到当前帖子页面！\\n\")  \n368.            continue  \n369.        else:  \n370.            for templist2 in tieziurl:  \n371.            #print(templist2)  \n372.               n=n+1  \n373.               print(\"\\n正在收集第\"+str(n)+\"条信息！\")  \n374.               time.sleep(5)  \n375.               tempzhi=CurrentPageMissingPopulationInformation(templist2)  \n376.               if tempzhi==1:  \n377.                  print(\"\\n第\"+str(n)+\"条信息为空！\")  \n378.                  continue  \n379.    print('')  \n380.    print(\"信息爬取完成！请放心的关闭程序！\")  \n381.    csvfile.close()  \n\n写成的CSV文件截图：\n\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "4"}