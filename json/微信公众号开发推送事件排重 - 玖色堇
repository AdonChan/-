{"title": "微信公众号开发推送事件排重 - 玖色堇 ", "index": "微信公众平台,python", "content": "问题描述\n在处理用户领卡的推送的时候，我们的数据库对同一个新的用户，会出现两条数据，比如两条用户，两条用户领卡数据\n问题分析\n出现这种的原因在于以下两点：\n\n服务器有点卡，没有来得及在5秒之内回复微信服务器，导致微信服务器重发请求\n虽然在插入数据之前有所检查有无重复数据，但是可能服务器很卡，在检查的时候，前一条请求的数据还没有插入数据库\n\n处理方法\n参考微信开发文档，利用FromUserName + CreateTime排重，将其作为一个key，存放在memcached里面，然后每次有推送或者消息来得时候，先去判断一下是否存在，如果存在，表示是重复推送，直接return空串，否则表示是第一次推送，将其作为一个key，简要代码如下：\nmc = memcached_wrapper.getMemcached()\nFromUserName = self.decrypt_msg.find(\"FromUserName\").text\nCreateTime = self.decrypt_msg.find(\"CreateTime\").text\nmc_key_str = Util.unicode2str(FromUserName + CreateTime)\nmc_value_str = mc.get(mc_key_str)\nif mc_value_str:\n    mc.disconnect_all()\n    return \"\"\nelse:\n    mc.set(mc_key_str, 1, 60)\n    mc.disconnect_all()\n# 备注\n# unicode2str将unicode字符串转化为bytes串\n# memcached_wrapper一个处理memcached的py文件，主要作用是连接memcached和复用连接等功能\n好了，就先到这里了，记录下来以便下次查阅，如果对于你也有帮助的话，那真是最好不过的了\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "0"}