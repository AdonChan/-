{"title": "使用github+travis将Python包部署到Pypi - 古寺比的寺 ", "index": "ci,pypi,github,python", "content": "我在 github 托管 Python 代码，然后将包发布到 Pypi，通常的操作步骤是，更新完代码将提交到 github ，然后手动将包更新到 pypi，这样比较繁琐，就想到了使用github+travis-ci 构建一个自动部署环境。\n注册 pypi\n访问https://pypi.org 点击Register注册账号，记住自己的用户名密码。\n创建 setup.py 文件\nsetup.py 文件放置于包的根目录，示例内容如下：\n#!/usr/bin/env python\nfrom setuptools import setup, find_packages\n\nwith open(\"README.md\", \"r\") as fh:\n    long_description = fh.read()\n\nwith open('requirements.txt') as f:\n    requirements = [l for l in f.read().splitlines() if l]\n\nsetup(name=\"python-weixin\",  # 项目名\n      version=\"0.3.2\",       # 版本号\n      description=\"Python Weixin API client support wechat-app\",  #简介\n      long_description=long_description,  # 长简介 这里使用的 readme 内容\n      long_description_content_type=\"text/markdown\",\n      license=\"BSD\",   # 授权\n      install_requires=requirements, # 依赖\n      author=\"gusibi\",  # 作者\n      author_email=\"xxx@gmail.com\",  # 邮箱\n      url=\"https://github.com/gusibi/python-weixin\",  # 地址\n      download_url=\"https://github.com/gusibi/python-weixin/archive/master.zip\",\n      packages=find_packages(),\n      keywords=[\"python-weixin\", \"weixin\", \"wechat\", \"sdk\", \"weapp\", \"wxapp\"],\n      zip_safe=True)\n以上特别需要注意的是 packages参数，用来申明你的包里面要包含的目录，这里使用setuptools自动决定要包含哪些包。\n配置 travis-ci\ngithub 提供了多种集成方式，这里我们选择 Travis-ci\n\n选择后访问 https://travis-ci.com/profile，如果是第一次使用 travis-ci 可以使用 github 账号登录，然后选择对应的 github 库激活。\n\n然后在 github 代码库的根目录添加 .travis.yml 文件。\nlanguage: python\npython:   # 指定运行环境，这里会分别在 2.7 和 3.5 运行\n  - '2.7'\n  - '3.5' \ninstall:\n  - pip install -r requirements.txt   # 安装依赖\nscript: python test_example.py  # 如果有单元测试这里应该执行单元测试\nscript 是一个必须的命令，通常如果有单元测试的话这里应该执行单元测试\n添加 Pypi 部署配置\n通过在 .travis.yml 中添加 deploy 模块， Travis CI 实现自动部署，\nlanguage: python\npython:\n- '2.7'\n- '3.5'\ninstall:\n- pip install -r requirements.txt\nscript: python test_example.py\ndeploy:\n  provider: pypi\n  user: goodspeed     # pypi 用户名\n  password: password  # pypi 密码\n  on:\n    python: 2.7\n    tags: true\n    branch: master\n在 deploy 部分，我们指定 provider 为 pypi，然后添加 user、password。\n在 on 部分我们声明一些特殊的配置，比如：\n\n\nbrance: master 意思是只有 master 分支才执行打包部署\n\npython: 2.7 意思是只在 python 2.7 版本执行打包部署\n\ntags: true 意思是只有在发布一个新的版本时才执行打包部署\n\n具体配置参考： Conditional-Releases-with-on\n加密密码\n上面的配置使用的是明文密码，这样就把pypi 账号公开了，太不安全。这里推荐使用 travis-encrypt 加密密码。\n安装 travis-encrypt\npip install travis-encrypt\n然后在 .travis.yml 所在目录执行：\ntravis-encrypt --deploy gusibi python-weixin .travis.yml\nPassword: # 在这里输入pypi 密码\n这里 gusibi python-weixin 需要替换成相对应的 github username 和 repository。命令参考：travis-encrypt\n\n执行完之后password 部分旧会被加密后的秘钥代替，最终 .travis.yml 内容如下：\nlanguage: python\npython:\n- '2.7'\n- '3.5'\ninstall:\n- pip install -r requirements.txt\nscript: python test_example.py\ndeploy:\n  provider: pypi\n  user: goodspeed\n  password:\n    secure: cjQdXGKkNpwKmGgEhONtd2YR+PF44gtZgMegv5O3CRsszocaRqxcBdfwi0qz6KupLMWl/WTq+bYtzf42lpytMe7cB/CPA2sCUDEo6qyIE+Brb5J57GUhd9HIhP5F44BHKWzBnYFbgPsQ2k1ckEDJsUp5yyFvUBkQmv3+LOo9Kf492oCQlgnzaGSRtPQaG56XdLKgCZrxdtfteTalTbjQO7w/GNm5lBn4l7iY1qWiQmzFxkUuZu317yAnohdH84fq9Ozov4S3nPNSTt800HjHkXwaBzxMuJ2SJBadZAW/abCvk34IPyvxjy7upNNLq80/yvgYKzxWBklcP9LxJX2Pwk9NtTY1zUEykkwdBVxZShhBXtWDma/yWQp2RdCVZtLS4GTg4X61PMgH0iwzwzGW8LARj2ZMowQoPipUYCJ7qUfyXrxU05ypizWKIIfrqdRh8Twj9Jhyg/fAoRygCoXNtMqwSmomjkwl6f1i+6lAQENdmVKQTesP56r/olXKb4rhrOgyhj7anJd3F/SZ+g8jQFHHGLcaSkEoVXL6BFPDMxYdMRmx5HKonP9uQO74ZdeevkHK0wFzSbjqpKdVzeuYuyPiHnDyooyjGL+2BzE/Zzo5KCNEflAE22kAuAbjXCuJji7+j47QohrlYjmj2+F7NDBE5sJRp3yLJWIEPqLND/k=\n  on:\n    python: 2.7\n    tags: true\n    branch: master\n将代码提交之后，访问 travis-ci.org 会看到已经触发了 ci ，正在构建：\n\n这里有两个 job 正在同时构建，分别是 python2.7 环境和 python3.5 环境。\n但是这时并没有把包部署到 pypi，还需要在 github releases 页面重新发布一个版本来触发部署。\n参考链接\n\nhttps://github.com/romgar/5mi...\nhttps://pypi.org\nhttps://github.com/gusibi/python-weixinn\nhttps://pypi.org/project/travis-encrypt/\nhttps://docs.travis-ci.com/user/deployment#Conditional-Releases-with-on\n\n\n最后，感谢女朋友支持和包容，比❤️\n也可以在公号输入以下关键字获取历史文章：公号&小程序 | 设计模式 | 并发&协程 | note\n\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "0"}