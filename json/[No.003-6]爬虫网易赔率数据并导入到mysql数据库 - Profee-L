{"title": "[No.003-6]爬虫网易赔率数据并导入到mysql数据库 - Profee-L ", "index": "python", "content": "#encoding:utf-8\n#!/usr/local/bin/python2.7\nimport urllib2\nfrom bs4 import BeautifulSoup\nimport MySQLdb as mdb\nimport sys\nimport re\nimport os\n\n#URL:HTML文件的全路径\n#返回：BeautifulSoup对象\ndef getSoup(url):\n    return BeautifulSoup(open(url))\n\n#获取所有即将读取的HTML的全路径\ndef fileNames():\n    temp_f = open(\"/root/bet/names.txt\")\n    temp = []\n    for line in temp_f:\n        temp.append(\"/root/bet/urls/\"+line.strip())\n    temp_f.close()\n    return temp\n\n#获取场次\ndef getScr(soup):\n    scr = []\n    temp =[]\n    for trs in soup.findAll(\"tr\"):\n        for tds in trs.findAll(\"td\",{\"width\":\"50\"}):\n            temp.append(tds.string)\n    lt = len(temp)/4\n    for i in range(lt):\n        scr.append(temp[4*i+3])\n    return scr\n\n#获取赛事类型\ndef getLea(soup):\n    league = []\n    for item in soup.findAll(\"tr\"):\n        for item1 in item.findAll(\"td\",{\"width\":\"70\"}):\n            league.append(item1.string.encode('utf-8'))\n    return league\n\n#获取比赛日期\ndef getGmdate(soup):\n    temp = []\n    gmdate = []\n    for item in soup.findAll(\"tr\"):\n        for item1 in item.findAll(\"td\",{\"width\":\"61\"}):\n            temp.append(item1)\n    temp =temp[3:]\n    for item in temp:\n        gmdate.append(re.search(\"\\w{4}-\\w{2}-\\w{2}\",str(item)).group())\n    return gmdate\n\n#获取主队客队名称\ndef getTeam(soup):\n    team=[]\n    for item in soup.findAll(\"tr\"):\n        for teams in item.findAll(\"a\",{\"class\":\"dui\"}):\n            team.append(teams.string.strip().encode('utf-8'))\n    return team\n\n#获取胜平负赔率\ndef getSpfpl(soup):\n    spfpl =[]\n    temp = []\n    for trs in soup.findAll(\"tr\"):\n        for tds in trs.findAll(\"span\"):\n            temp.append(tds.string)\n#删除首尾两个无效数据\n    temp =temp[1:-1]\n    for i in range(len(temp)):\n        for item in temp[7*i+4:7*i+7]:\n            spfpl.append(item)\n    return spfpl\n\n#6.比分结果以及比分结果赔率\ndef getResult(soup):\n    bfjg = []\n    temp = []\n    for trs in soup.findAll(\"tr\"):\n        for item in trs.findAll(\"div\",{\"align\":\"center\"}):\n            for item1 in item.findAll(\"strong\"):\n                bfjg.append(item1.string.encode('utf-8'))\n    return bfjg\n\n\n\nif __name__==\"__main__\":\n    reload(sys)\n    sys.setdefaultencoding('utf-8')\n    names = fileNames()\n    conn=mdb.connect(host='localhost',user='root',passwd='oracle',db='betdb',port=3306)\n    cur = conn.cursor()\n    SQL=\"insert into results(id,lea,gmd,hos,gue,win,dog,los,res,odd) values(%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)\"\n    #更新胜平负\n    sql_update3=\"update results set spf=3 where res='1:0' or res='2:0' or res='2:1' or res='3:0' or res='3:1' or res='3:2' or res='4:0' or res='4:1' or res='4:2' or res='5:0' or res='5:1' or res='5:2' or res='胜其他';\"\n    sql_update1=\"update results set spf=1 where res='0:0' or res='1:1' or res='2:2' or res='3:3' or res='平其他';\"\n    sql_update0=\"update results set spf=0 where res='0:1' or res='0:2' or res='1:2' or res='0:3' or res='1:3' or res='2:3' or res='0:4' or res='1:4' or res='2:4' or res='0:5' or res='1:5' or res='2:5' or res='负其他';\"\n    #更新总进球\n    sql_updatezjq0=\"update results set zjq=0 where res='0:0'\"\n    sql_updatezjq1=\"update results set zjq=1 where res='1:0' or res='0:1'\"\n    sql_updatezjq2=\"update results set zjq=2 where res='2:0' or res='1:1' or res='0:2'\"\n    sql_updatezjq3=\"update results set zjq=3 where res='3:0' or res='2:1' or res='1:2' or res='0:3'\"\n    sql_updatezjq4=\"update results set zjq=4 where res='4:0' or res='3:1' or res='2:2' or res='1:3' or res='0:4'\"\n    sql_updatezjq5=\"update results set zjq=5 where res='5:0' or res='4:1' or res='3:2' or res='2:3' or res='0:5' or res='1:4'\"\n    sql_updatezjq6=\"update results set zjq=6 where res='5:1' or res='3:3' or res='4:2' or res='2:4' or res='1:5'\"\n    sql_updatezjq7=\"update results set zjq=7 where res='胜其他' or res='负其他'\"\n    for htmlfilename in names:\n        soup = getSoup(htmlfilename)\n                print \"Reading %s now ...\" % htmlfilename\n        #1.场次\n        scr = getScr(soup)\n        #2.赛事类型\n        lea = getLea(soup)\n        #3.比赛日期\n        gmd = getGmdate(soup)\n        #4.比赛队伍\n        tea = getTeam(soup)\n        #5.胜平负赔率\n        spf = getSpfpl(soup)\n        #6.比赛结果\n        bfj = getResult(soup)\n        #7.形成场次日期唯一id\n        ids=[]\n        for i in range(len(scr)):\n            ids.append(gmd[i]+'-'+scr[i])\n        #装配结果集\n        res =[]\n        for i in range(len(scr)):\n            res.append(ids[i])\n            res.append(lea[i])\n            res.append(gmd[i])\n            res.append(tea[2*i])\n            res.append(tea[2*i+1])\n            res.append(spf[3*i])\n            res.append(spf[3*i+1])\n            res.append(spf[3*i+2])\n            res.append(bfj[2*i])\n            res.append(bfj[2*i+1])\n        l =len(res)/10\n        for i in range(l):\n            for item in res[10*i:10*i+1]:\n                cur.execute(SQL,res[10*i:10*i+10])\n                i+=1\n        cur.execute(sql_update3)\n        cur.execute(sql_update1)\n        cur.execute(sql_update0)    \n        cur.execute(sql_updatezjq0)\n        cur.execute(sql_updatezjq1)\n        cur.execute(sql_updatezjq2)\n        cur.execute(sql_updatezjq3)\n        cur.execute(sql_updatezjq4)\n        cur.execute(sql_updatezjq5)\n        cur.execute(sql_updatezjq6)\n        cur.execute(sql_updatezjq7)\n\n\n#SQL创建语句\nCREATE TABLE `results` (\n  `id` char(20) NOT NULL,\n  `lea` char(100) DEFAULT NULL,\n  `gmd` date DEFAULT NULL,\n  `hos` char(100) DEFAULT NULL,\n  `gue` char(100) DEFAULT NULL,\n  `win` float(5,2) DEFAULT NULL,\n  `dog` float(5,2) DEFAULT NULL,\n  `los` float(5,2) DEFAULT NULL,\n  `res` char(10) DEFAULT NULL,\n  `odd` float(5,2) DEFAULT NULL,\n  `zjq` tinyint(4) DEFAULT NULL,\n  `spf` tinyint(4) DEFAULT NULL\n) ENGINE=MyISAM DEFAULT CHARSET=utf8;\n\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "1"}