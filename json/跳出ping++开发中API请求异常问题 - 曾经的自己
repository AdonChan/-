{"title": "跳出ping++开发中API请求异常问题 - 曾经的自己 ", "index": "javascript,html5,python", "content": "近期在做微信支付那方面的工作,由于要在之前开发人员的基础上进行开发,其中使用到了ping++这个第3方支付的SDK。不得不说,ping++的SDK做的挺简单的,但是其文档真心写的有点坑。不过相对其他的接入,坑少了那么一些。    下面梳理下正常开发的流程,请点击下面的链接付款。  可以看到主要有5个步骤:\n\n设置 API-Key\nSDK 验证签名设置\n发起支付请求获取支付凭据\n将获得的支付凭据传给 Client\n接收 Webhooks通知(开启Live模式才有用)\n\n然后再看下SDK交易流程,可以发现写的还是挺通俗易懂的。  个人觉得比较坑爹的是它API文档的部分,完全就是逗你玩的。为什么这么说,请往下看。  官方说Ping++的API采用REST风格设计,真的是REST风格,完全停留在CURD的阶段,离后面的发展还有很长的路要走。实话说,Github API写的还比较像REST些,而这个ping++的就不想说了。\n入坑\n下面我们正式入坑,其最简单的方式如下,使用curl进行请求:\ncurl https://api.pingxx.com/v1/charges \\\n  -u sk_test_ibbTe5jLGCi5rzfH4OqPW9KC:\n官方采用Authentication Basic的方式进行验证,一般都会过的,返回你要的数据。但是官方提供的例子真心的简单,而且只用uncap这种方式,而我们公司要使用的是微信公众支付,那么坑就出来了。当时我是这样请求的:\nc@y-pc:~$ curl https://api.pingxx.com/v1/charges   -u sk_test_ibbTe5jLGi5rzfH4OqPW9KC:   -d order_no=123456789   -d amount=100   -d app[id]=app_1Gqj58ynP0mHeX1q   -d channel=wx_pub   -d currency=cny   -d client_ip=127.0.0.1   -d subject=\"Your Subject\"   -d body=\"Your Body\"   -d extra='{\"open_id\":\"xxxxx\"}'\n{\n    \"error\": {\n        \"type\": \"invalid_request_error\",\n        \"message\": \" 无效的参数 extra: 必须是一组键值对\",\n        \"param\": \"extra\"\n    }\n注意,这里我们将channel修改为wx_pub了,因此必须添加1个extra字段,在该字段中有1个open_id必填的玩意。结果,总是提示extra必须是1组键值对。很明显,难道extra='{\"open_id\":\"xxxxx\"}不是1个键值对吗,但是机器看不出来它是。\n出坑\n后面,我们准备跳出这个坑,我们去看官方给我们提供的SDK中的例子,可以发现app[id]这里的id是以{\"id\":\"xxxx\"}这样的方式存在的,而不是理解为app[id]这样1个字段,因此我们换个方式进行请求:\ncurl https://api.pingxx.com/v1/charges   -u sk_test_ibbTe5jLGi5rzfH4OqPW9KC:   -d order_no=123456789   -d amount=100   -d app[id]=app_1Gqj58ynP0mHeX1q   -d channel=wx_pub   -d currency=cny   -d client_ip=127.0.0.1   -d subject=\"Your Subject\"   -d body=\"Your Body\"   -d extra[open_id]=xxxxx\n{\n    \"id\": \"ch_C4O4CKXHCK48rnvn5CH8iP4G\",\n    \"object\": \"charge\",\n    \"created\": 1460257030,\n    \"livemode\": false,\n    \"paid\": false,\n    \"refunded\": false,\n    \"app\": \"app_1Gqj58ynP0mHeX1q\",\n    \"channel\": \"wx_pub\",\n    \"order_no\": \"123456789\",\n    \"client_ip\": \"127.0.0.1\",\n    \"amount\": 100,\n    \"amount_settle\": 100,\n    \"currency\": \"cny\",\n    \"subject\": \"Your Subject\",\n    \"body\": \"Your Body\",\n    \"extra\": {\n        \"open_id\": \"xxxxx\"\n    },\n    \"time_paid\": null,\n    \"time_expire\": 1460264230,\n    \"time_settle\": null,\n    \"transaction_no\": null,\n    \"refunds\": {\n        \"object\": \"list\",\n        \"url\": \"/v1/charges/ch_C4O4CKXHCK48rnvn5CH8iP4G/refunds\",\n        \"has_more\": false,\n        \"data\": []\n    },\n    \"amount_refunded\": 0,\n    \"failure_code\": null,\n    \"failure_msg\": null,\n    \"metadata\": {},\n    \"credential\": {\n        \"object\": \"credential\",\n        \"wx_pub\": {\n            \"appId\": \"wxmbrpg8tm1k04yzbt\",\n            \"timeStamp\": 1460257030,\n            \"nonceStr\": \"25c7de13570a1b5f6d23614bdf49443d\",\n            \"package\": \"prepay_id=1101000000160410rtepylz1surl5uzd\",\n            \"signType\": \"MD5\",\n            \"paySign\": \"10F1AACE79C0ED0E10EB4080D140F913\"\n        }\n    },\n    \"description\": null\n这里我们将open_id放在extra中就成功了,这样才可以接收到。不得不说,这API调用完全就是1个坑。主要是官方没有提供明确的请求头信息给我们,导致我们一直在兜圈。     所以,我不排除这文档就是1个实习生写的。不得不说,官方给我们提供了1个不知名的REST的scheme,如果不是过这个坑完全就是不知道它在弄哪样。比如jsonapi提供了这样1种请求方式,预计如果不说明,你也看不懂它写的是什么:\nGET /posts?include=author&sort[posts]=-created,title&sort[people]=name\n下面是上述请求的响应头信息:\nc@y-pc:~$ curl https://api.pingxx.com/v1/charges   -u sk_test_ibbTe5jLGCi5rzfH4OqPW9KC:   -d order_no=123456789   -d amount=100   - app[id]=app_1Gqj58ynP0mHeX1q   -d channel=wx_pub   -d currency=cny   -d client_ip=127.0.0.1   -d subject=\"Your Subject\"   -d body=\"Your Body\"   -d extra[open_id]=xxxxx -v\n*   Trying 121.43.74.100...\n* Connected to api.pingxx.com (121.43.74.100) port 443 (#0)\n* ALPN, offering http/1.1\n* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH\n* successfully set certificate verify locations:\n*   CAfile: /etc/ssl/certs/ca-certificates.crt\n  CApath: none\n* TLSv1.2 (OUT), TLS header, Certificate Status (22):\n* TLSv1.2 (OUT), TLS handshake, Client hello (1):\n* TLSv1.2 (IN), TLS handshake, Server hello (2):\n* NPN, negotiated HTTP1.1\n* TLSv1.2 (IN), TLS handshake, Certificate (11):\n* TLSv1.2 (IN), TLS handshake, Server key exchange (12):\n* TLSv1.2 (IN), TLS handshake, Server finished (14):\n* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):\n* TLSv1.2 (OUT), TLS change cipher, Client hello (1):\n* TLSv1.2 (OUT), TLS handshake, Unknown (67):\n* TLSv1.2 (OUT), TLS handshake, Finished (20):\n* TLSv1.2 (IN), TLS change cipher, Client hello (1):\n* TLSv1.2 (IN), TLS handshake, Finished (20):\n* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256\n* ALPN, server did not agree to a protocol\n* Server certificate:\n*      subject: C=CN; ST=Shanghai; L=Shanghai; O=Shanghai Jianmi Network Technology Co., LTD; OU=IT; CN=api.pingxx.com\n*      start date: Nov 19 00:00:00 2015 GMT\n*      expire date: Jan 17 23:59:59 2017 GMT\n*      subjectAltName: api.pingxx.com matched\n*      issuer: C=US; O=Symantec Corporation; OU=Symantec Trust Network; CN=Symantec Class 3 Secure Server CA - G4\n*      SSL certificate verify ok.\n* Server auth using Basic with user 'sk_test_ibbTe5jLGCi5rzfH4OqPW9KC'\n> POST /v1/charges HTTP/1.1\n> Host: api.pingxx.com\n> Authorization: Basic c2tfdGVzdF9pYmJUZTVqTEdDaTVyemZINE9xUFc5S0M6\n> User-Agent: curl/7.47.1\n> Accept: */*\n> Content-Length: 163\n> Content-Type: application/x-www-form-urlencoded\n> \n* upload completely sent off: 163 out of 163 bytes\n< HTTP/1.1 200 OK\n< Date: Sun, 10 Apr 2016 03:26:51 GMT\n< Content-Type: application/json;charset=utf-8\n< Content-Length: 1229\n< Connection: keep-alive\n< X-Powered-By: PHP/5.6.2\n< Access-Control-Allow-Methods: GET, POST, HEAD, OPTIONS, DELETE\n< Access-Control-Max-Age: 300\n< Access-Control-Allow-Credentials: true\n< Cache-Control: no-cache, no-store\n< Strict-Transport-Security: max-age=31536000; includeSubDomains\n我们使用-v选项查看了其详细的内容,甚至连TCP的3次握手过程都可以看到。  还有就是出错信息,最好看下面的链接报错信息。\n参考文章:\nhttps://www.pingxx.com/document/api/#api-charges\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "3"}