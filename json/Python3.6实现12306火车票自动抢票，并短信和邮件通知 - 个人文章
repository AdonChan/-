{"title": "Python3.6实现12306火车票自动抢票，并短信和邮件通知 - 个人文章 ", "index": "python,splinter,email,httplib2", "content": "最近在学Python，所以用Python写了这个12306抢票脚本，分享出来，与大家共同交流和学习，有不对的地方，请大家多多指正。话不多说，进入正题：\n这个脚本目前只能刷一趟车的，人数可以是多个，支持选取作为类型等。实现思路是splinter.browser模拟浏览器登陆和操作，由于12306的验证码不好自动识别，所以，验证码需要用户进行手动识别，并进行登陆操作，之后的事情，就交由脚本来操作就可以了，下面是我测试时候的一些截图：\n第一步：如下图，首先输入抢票基本信息\n第二步：然后进入登录页，需要手动输入验证码，并点击登陆操作\n第三步：登陆后，自动进入到抢票页面，如下图这样的\n最后：就是坐等刷票结果就好了，如下图这样，就说是刷票成功了，刷到票后，会进行短信和邮件的通知，请记得及时前往12306进行支付，不然就白抢了。\nPython运行环境：python3.6用到的模块：re、splinter、time、sys、httplib2、urllib、smtplib、email未安装的模块，请使用pip instatll进行安装，例如：pip install splinter如下代码是这个脚本所有用到的模块引入：\nimport re\nfrom splinter.browser import Browser\nfrom time import sleep\nimport sys\nimport httplib2\nfrom urllib import parse\nimport smtplib\nfrom email.mime.text import MIMEText\n刷票前信息准备，我主要说一下始发站和目的地的cookie值获取，因为输入城市的时候，需要通过cookie值，cookie值可以通过12306官网，然后在F12（相信所有的coder都知道这个吧）的network里面的查询请求cookie中可以看到，在请求的header里面可以找到，_jc_save_fromStation值是出发站的cookie，_jc_save_toStation的值是目的地的cookie，然后加入到代码里的城市的cookie字典city_list里即可，键是城市的首字母，值是cookie值的形式。\n抢票，肯定需要先登录，我这里模拟的登录操作，会自动填充12306的账号名和密码，当然，你也可以在打开的浏览器中修改账号和密码，实现的关键代码如下：\ndef do_login(self):\n    \"\"\"登录功能实现，手动识别验证码进行登录\"\"\"\n    self.driver.visit(self.login_url)\n    sleep(1)\n    self.driver.fill('loginUserDTO.user_name', self.user_name)\n    self.driver.fill('userDTO.password', self.password)\n    print('请输入验证码……')\n    while True:\n        if self.driver.url != self.init_my_url:\n            sleep(1)\n        else:\n            break\n登录之后，就是控制刷票的各种操作处理了，这里，我就不贴代码了，因为代码比较多，别担心，在最后，我会贴出完整的代码的。\n当刷票成功后，我会进行短信和邮件的双重通知，当然，这里短信通知的平台，就看你用那个具体来修改代码了，我用的是互亿无线的体验版的免费短信通知接口；发送邮件模块我用的是smtplib，发送邮件服务器用的是163邮箱，如果用163邮箱的话，你还没有设置客户端授权密码，记得先设置客户端授权密码就好了，挺方便的。以下是主要实现代码：\ndef send_sms(self, mobile, sms_info):\n    \"\"\"发送手机通知短信，用的是-互亿无线-的测试短信\"\"\"\n    host = \"106.ihuyi.com\"\n    sms_send_uri = \"/webservice/sms.php?method=Submit\"\n    account = \"C59782899\"\n    pass_word = \"19d4d9c0796532c7328e8b82e2812655\"\n    params = parse.urlencode(\n        {'account': account, 'password': pass_word, 'content': sms_info, 'mobile': mobile, 'format': 'json'}\n    )\n    headers = {\"Content-type\": \"application/x-www-form-urlencoded\", \"Accept\": \"text/plain\"}\n    conn = httplib2.HTTPConnectionWithTimeout(host, port=80, timeout=30)\n    conn.request(\"POST\", sms_send_uri, params, headers)\n    response = conn.getresponse()\n    response_str = response.read()\n    conn.close()\n    return response_str\n\ndef send_mail(self, receiver_address, content):\n    \"\"\"发送邮件通知\"\"\"\n    # 连接邮箱服务器信息\n    host = 'smtp.163.com'\n    port = 25\n    sender = 'xxxxxx@163.com'  # 你的发件邮箱号码\n    pwd = '******'  # 不是登陆密码，是客户端授权密码\n    # 发件信息\n    receiver = receiver_address\n    body = '<h2>温馨提醒：</h2><p>' + content + '</p>'\n    msg = MIMEText(body, 'html', _charset=\"utf-8\")\n    msg['subject'] = '抢票成功通知！'\n    msg['from'] = sender\n    msg['to'] = receiver\n    s = smtplib.SMTP(host, port)\n    # 开始登陆邮箱，并发送邮件\n    s.login(sender, pwd)\n    s.sendmail(sender, receiver, msg.as_string())\n说了那么多，感觉都是说了好多废话啊，哈哈，不好意思，耽误大家时间来看我瞎扯了，我贴上大家最关心的源码，请接码，大家在尝试运行过程中，有任何问题，可以给我留言或者私信我，我看到都会及时回复大家的：\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\n\"\"\"\n通过splinter刷12306火车票\n可以自动填充账号密码，同时，在登录时，也可以修改账号密码\n然后手动识别验证码，并登陆，接下来的事情，交由脚本来做了，静静的等待抢票结果就好（刷票过程中，浏览器不可关闭）\nauthor: cuizy\ntime: 2018-05-30\n\"\"\"\n\nimport re\nfrom splinter.browser import Browser\nfrom time import sleep\nimport sys\nimport httplib2\nfrom urllib import parse\nimport smtplib\nfrom email.mime.text import MIMEText\n\n\nclass BrushTicket(object):\n    \"\"\"买票类及实现方法\"\"\"\n\n    def __init__(self, user_name, password, passengers, from_time, from_station, to_station, number, seat_type, receiver_mobile, receiver_email):\n        \"\"\"定义实例属性，初始化\"\"\"\n        # 1206账号密码\n        self.user_name = user_name\n        self.password = password\n        # 乘客姓名\n        self.passengers = passengers\n        # 起始站和终点站\n        self.from_station = from_station\n        self.to_station = to_station\n        # 乘车日期\n        self.from_time = from_time\n        # 车次编号\n        self.number = number.capitalize()\n        # 座位类型所在td位置\n        if seat_type == '商务座特等座':\n            seat_type_index = 1\n            seat_type_value = 9\n        elif seat_type == '一等座':\n            seat_type_index = 2\n            seat_type_value = 'M'\n        elif seat_type == '二等座':\n            seat_type_index = 3\n            seat_type_value = 0\n        elif seat_type == '高级软卧':\n            seat_type_index = 4\n            seat_type_value = 6\n        elif seat_type == '软卧':\n            seat_type_index = 5\n            seat_type_value = 4\n        elif seat_type == '动卧':\n            seat_type_index = 6\n            seat_type_value = 'F'\n        elif seat_type == '硬卧':\n            seat_type_index = 7\n            seat_type_value = 3\n        elif seat_type == '软座':\n            seat_type_index = 8\n            seat_type_value = 2\n        elif seat_type == '硬座':\n            seat_type_index = 9\n            seat_type_value = 1\n        elif seat_type == '无座':\n            seat_type_index = 10\n            seat_type_value = 1\n        elif seat_type == '其他':\n            seat_type_index = 11\n            seat_type_value = 1\n        else:\n            seat_type_index = 7\n            seat_type_value = 3\n        self.seat_type_index = seat_type_index\n        self.seat_type_value = seat_type_value\n        # 通知信息\n        self.receiver_mobile = receiver_mobile\n        self.receiver_email = receiver_email\n        # 主要页面网址\n        self.login_url = 'https://kyfw.12306.cn/otn/login/init'\n        self.init_my_url = 'https://kyfw.12306.cn/otn/index/initMy12306'\n        self.ticket_url = 'https://kyfw.12306.cn/otn/leftTicket/init'\n        # 浏览器驱动信息，驱动下载页：https://sites.google.com/a/chromium.org/chromedriver/downloads\n        self.driver_name = 'chrome'\n        self.executable_path = 'C:\\\\Users\\cuizy\\AppData\\Local\\Programs\\Python\\Python36\\Scripts\\chromedriver.exe'\n\n    def do_login(self):\n        \"\"\"登录功能实现，手动识别验证码进行登录\"\"\"\n        self.driver.visit(self.login_url)\n        sleep(1)\n        self.driver.fill('loginUserDTO.user_name', self.user_name)\n        self.driver.fill('userDTO.password', self.password)\n        print('请输入验证码……')\n        while True:\n            if self.driver.url != self.init_my_url:\n                sleep(1)\n            else:\n                break\n\n    def start_brush(self):\n        \"\"\"买票功能实现\"\"\"\n        self.driver = Browser(driver_name=self.driver_name, executable_path=self.executable_path)\n        # 浏览器窗口的大小\n        self.driver.driver.set_window_size(900, 700)\n        self.do_login()\n        self.driver.visit(self.ticket_url)\n        try:\n            print('开始刷票……')\n            # 加载车票查询信息\n            self.driver.cookies.add({\"_jc_save_fromStation\": self.from_station})\n            self.driver.cookies.add({\"_jc_save_toStation\": self.to_station})\n            self.driver.cookies.add({\"_jc_save_fromDate\": self.from_time})\n            self.driver.reload()\n            count = 0\n            while self.driver.url.split('?')[0] == self.ticket_url:\n                self.driver.find_by_text('查询').click()\n                sleep(1)\n                count += 1\n                print('第%d次点击查询……' % count)\n                try:\n                    car_no_location = self.driver.find_by_id(\"queryLeftTable\")[0].find_by_text(self.number)[1]\n                    current_tr = car_no_location.find_by_xpath(\"./../../../../..\")\n                    if current_tr.find_by_tag('td')[self.seat_type_index].text == '--':\n                        print('无此座位类型出售，已结束当前刷票，请重新开启！')\n                        sys.exit(1)\n                    elif current_tr.find_by_tag('td')[self.seat_type_index].text == '无':\n                        print('无票，继续尝试……')\n                    else:\n                        # 有票，尝试预订\n                        print('刷到票了（余票数：' + str(current_tr.find_by_tag('td')[self.seat_type_index].text) + '），开始尝试预订……')\n                        current_tr.find_by_css('td.no-br>a')[0].click()\n                        sleep(1)\n                        key_value = 1\n                        for p in self.passengers:\n                            # 选择用户\n                            print('开始选择用户……')\n                            self.driver.find_by_text(p).last.click()\n                            # 选择座位类型\n                            print('开始选择席别……')\n                            if self.seat_type_value != 0:\n                                seat_select = self.driver.find_by_id(\"seatType_\" + str(key_value))[0]\n                                seat_select.find_by_xpath(\"//option[@value='\" + str(self.seat_type_value) + \"']\")[0].click()\n                            key_value += 1\n                            sleep(0.5)\n                            if p[-1] == ')':\n                                self.driver.find_by_id('dialog_xsertcj_ok').click()\n                        print('正在提交订单……')\n                        self.driver.find_by_id('submitOrder_id').click()\n                        sleep(2)\n                        # 查看放回结果是否正常\n                        submit_false_info = self.driver.find_by_id('orderResultInfo_id')[0].text\n                        if submit_false_info != '':\n                            print(submit_false_info)\n                            self.driver.find_by_id('qr_closeTranforDialog_id').click()\n                            sleep(0.2)\n                            self.driver.find_by_id('preStep_id').click()\n                            sleep(0.3)\n                            continue\n                        print('正在确认订单……')\n                        self.driver.find_by_id('qr_submit_id').click()\n                        print('预订成功，请及时前往支付……')\n                        # 发送通知信息\n                        self.send_mail(self.receiver_email, '恭喜您，抢到票了，请及时前往12306支付订单！')\n                        self.send_sms(self.receiver_mobile, '您的验证码是：8888。请不要把验证码泄露给其他人。')\n                except Exception as error_info:\n                    print(error_info)\n        except Exception as error_info:\n            print(error_info)\n\n    def send_sms(self, mobile, sms_info):\n        \"\"\"发送手机通知短信，用的是-互亿无线-的测试短信\"\"\"\n        host = \"106.ihuyi.com\"\n        sms_send_uri = \"/webservice/sms.php?method=Submit\"\n        account = \"C59782899\"\n        pass_word = \"19d4d9c0796532c7328e8b82e2812655\"\n        params = parse.urlencode(\n            {'account': account, 'password': pass_word, 'content': sms_info, 'mobile': mobile, 'format': 'json'}\n        )\n        headers = {\"Content-type\": \"application/x-www-form-urlencoded\", \"Accept\": \"text/plain\"}\n        conn = httplib2.HTTPConnectionWithTimeout(host, port=80, timeout=30)\n        conn.request(\"POST\", sms_send_uri, params, headers)\n        response = conn.getresponse()\n        response_str = response.read()\n        conn.close()\n        return response_str\n\n    def send_mail(self, receiver_address, content):\n        \"\"\"发送邮件通知\"\"\"\n        # 连接邮箱服务器信息\n        host = 'smtp.163.com'\n        port = 25\n        sender = 'gxcuizy@163.com'  # 你的发件邮箱号码\n        pwd = 'CUIzy9118'  # 不是登陆密码，是客户端授权密码\n        # 发件信息\n        receiver = receiver_address\n        body = '<h2>温馨提醒：</h2><p>' + content + '</p>'\n        msg = MIMEText(body, 'html', _charset=\"utf-8\")\n        msg['subject'] = '抢票成功通知！'\n        msg['from'] = sender\n        msg['to'] = receiver\n        s = smtplib.SMTP(host, port)\n        # 开始登陆邮箱，并发送邮件\n        s.login(sender, pwd)\n        s.sendmail(sender, receiver, msg.as_string())\n\n\nif __name__ == '__main__':\n    # 12306用户名\n    user_name = input('请输入12306用户名：')\n    while user_name == '':\n        user_name = input('12306用户名不能为空，请重新输入：')\n    # 12306登陆密码\n    password = input('请输入12306登陆密码：')\n    while password == '':\n        password = input('12306登陆密码不能为空，请重新输入：')\n    # 乘客姓名\n    passengers_input = input('请输入乘车人姓名，多人用英文逗号“,”连接，（例如单人“张三”或者多人“张三,李四”）：')\n    passengers = passengers_input.split(\",\")\n    while passengers_input == '' or len(passengers) > 4:\n        print('乘车人最少1位，最多4位！')\n        passengers_input = input('请重新输入乘车人姓名，多人用英文逗号“,”连接，（例如单人“张三”或者多人“张三,李四”）：')\n        passengers = passengers_input.split(\",\")\n    # 乘车日期\n    from_time = input('请输入乘车日期（例如“2018-08-08”）：')\n    date_pattern = re.compile(r'^\\d{4}-\\d{2}-\\d{2}$')\n    while from_time == '' or re.findall(date_pattern, from_time) == []:\n        from_time = input('乘车日期不能为空或者时间格式不正确，请重新输入：')\n    # 城市cookie字典\n    city_list = {\n        'bj': '%u5317%u4EAC%2CBJP',  # 北京\n        'hd': '%u5929%u6D25%2CTJP',  # 邯郸\n        'nn': '%u5357%u5B81%2CNNZ',  # 南宁\n        'wh': '%u6B66%u6C49%2CWHN',  # 武汉\n        'cs': '%u957F%u6C99%2CCSQ',  # 长沙\n        'ty': '%u592A%u539F%2CTYV',  # 太原\n        'yc': '%u8FD0%u57CE%2CYNV',  # 运城\n        'gzn': '%u5E7F%u5DDE%u5357%2CIZQ',  # 广州南\n        'wzn': '%u68A7%u5DDE%u5357%2CWBZ',  # 梧州南\n    }\n    # 出发站\n    from_input = input('请输入出发站，只需要输入首字母就行（例如北京“bj”）：')\n    while from_input not in city_list.keys():\n        from_input = input('出发站不能为空或不支持当前出发站（如有需要，请联系管理员！），请重新输入：')\n    from_station = city_list[from_input]\n    # 终点站\n    to_input = input('请输入终点站，只需要输入首字母就行（例如北京“bj”）：')\n    while to_input not in city_list.keys():\n        to_input = input('终点站不能为空或不支持当前终点站（如有需要，请联系管理员！），请重新输入：')\n    to_station = city_list[to_input]\n    # 车次编号\n    number = input('请输入车次号（例如“G110”）：')\n    while number == '':\n        number = input('车次号不能为空，请重新输入：')\n    # 座位类型\n    seat_type = input('请输入座位类型（例如“软卧”）：')\n    while seat_type == '':\n        seat_type = input('座位类型不能为空，请重新输入：')\n    # 抢票成功，通知该手机号码\n    receiver_mobile = input('请预留一个手机号码，方便抢到票后进行通知（例如：18888888888）：')\n    mobile_pattern = re.compile(r'^1{1}\\d{10}$')\n    while receiver_mobile == '' or re.findall(mobile_pattern, receiver_mobile) == []:\n        receiver_mobile = input('预留手机号码不能为空或者格式不正确，请重新输入：')\n    receiver_email = input('请预留一个邮箱，方便抢到票后进行通知（例如：test@163.com）：')\n    while receiver_email == '':\n        receiver_email = input('预留邮箱不能为空，请重新输入：')\n    # 开始抢票\n    ticket = BrushTicket(user_name, password, passengers, from_time, from_station, to_station, number, seat_type, receiver_mobile, receiver_email)\n    ticket.start_brush()\n\n\n                ", "mainLikeNum": ["1 "], "mainBookmarkNum": "3"}