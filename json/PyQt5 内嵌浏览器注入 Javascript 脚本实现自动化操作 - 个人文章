{"title": "PyQt5 内嵌浏览器注入 Javascript 脚本实现自动化操作 - 个人文章 ", "index": "pyqt,qt5,自动化测试,自动化,python", "content": "概要\n应同学邀请，演示如何使用 PyQt5 内嵌浏览器浏览网页，并注入 Javascript 脚本实现自动化操作。\nsg 原贴地址： 如何在Python利用runJavaScript模拟鼠标移动页面的某个元素https://segmentfault.com/q/10...\n下面测试的是一个廉价机票预订网站（http://www.flyscoot.com/），关键点如下\n\n使用 QWebEngineView 加载网页，并显示进度。\n在默认配置（QWebEngineProfile）中植入 Javascript 内容，这样脚本会在所有打开的网页中执行，不论跳转到哪个网址。\nJavascript 脚本使用网址中的路径名，判断当前网页位置，从而决定执行哪种操作。\n\npython 代码示例\n#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n'''使用 PyQt5 内嵌浏览器浏览网页，并注入 Javascript 脚本实现自动化操作。'''\nimport os\nimport sys\nfrom datetime import datetime\n\nfrom PyQt5.QtWidgets import (\n    QWidget, QApplication, QVBoxLayout, QHBoxLayout,\n    QDesktopWidget, QTextEdit, QLabel, QLineEdit, QPushButton,\n    QFileDialog, QProgressBar,\n)\nfrom PyQt5.QtCore import QUrl, pyqtSlot\nfrom PyQt5.QtWebEngineWidgets import QWebEngineView, QWebEngineProfile, QWebEngineScript, QWebEnginePage\n\n\nclass Browser(QWidget):\n\n    def __init__(self):\n        super().__init__()\n        self.init_ui()\n\n        # 脚本\n        self.profile = QWebEngineProfile.defaultProfile()\n        self.script = QWebEngineScript()\n        self.prepare_script()\n\n    def init_ui(self):\n        self.webView = QWebEngineView()\n\n        self.logEdit = QTextEdit()\n        self.logEdit.setFixedHeight(100)\n\n        self.addrEdit = QLineEdit()\n        self.addrEdit.returnPressed.connect(self.load_url)\n        self.webView.urlChanged.connect(\n            lambda i: self.addrEdit.setText(i.toDisplayString()))\n\n        self.jsEdit = QLineEdit()\n        self.jsEdit.setText('inject.js')\n\n        loadUrlBtn = QPushButton('加载')\n        loadUrlBtn.clicked.connect(self.load_url)\n\n        chooseJsBtn = QPushButton('选择脚本文件')\n        chooseJsBtn.clicked.connect(self.choose_js_file)\n\n        # 导航/工具\n        top = QWidget()\n        top.setFixedHeight(80)\n        topBox = QVBoxLayout(top)\n        topBox.setSpacing(0)\n        topBox.setContentsMargins(5, 0, 0, 5)\n\n        progBar = QProgressBar()\n        progBox = QHBoxLayout()\n        progBox.addWidget(progBar)\n        topBox.addLayout(progBox)\n\n        naviBox = QHBoxLayout()\n        naviBox.addWidget(QLabel('网址'))\n        naviBox.addWidget(self.addrEdit)\n        naviBox.addWidget(loadUrlBtn)\n        topBox.addLayout(naviBox)\n\n        naviBox = QHBoxLayout()\n        naviBox.addWidget(QLabel('注入脚本文件'))\n        naviBox.addWidget(self.jsEdit)\n        naviBox.addWidget(chooseJsBtn)\n        topBox.addLayout(naviBox)\n\n        self.webView.loadProgress.connect(progBar.setValue)\n\n        # 主界面\n        layout = QVBoxLayout(self)\n        layout.addWidget(self.webView)\n        layout.addWidget(top)\n        layout.addWidget(self.logEdit)\n\n        self.show()\n        self.resize(1024, 900)\n        self.center()\n\n    def center(self):\n        qr = self.frameGeometry()\n        cp = QDesktopWidget().availableGeometry().center()\n        qr.moveCenter(cp)\n        self.move(qr.topLeft())\n\n    @pyqtSlot()\n    def load_url(self):\n        url = self.addrEdit.text().strip()\n        if not url.lower().startswith('http://') \\\n                and not url.lower().startswith('https://'):\n            url = 'http://{}'.format(url)\n        self.load(url)\n\n    @pyqtSlot()\n    def choose_js_file(self):\n        f, _ = QFileDialog.getOpenFileName(filter=\"Javascript files(*.js)\")\n        if os.path.isfile(f):\n            self.jsEdit.setText(f)\n            self.prepare_script()\n\n    def prepare_script(self):\n        path = self.jsEdit.text().strip()\n        if not os.path.isfile(path):\n            self.log('invalid js path')\n            return\n\n        self.profile.scripts().remove(self.script)\n        with open(path, 'r') as f:\n            self.script.setSourceCode(f.read())\n        self.profile.scripts().insert(self.script)\n        self.log('injected js ready')\n\n    def log(self, msg, *args, **kwargs):\n        m = msg.format(*args, **kwargs)\n        self.logEdit.append('{} {}'.format(\n            datetime.now().strftime('%H:%M:%S'), m))\n\n    def load(self, url):\n        self.log(f'loading {url}')\n        self.addrEdit.setText(url)\n        self.webView.load(QUrl(url))\n\n\nif __name__ == '__main__':\n    app = QApplication(sys.argv)\n    b = Browser()\n    b.load('http://www.flyscoot.com/')\n    sys.exit(app.exec_())\nJavascript 脚本示例\n// 简单起见，这里只演示部分页面，脚本内容摘自 Heng丶原贴文。\nfunction handle(path) {\n    // 首页\n    if (path == '/zh') {\n        document.getElementsByClassName('radio-inline')[1].click();\n        document.getElementById('oneway_from').value='广州 (CAN)';\n        document.getElementById('oneway_to').value='新加坡 (SIN)';\n        document.getElementById('oneway_departuredate').value='2018年9月10日';\n        document.getElementsByClassName('btn--booking')[1].click();\n        return;\n    }\n\n    // 选择航班\n    if (path == '/Book/Flight') {\n        document.getElementsByClassName('price--sale')[0].click();\n        document.getElementsByClassName('heading-4')[0].click();\n        document.getElementsByClassName('btn-submit')[0].click();\n        return;\n    }\n\n    // 乘客信息\n    if (path == '/BookFlight/Passengers') {\n        document.getElementsByClassName('fname1')[0].value = \"匿名\";\n    }\n}\n\n\nlet host = document.location.hostname;\nif (host.endsWith('.flyscoot.com')) {\n    handle(document.location.pathname);\n}\n\n                ", "mainLikeNum": ["9 "], "mainBookmarkNum": "5"}