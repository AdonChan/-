{"title": "在Mac上使用Nginx和FastCGI部署Flask应用 - wzyplus ", "index": "flask,python", "content": "最近在学习Flask，本文介绍一下如何部署Flask开发的应用，同时也学习一下Nginx的使用，这只是在Mac上的一个实验。\n\n应用\n\n这里使用的应用就是官方的文档中给出的Flaskr。\n\n安装Nginx\n\n使用HomeBrew安装Nginx：\n\nshell$ brew install nginx\n\n\nHomeBrew会自动安装Nginx及其依赖的程序。在我的电脑上安装的是Nginx 1.6.2，配置文件的路径是/usr/local/etc/nginx/nginx.conf。\n\n启动Nginx的命令：\n\nshell$ nginx\n\n\nNginx的默认端口是8080，用浏览器打开localhost:8080，显示如下所示的页面说明Nginx已经工作了。\n\n\n\n配置Nginx\n\n修改Nginx的配置文件：\n\nserver {\n    listen 80;\n    server_name localhost;\n    charset utf-8;\n\n    location / { try_files $uri @flaskr; }\n    location @flaskr {\n        include fastcgi_params;\n        fastcgi_param PATH_INFO $fastcgi_script_name;\n        fastcgi_param SCRIPT_NAME \"\";\n        fastcgi_pass unix:/tmp/flaskr-fcgi.sock;\n    }\n}\n\n\n重新启动Nginx：\n\nshell$ nginx -s quit\n$ sudo nginx\n\n\n因为使用了80端口，启动Nginx时需要加上sudo。\n\n启动完成后，访问localhost：\n\n访问时出现了错误，这是因为我们的应用还没有启动。\n\nFastCGI Server\n\nNginx是一个静态WEB服务器，不能直接运行我们的Python应用，当Nginx接受到请求时，会通过FastCGI转发给我们的应用，应用是运行在FastCGI Server上的，这个server接收Nginx的请求并调用我们的程序，将结果返回给Nginx，Nginx再将结果返回给用户。\n\n我们要使用的FastCGI Server是flup，安装方法：\n\nshell$ pip install flup\n\n\n在应用目录下创建一个fcgi文件，例如flaskr.fcgi：\n\nPython#!/usr/bin/python\nfrom flup.server.fcgi import WSGIServer\nfrom flaskr import app\n\nif __name__ == '__main__':\n    WSGIServer(app, bindAddress='/tmp/flaskr-fcgi.sock').run()\n\n\n同时给fcgi文件可执行的权限：\n\nshell$ chmod +x flaskr.fcgi\n\n\n手动启动server：\n\nshell$ screen\n$ ./flaskr.fcgi\n\n\n使用screen使server在后台运行，或者：\n\nshell$ nohup ./flaskr.fcgi &\n\n\n再次访问localhost就可以看到我们的应用了。\n\n遇到的问题\n\n第一次运行FastCGI server后，任然无法访问，查看Nginx的日志后发现Nginx服务器没有权限访问socket文件，修改nginx.conf添加user配置：\n\nuser wzy;\n\n\n启动的时候Nginx报错：\n\nnginx: [emerg] getgrnam(\"wzy\") failed in /usr/local/etc/nginx/nginx.conf:2\n\n\nGoogle一下后发现要加上用户组才行，改成这样：\n\nuser wzy wheel;\n\n\n再次启动Nginx后一切正常了。\n\nNginx配置项user的使用方法：\n\nSyntax: user user [group];\nDefault: user nobody nobody;\n\n\n如果忽略group，Nginx会使用和user名称一样的用户组，例如我设置user wzy，那么Nginx启动的时候会去查找用户组wzy，我的电脑上没有这个用户组，所以Nginx会报错。\n\n                ", "mainLikeNum": ["3 "], "mainBookmarkNum": "11"}