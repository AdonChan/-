{"title": "scrapy 学习之路上的那些坑 - web杂烩 ", "index": "scrapy,python", "content": "前言\n本文记录自己在学习scrapy当中遇到的各种大小问题，持续更新。\n环境简介：\n\n\n语言版本\n爬虫框架\nIDE\n系统\n\n\npython3.5\nscrapy1.4.0\npycharm\nwin10 x64\n\n\nscrapy安装失败\n报错显示缺少Twisted。错误分析：Twisted本身是一个网络引擎框架，scrapy的运行依赖于Twisted。解决办法：通过 http://www.lfd.uci.edu/~gohlk...，在通过pip install xxxpath(xxxpath 指代whl下载到本机的路径)。\nNo module named scrapy\n在pycharm打开scrapy新建的项目后，import scrapy 报错显示No module named scrapy。错误分析：pycharm的默认依赖项当中没有scrapy，或者说默认查找的路径中找不到scrapy。解决办法：通过file=>Default Settings=>Project Interpreter 重新关联python，pycharm的local中加入本地的python.exe\nXPaths谷歌插件使用\n插件下载地址：https://chrome.google.com/web...安装完毕xpath之后，需要重新加载页面，方可使用。\nscrapy 生成json文件中文是Unicode字符\n错误分析：scrapy在做json序列化的时候默认使用的是ensure_ascii 编码。解决办法：在设置当中（settings.py），加入FEED_EXPORT_ENCODING = 'utf-8'。\n解决爬取数据频繁时，被禁止\n错误分析：网站本身有反爬虫，会针对频繁快速拉去的ip和用户进行封锁。解决办法：设置动态的用会代理和动态的ip代理。在中间件文件middlewares.py中，增加动态IP代理类和动态用户代理类。\nimport random\n\nPROXIES = [\n    {'ip_port': '106.39.179.244:80'},\n    {'ip_port': '65.52.223.99:80'},\n    {'ip_port': '1.52.248.207:3128'},\n    {'ip_port': '45.77.198.207:3128'},\n    {'ip_port': '177.125.119.16:8080'},\n    {'ip_port': '174.138.65.233:3128'}\n]\n\n\nclass RandomUserAgent(object):\n    \"\"\"Randomly rotate user agents based on a list of predefined ones\"\"\"\n\n    def __init__(self, agents):\n        self.agents = agents\n\n    @classmethod\n    def from_crawler(cls, crawler):\n        return cls(crawler.settings.getlist('USER_AGENTS'))\n\n    def process_request(self, request, spider):\n        # print \"**************************\" + random.choice(self.agents)\n        request.headers.setdefault('User-Agent', random.choice(self.agents))\n\n\nclass ProxyMiddleware(object):\n    def process_request(self, request, spider):\n        proxy = random.choice(PROXIES)\n        print(\"**************ProxyMiddleware no pass************\" + proxy['ip_port'])\n        request.meta['proxy'] = \"http://%s\" % proxy['ip_port']\n这组动态IP需要注意的是，隔一段时间可能会失效，需要重新获取IP。在配置文件settings.py中增加\n    DOWNLOADER_MIDDLEWARES = {\n        'tutorial.middlewares.RandomUserAgent': 1,\n        'scrapy.contrib.downloadermiddleware.httpproxy.HttpProxyMiddleware': 110,\n        'tutorial.middlewares.ProxyMiddleware': 100\n    }\n    USER_AGENTS = [\n    \"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; AcooBrowser; .NET CLR 1.1.4322; .NET CLR 2.0.50727)\",\n    \"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; Acoo Browser; SLCC1; .NET CLR 2.0.50727; Media Center PC 5.0; .NET CLR 3.0.04506)\",\n    \"Mozilla/4.0 (compatible; MSIE 7.0; AOL 9.5; AOLBuild 4337.35; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)\",\n    \"Mozilla/5.0 (Windows; U; MSIE 9.0; Windows NT 9.0; en-US)\",\n    \"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 2.0.50727; Media Center PC 6.0)\",\n    \"Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; WOW64; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 1.0.3705; .NET CLR 1.1.4322)\",\n    \"Mozilla/4.0 (compatible; MSIE 7.0b; Windows NT 5.2; .NET CLR 1.1.4322; .NET CLR 2.0.50727; InfoPath.2; .NET CLR 3.0.04506.30)\",\n    \"Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN) AppleWebKit/523.15 (KHTML, like Gecko, Safari/419.3) Arora/0.3 (Change: 287 c9dfb30)\",\n    \"Mozilla/5.0 (X11; U; Linux; en-US) AppleWebKit/527+ (KHTML, like Gecko, Safari/419.3) Arora/0.6\",\n    \"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.2pre) Gecko/20070215 K-Ninja/2.1.1\",\n    \"Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9) Gecko/20080705 Firefox/3.0 Kapiko/3.0\",\n    \"Mozilla/5.0 (X11; Linux i686; U;) Gecko/20070322 Kazehakase/0.4.5\",\n    \"Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6\",\n    \"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.56 Safari/535.11\",\n    \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_3) AppleWebKit/535.20 (KHTML, like Gecko) Chrome/19.0.1036.7 Safari/535.20\",\n    \"Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; fr) Presto/2.9.168 Version/11.52\",\n]\n\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "0"}