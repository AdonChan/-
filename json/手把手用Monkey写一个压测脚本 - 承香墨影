{"title": "手把手用Monkey写一个压测脚本 - 承香墨影 ", "index": "python,monkey,android", "content": "\n版权声明：\n本账号发布文章均来自公众号，承香墨影（cxmyDev），版权归承香墨影所有。\n允许有条件转载，转载请附带底部二维码。\n\n一、为什么需要一个测试脚本？\n昨天讲解了Android Monkey命令的使用方式，今天趁着还热乎就手把手用Monkey写一个压力测试的脚本。还不了解什么是Monkey的，可以看看昨天的文章。\nMonkey说到底其实就是一段命令，只能在有限的范围内做一些随机事件的压力测试。可以很明显看到它的一些缺点：\n\n前期准备工作太多，需要把设备准备好、安装好待测Apk。\n无法做到无干预的循环。类似没人看着去测试一夜的情况。\n对一些在测试情况下，各项状态的监控并不好。\n\n那么，这些问题，其实都可以使用一个脚本来解决问题。\nMonkey命令其实就是在命令行中执行的命令，所以脚本语言基本上都可以完成这个任务，这里选择主流的Python来完成。\n二、如何设计压测脚本\n既然是一个完整的脚本，那么当然需要满足一些最基本的需求。\n包括：\n\n可以自动安装待测试apk。\n可以循环执行脚本，并且每次都退出App重新执行。\n在执行完成之后，可以输出测试报告。\n变动的参数，可以让测试人员自行配置。\n\n一个简单的测试脚本，包括这些基本上就足够了。\n三、动手写脚本\n编写完成之后，Python的项目结构大概是这样子的。\n\n项目的结构大概如下：\n\napk目录：用于存放待测试的Apk。\nbugreport_out目录：用于存放测试完成输出的报告。\n.config：压力测试的配置信息文件。\nchkbugreport.jar：输出测试报告的工具。\nrunmonkey.py：真正需要执行的Python脚本。\nstart.bat：为测试准备一个点击就可以执行的bat脚本。\n\n了解了项目的结构之后，就可以开始编写Python脚本了。\n1、编写配置文件和读取配置文件\n首先看看.config配置文件。\n\n在配置文件里，主要配置待测试的设备ID、循环执行次数，和每次循环的时候点击的次数。\n这样设计，基本上可以通过execcount和monkeyclickcount两个参数，配置所需要执行多久的一个压测方案。\n接下来就需要一个方法去读配置文件。\n\n2、安装待测试apk\n一般测试都是会测试同一个apk产品，所以这里写死apk的文件名。直接通过os.popen()这个Python的方法执行adb脚本。\n\n3、杀掉待测app\n为了让每次循环都是新的一个测试任务，保持测试环境的赶紧，需要一个方法在每次循环之前，杀掉之前正在运行的待测App。\n\n4、生成测试报告\n生成测试报告主要依赖chkbugreport.jar这个工具，它会根据bugreport获得的文件内容，生成测试报告。\nbugreport的用法：\nadb shell bugreport > .\\bugreport.txt\n而chkbugreport.jar是一个java编写的工具，直接通过java -jar 执行即可\n完整的代码如下：\n\n5、开始执行Monkey脚本\n做完准备工作，就需要一个方法来执行我们配置好的Monkey脚本。\n\n各项参数的配置，不明白的看看昨天的文章吧。\n6、开始调用准备好的方法\n准备工作已经完成，接下来将这些准备好的方法，组合起来，用一个for循环完成脚本的执行。\n\n四、为测试人员准备一个bat\n做完这些，基本上就算是把主要功能完成了。执行下面的命令，就可以跑起来了。\npython runmonkey.py\n但是终归这个脚本是要给测试用的，最好还是提供一个点击可用的bat脚本。\n新建一个start.bat文件，把上面的命令保存进去就行。\n下面看看执行起来的样子。\n\n这里配置了循环三次，所以最终从Log中可以看到，确实执行三次之后，生成测试报告，并且退出测试。\n五、生成的测试报告\nchkbugreport.jar 可以通过生成的bugreport的内容，生成我们需要的测试报告。\n从上面的截图可以看到，其实它会是一个网页，输出的内容非常的齐全。\n\n六、多说两句\n其实这个Monkey的压力测试脚本，已经满足测试的基本要求。但是实际上，生成的测试报告，不太好查看。通常封装成成熟的产品的App，都会集成第三方Bug监控的服务，例如：Bugly、友盟什么的。所以可以不以来bugreport生成的测试报告，直接在打测试包的时候，生成一个测试渠道的apk，用它来测试，这样在第三方服务提供的网站上，可以清晰看到测试的报告。\n七、完整的Demo\n完整的Demo请关注承香墨影的公众账号，回复关键词：“monkey脚本”获得。\n\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "4"}