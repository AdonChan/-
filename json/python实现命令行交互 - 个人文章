{"title": "python实现命令行交互 - 个人文章 ", "index": "shell,python", "content": "背景：\n最近因为工作需求在写自动化测试脚本，主要目的是测试代码功能的完整性，然而在使用SSHLibrary库进行远程SSH交互的时候总是出现问题，比如说遇到需要输入密码的交互，总是不能成功，还有遇到一直保持运行并实时输出的命令，也无法读取其中的输出。所以就只能使用python实现脚本进行交互，和SSH解耦合。\n使用的库subprocess和argparse；\n\n\n代码1：由于命令行执行之后，进程一直在运行，不停的出块，所以我将出块的内容写入到文件中。\nimport subprocess\nimport sys\nimport argparse\n\nclass TimeoutError(Exception):\n    pass \n\ndef excuteCmd(cmd):\n        popen = subprocess.Popen(cmd,stderr=subprocess.PIPE, stdout=subprocess.PIPE, shell = True) \n\n        while True:\n            buff = popen.stdout.readline()\n            fh = open(\"/home/ubuntu/bottos/bottos.txt\", 'a+')\n            fh.write(buff)\n            sys.stdout.write(buff)\n            if buff == '' and popen.poll() != None:\n                break\n    \n\nif __name__ == '__main__':\n        ''' self test ''' \n        parser = argparse.ArgumentParser(description='manual to this script')\n        parser.add_argument('--delegate', type=str,default=None)\n        args = parser.parse_args()\n        try: \n            bottos = \"/home/ubuntu/bottos/bottos \"\n            cmd = bottos + \"--delegate \" + args.delegate + \" --enable-wallet\"\n            ret = excuteCmd(cmd)\n            print ret \n        except TimeoutError, e: \n            print repr(e)\n代码2：实现输入密码的功能\nimport subprocess\nimport argparse\n\nclass TimeoutError(Exception):\n    pass \n\ndef excuteCmd(cmd, passwd, timeout = 1):\n        s = subprocess.Popen(cmd,stdin=subprocess.PIPE, stdout=subprocess.PIPE, shell = True) \n        s.stdin.write(passwd+'\\n')\n        out, err = s.communicate()\n        if err is not None:\n            return err\n    \n        return out\n    \n\nif __name__ == '__main__':\n        ''' self test ''' \n        parser = argparse.ArgumentParser(description='manual to this script')\n        parser.add_argument('--name', type=str,default=None)\n        parser.add_argument('--passwd', type=str,default=None)\n        args = parser.parse_args()\n        try: \n            unlock = \"/home/ubuntu/bottos/bcli wallet unlock \"\n            cmd = unlock + \"--account \" + args.name\n            ret = excuteCmd(cmd,args.passwd,5)\n            print ret \n        except TimeoutError, e: \n            print repr(e)\n\n临时解救用的脚本，有几个问题\n\n在使用popen.stdout.read()读取不出来内容，只能使用popen.stdout.readline()\n在使用stdout.read()和stdin.write()       communicate()不能同时使用，原因可能是需要用stdout.readline()，不过我没有尝试。\n\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "0"}