{"title": "Python查看微信好友撤回的消息 - 白露未晞 ", "index": "python", "content": "公众号：Charles的皮卡丘作者：Charles\n开发工具：Python版本：3.6.4相关模块：itchat模块；以及一些Python自带的模块。\n环境搭建：安装Python并添加到环境变量，pip安装需要的相关模块即可。\n原理简介：思路比较简单，利用itchat模块登录网页版微信，将自己微信收到的所有消息都缓存下来，当检测到有消息撤回时，将撤回消息的缓存版本通过文件传输助手发送到自己的手机上。因此，你必须保证脚本24小时运行才可以一直监视别人有没有撤回消息。具体实现过程详见源代码。\n视频演示：https://mp.weixin.qq.com/s/Ch...\n源代码：\n# Python查看微信撤回消息\n# 公众号: Charles的皮卡丘\n# 作者: Charles\nimport re\nimport os\nimport time\nimport itchat\nimport platform\nfrom itchat.content import TEXT\nfrom itchat.content import *\n\n\nmsg_info = {}\nface_package = None\n\n\n# 处理接收到的信息\n@itchat.msg_register([TEXT, PICTURE, FRIENDS, CARD, MAP, SHARING, RECORDING, ATTACHMENT, VIDEO], isFriendChat=True, isMpChat=True)\ndef handleRMsg(msg):\n    global face_package\n    # 接收消息的时间\n    msg_time_receive = time.strftime(\"%Y-%m-%d %H:%M:%S\", time.localtime())\n    # 发信人\n    try:\n        msg_from = itchat.search_friends(userName=msg['FromUserName'])['NickName']\n    except:\n        msg_from = 'WeChat Official Accounts'\n    # 发信时间\n    msg_time_send = msg['CreateTime']\n    # 信息ID\n    msg_id = msg['MsgId']\n    msg_content = None\n    msg_link = None\n    # 文本或者好友推荐\n    if msg['Type'] == 'Text' or msg['Type'] == 'Friends':\n        msg_content = msg['Text']\n        print('[Text/Friends]: %s' % msg_content)\n    # 附件/视频/图片/语音\n    elif msg['Type'] == 'Attachment' or msg['Type'] == \"Video\" or msg['Type'] == 'Picture' or msg['Type'] == 'Recording':\n        msg_content = msg['FileName']\n        msg['Text'](str(msg_content))\n        print('[Attachment/Video/Picture/Recording]: %s' % msg_content)\n    # 推荐名片\n    elif msg['Type'] == 'Card':\n        msg_content = msg['RecommendInfo']['NickName'] + '的推荐名片，'\n        if msg['RecommendInfo']['Sex'] == 1:\n            msg_content += '性别男。'\n        else:\n            msg_content += '性别女。'\n        print('[Card]: %s' % msg_content)\n    # 位置信息\n    elif msg['Type'] == 'Map':\n        x, y, location = re.search(\"<location x=\\\"(.*?)\\\" y=\\\"(.*?)\\\".*label=\\\"(.*?)\\\".*\", msg['OriContent']).group(1, 2, 3)\n        if location is None:\n            msg_content = r\"纬度:\" + x.__str__() + \", 经度:\" + y.__str__()\n        else:\n            msg_content = r\"\" + location\n        print('[Map]: %s' % msg_content)\n    # 分析的音乐/文章\n    elif msg['Type'] == 'Sharing':\n        msg_content = msg['Text']\n        msg_link = msg['Url']\n        print('[Sharing]: %s' % msg_content)\n    msg_info.update(\n            {\n                msg_id: {\n                    \"msg_from\": msg_from,\n                    \"msg_time_send\": msg_time_send,\n                    \"msg_time_receive\": msg_time_receive,\n                    \"msg_type\": msg[\"Type\"],\n                    \"msg_content\": msg_content,\n                    \"msg_link\": msg_link\n                }\n            }\n        )\n    face_package = msg_content\n\n\n# 监听是否有消息撤回\n@itchat.msg_register(NOTE, isFriendChat=True, isGroupChat=True, isMpChat=True)\ndef monitor(msg):\n    if '撤回了一条消息' in msg['Content']:\n        recall_msg_id = re.search(\"\\<msgid\\>(.*?)\\<\\/msgid\\>\", msg['Content']).group(1)\n        recall_msg = msg_info.get(recall_msg_id)\n        print('[Recall]: %s' % recall_msg)\n        # 表情包\n        if len(recall_msg_id) < 11:\n            itchat.send_file(face_package, toUserName='filehelper')\n        else:\n            msg_prime = '---' + recall_msg.get('msg_from') + '撤回了一条消息---\\n' \\\n                        '消息类型：' + recall_msg.get('msg_type') + '\\n' \\\n                        '时间：' + recall_msg.get('msg_time_receive') + '\\n' \\\n                        r'内容：' + recall_msg.get('msg_content')\n            if recall_msg['msg_type'] == 'Sharing':\n                msg_prime += '\\n链接：' + recall_msg.get('msg_link')\n            itchat.send_msg(msg_prime, toUserName='filehelper')\n            if recall_msg['msg_type'] == 'Attachment' or recall_msg['msg_type'] == \"Video\" or recall_msg['msg_type'] == 'Picture' or recall_msg['msg_type'] == 'Recording':\n                file = '@fil@%s' % (recall_msg['msg_content'])\n                itchat.send(msg=file, toUserName='filehelper')\n                os.remove(recall_msg['msg_content'])\n            msg_info.pop(recall_msg_id)\n\n\nif __name__ == '__main__':\n    if platform.platform()[:7] == 'Windows':\n        itchat.auto_login(enableCmdQR=False, hotReload=True)\n    else:\n        itchat.auto_login(enableCmdQR=True, hotReload=True)\n    itchat.run()\n欢迎关注我的个人公众号：Charles的皮卡丘\n\n                ", "mainLikeNum": ["0 "], "mainBookmarkNum": "0"}