

<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"/><meta name="renderer" content="webkit"/><meta property="qc:admins" content="15317273575564615446375"/><meta property="og:image" content="https://static.segmentfault.com/v-5bebf0aa/global/img/touch-icon.png"/><meta name="viewport"
              content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/><meta name="alexaVerifyID" content="LkzCRJ7rPEUwt6fVey2vhxiw1vQ"/><meta name="apple-itunes-app" content="app-id=958101793, app-argument="><title>Lunar, 一个Python网络框架的实现 - JasonLvpy - SegmentFault 思否</title><meta name="description" content="Lunar是一个Python语言的网络框架，类似于Django，Flask，Tornado等当下流行的web framework。最初有这个想法是在大二下学期，当时接触Python web编程有一段时间。最早接触Python web编程或许是在大一下？自觉当..."/><meta name="keywords" content="wsgi,template-engine,orm,web,python"/><link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="SegmentFault"/><link rel="shortcut icon" href="https://static.segmentfault.com/v-5bebf0aa/global/img/favicon.ico"/><link rel="apple-touch-icon" href="https://static.segmentfault.com/v-5bebf0aa/global/img/touch-icon.png"><meta name="msapplication-TileColor" content="#009a61"/><meta name="msapplication-square150x150logo" content="https://static.segmentfault.com/v-5bebf0aa/global/img/touch-icon.png"/><meta name="baidu_union_verify" content="bcf7fd80dca60d53d46d5b46e1b990ca"><link rel="alternate" type="application/atom+xml" title="SegmentFault 最新问题" href="/feeds/questions"><link rel="alternate" type="application/atom+xml" title="SegmentFault 最新文章" href="/feeds/blogs"><link rel="stylesheet" href="https://static.segmentfault.com/v-5bebf0aa/global/css/global.css"/><link rel="stylesheet" href="https://static.segmentfault.com/v-5bebf0aa/blog/css/blog.css"/><link rel="stylesheet" href="https://static.segmentfault.com/v-5bebf0aa/global/css/responsive.css"/><script type='text/javascript' src='https://sponsor.segmentfault.com/spcjs.php?id=1&block=1&repu=0&tag=wsgi,template-engine,orm,web,python'></script></head><!-- 推荐引擎 --><script charset="utf-8" id="ParadigmSDK" src="https://nbrecsys.4paradigm.com/sdk/js/ParadigmSDK_v2.js" data="216" defSI="594"></script><script>
    ParadigmSDK.init("46e957bd9dea4acdaa15b4b64aff728f");
    ParadigmSDK.trackDetailPageShow();
</script><body data-mod="blog"
    class="blog-post "><!--[if lt IE 9]><div class="alert alert-danger topframe" role="alert">你的浏览器实在<strong>太太太太太太旧了</strong>，放学别走，升级完浏览器再说 <a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div><![endif]--><img id="icon4weChat" style="height: 0;width: 0;" src="https://static.segmentfault.com/v-5bebf0aa/global/img/touch-icon-512.png"><div id="gridMapHoverBox" style="position:absolute; border: 1px solid #009a61; z-index:99; font-size: 10px; background:#fff"></div><div class="global-nav sf-header sf-header--index"><div class="bottom-nav visible-xs visible-sm "><div class="opts"><a class="opts-group " href="/"><i class="fa fa-home" aria-hidden="true"></i><span>首页</span></a><a class="opts-group " href="/questions"><i class="fa fa-comments" aria-hidden="true"></i><span>问答</span></a><a class="opts-group active" href="/blogs"><i class="fa fa-pencil-square" aria-hidden="true"></i><span>专栏</span></a><a class="opts-group " href="/lives"><i class="fa fa-play-circle" aria-hidden="true"></i><span>讲堂</span></a><div class="opts-group"><div class="btn-group dropup"><i class="fa fa-bars dropdown hoverDropdown" data-toggle="dropdown" aria-hidden="true"><span>更多</span></i><ul class="dropdown-menu"><li><a href="/jobs">职位</a></li><li><a href="/events">活动</a></li><li><a href="/tags">标签</a></li><li><a href="/badges">徽章</a></li></ul></div></div></div></div><nav class="container nav"><div class="visible-xs visible-sm header-response"><a href="/search" style="display:block"><i class="fa fa-search" aria-hidden="true"></i></a><div class="sf-header__logo sf-header__logo--response"><h1><a href="/" style="height:24px; background-size: auto 24px;"></a></h1></div><a href="/user/login" class="pull-right login-btn"><i class="fa fa-user" aria-hidden="true"></i></a></div><script>
mobileScroll(
    function(direction) { 
        try {
            if (direction === 'down') {
                document.querySelector('.bottom-nav').classList.add('hidden')
            } else {
                document.querySelector('.bottom-nav').classList.remove('hidden')
            }
        } catch(err) {}
    }
);    
function mobileScroll( fn ) {
    var beforeScrollTop = document.documentElement.scrollTop || document.body.scrollTop,
        fn = fn || function() {};
    window.addEventListener("scroll", function() {
        var afterScrollTop = document.documentElement.scrollTop || document.body.scrollTop,
            delta = afterScrollTop - beforeScrollTop;
        if( delta === 0 ) return false;
        fn( delta > 0 ? "down" : "up" );
        beforeScrollTop = afterScrollTop;
    }, false);
}
</script><div class="row hidden-xs hidden-sm"><div class="col-sm-8 col-md-9 col-lg-9"><div class="sf-header__logo"><h1><a href="/">SegmentFault</a></h1></div><div><ul class="menu list-inline pull-left hidden-xs"><li class="menu__item"><a href="/" class="">首页</a></li><li class="menu__item"><a href="/questions" class="">问答</a></li><li class="menu__item"><a href="/blogs" class="active-nav">专栏</a></li><li class="menu__item"><a href="/lives" class="">讲堂</a></li><li class="menu__item menu__item--more dropdown"><a href="##" class="dropdown-toggle dropdownBtn" data-toggle="dropdown">
                                        发现<i class="fa fa-caret-down" style="font-size: 14px;margin-left: 5px;" aria-hidden="true"></i></a><div class="dropdown-block hidden"><ul class="dropdown-content-menu"><li><a href="/groups">圈子</a></li><li><a href="/events">活动</a></li><li><a href="/tags">标签</a></li><li><a href="/jobs">找工作</a></li><li><a href="/users">排行榜</a></li><li><a href="/badges">徽章</a></li><li><a href="/notes">笔记</a></li><li><a href="https://docs.segmentfault.com" target="_blank">开发手册<i style="line-height: 20px;font-size: 12px;color: #F5A623;" class="ml10 fa fa-external-link-square"></i></a></li><li><a href="https://business.segmentfault.com/ads?utm_source=sf-header" target="_blank">广告投放<i style="line-height: 20px;font-size: 12px;color: #F5A623;" class="ml10 fa fa-external-link-square"></i></a></li></ul></div></li><li class="menu__item visible-sm-inline-block"><a href="/search"><span class="glyphicon glyphicon-search" style="vertical-align: middle;"></span></a></li></ul><form action="/search" class="header-search  hidden-sm hidden-xs pull-right" ><button class="btn btn-link"><span class="sr-only">搜索</span><span class="glyphicon glyphicon-search"></span></button><input id="searchBox" name="q" type="text"  placeholder="搜索问题或关键字" class="form-control" value="" /></form></div></div><div class="col-sm-4 col-md-3 col-lg-3 text-right"><ul class="opts list-inline hidden-xs"><li class="opts__item"><a href="/user/login" class="SFRegister btn-signin" style="margin-bottom:2px;">立即登录</a><a href="/user/register" class="SFLogin ml10 btn-signup"
                                       onClick="_gaq.push(['_trackEvent', 'Button', 'Click', 'Login']);">免费注册</a></li></ul></div></div></nav></div>
    
<input id="articleId" value="1190000002442999" class="hidden" />

<div class="wrap" data-blogid="1200000002442198">
    <div class="container mt15" style="position:relative">
        <div class="row">
            <div class="col-xs-12 col-md-9 main ">
                                <ol class="breadcrumb mb15">
                    <li><a href="/blogs">专栏</a></li>
                                        <li><a href="/blog/jasonlvpy">JasonLvpy</a></li>
                                        <li class="active">文章详情</li>
                </ol>
                                <div class="post-topheader custom- pt0">
                    <div class="mb20">
                        <div class="block-for-right-border">
                            <div class="row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                

                                    <div class="post-topheader__info" data-username="jasonlvhit"
                                         data-userslug="jasonlvpy"
                                         data-useravatar="https://avatar-static.segmentfault.com/113/161/1131611007-549ae2da30256_big64">


                                        <div class="article__author clearfix">
                                            <div class="article__authorleft">
                                                <a href="/u/jasonlvpy">
                                                    <img class="avatar-40" src="https://avatar-static.segmentfault.com/113/161/1131611007-549ae2da30256_big64" alt="jasonlvhit">
                                                </a>
                                            </div>
                                            <div class="article__authorright">
                                                <div class="article__authormeta">
                                                <a href="/u/jasonlvpy" class="mr5 "><strong>jasonlvhit</strong></a>

                                                                                                <img src="https://static.segmentfault.com/v-5bebf0aa/global/img/rp.svg" class="mr5"><span style="color:#BF7158" class="mr10">128</span>

                                                                                                发布于
                                                <a href="/blog/jasonlvpy">JasonLvpy</a>
                                                
                                                
                                                <span class="hidden-xs">
                                                                                                                                                          <button type="button"
                                                               class="btn btn-xs btn-success follow-article ml10"
                                                               data-do="follow"
                                                               data-type="blog"
                                                               data-id="1200000002442198">关注专栏
                                                       </button>
                                                                                                                                                   </span>
                                                </div>
                                                
                                                <span style="display: block">
                                                    2014-12-24 发布
                                                </span>
                                            </div>
                                        </div>

                                        <h1 class="h1 post-topheader__info--title" id="articleTitle" data-id="1190000002442999">
                                            <a href="/a/1190000002442999"> Lunar, 一个Python网络框架的实现</a>
                                        </h1>

                                        <div class="content__tech hidden-xs">
                                            <a href="" class="blog-type-common blog-type-0-before" target="_blank" data-content="
                                                                                        翻译自 
                                                                                        "></a>
                                            
                                            <ul class="taglist--inline inline-block article__title--tag mr10">
                                                                                                    <li class="tagPopup mb5">
                                                        <a class="tag" href="/t/wsgi/blogs" data-toggle="popover"
                                                                                data-img="" data-placement="top"
                                                                                data-original-title="wsgi"
                                                                                data-id="1040000000167134">
                                                                                                                      wsgi
                                                        </a>
                                                    </li>
                                                                                                    <li class="tagPopup mb5">
                                                        <a class="tag" href="/t/template-engine/blogs" data-toggle="popover"
                                                                                data-img="" data-placement="top"
                                                                                data-original-title="template-engine"
                                                                                data-id="1040000000090179">
                                                                                                                      template-engine
                                                        </a>
                                                    </li>
                                                                                                    <li class="tagPopup mb5">
                                                        <a class="tag" href="/t/orm/blogs" data-toggle="popover"
                                                                                data-img="" data-placement="top"
                                                                                data-original-title="orm"
                                                                                data-id="1040000000120279">
                                                                                                                      orm
                                                        </a>
                                                    </li>
                                                                                                    <li class="tagPopup mb5">
                                                        <a class="tag" href="/t/web/blogs" data-toggle="popover"
                                                                                data-img="https://avatar-static.segmentfault.com/337/848/3378480946-1040000000089794_big64" data-placement="top"
                                                                                data-original-title="web"
                                                                                data-id="1040000000089794">
                                                                                                                      web
                                                        </a>
                                                    </li>
                                                                                                    <li class="tagPopup mb5">
                                                        <a class="tag" href="/t/python/blogs" data-toggle="popover"
                                                                                data-img="https://avatar-static.segmentfault.com/378/252/3782524817-1040000000089534_big64" data-placement="top"
                                                                                data-original-title="python"
                                                                                data-id="1040000000089534">
                                                                                                                    <img src="https://avatar-static.segmentfault.com/252/177/2521771040-54cb53b372821_small">
                                                                                                                      python
                                                        </a>
                                                    </li>
                                                                                            </ul>

                                            <span>
                                                3.8k 次阅读
                                                &nbsp;&middot;&nbsp;
                                                读完需要 41 分钟 
                                                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- end .post-topheader -->

                <div class="visible-lg">
                    <div class="side-widget">
                        <div class="stream__item-zan btn btn-default mt0 mb15 ml0 mr0 pt0 pb0 pl0 pr0 " id="side-widget-votes-btn">
                            <span class="stream__item-zan-icon"></span>
                            <span class="stream__item-zan-number" id="side-widget-votes-num">5</span>
                        </div>

                        <i class="fa fa-bookmark item " id="side-widget-bookmarks-btn"></i>
                        <i class="fa fa-weibo item"></i>
                        <i class="fa fa-weixin item" data-toggle="popover" data-placement="right"></i>
                        <i class="fa fa-twitter item"></i>
                        <i class="fa fa-facebook item"></i>
                        <i class="fa fa-arrow-up item hidden"></i>
                    </div>
                </div>

                
                <div class="article fmt article__content" data-id="1190000002442999" data-license="cc">
                    
<p>前前后后，大概两个月的时间，lunar这个项目终于达到了一个很高的完整度。</p>

<p>Lunar是一个Python语言的网络框架，类似于Django，Flask，Tornado等当下流行的web framework。最初有这个想法是在大二下学期，当时接触Python web编程有一段时间。最早接触Python web编程或许是在大一下？自觉当时编程还没有入门，第一个接触的web框架是Django，很庞大的框架，当时很low逼的去看那本Django Book的中文译本，翻译的其实很不错了，只是进度会落后于当前的版本，所以在跑example的时候会有一些问题，Django的庞大规模给我留下了很大的心理阴影，所以在之后，对于涉世未深的Pythoner，我可能都不会推荐Django作为第一个Python的网络框架来学习。</p>

<p>整个框架的挑战还是非常大的。核心的几个组件(模板引擎，ORM框架，请求和应答的处理)还是有一些难度，但是经过一步步的分析和编码还是能够完成功能。项目受Flask非常大的影响，最初作为造轮子的初衷，几乎完整的使用了Flask和SQLAlchemy的API接口。</p>

<p>项目同样开源在Github上: <a rel="nofollow" href="https://github.com/jasonlvhit/lunar"></a><a rel="nofollow" href="https://github.com/jasonlvhit/lunar">https://github.com/jasonlvhit/lunar</a></p>

<p>也可以通过pip直接安装：</p>

<pre><code>$ pip install lunar
</code></pre>

<p>这里我大概的记述一下lunar整个项目的各个组件的设计和实现。</p>

<h2>ORM framework</h2>

<p>首先是ORM。</p>

<p>python圈子里面还是有很多很著名的orm框架，<a rel="nofollow" href="http://www.sqlalchemy.org/">SQLAlchemy</a>，<a rel="nofollow" href="https://github.com/coleifer/peewee">peewee</a>， <a rel="nofollow" href="https://github.com/ponyorm/pony">pony orm</a>各有特色，SQLAlchemy和peewee都已經是很成熟的框架，大量的被应用在商业环境中。回到Lunar，既然是造轮子，何不造个彻底，于是便撸了一个orm框架出来。</p>

<p>在ORM框架中，我们使用类的定义来表示数据库中的表结构，使用类方法避免繁琐的SQL语句，一个ORM类定义类似于下面这段代码：</p>

<pre><code>py</code><code>class Post(db.Model):

    __tablename__ = 'post'

    id = database.PrimaryKeyField()
    title = database.CharField(100)
    content = database.TextField()
    pub_date = database.DateField()

    author_id = database.ForeignKeyField('author')
    tags = database.ManyToManyField(rel='post_tag_re', to_table='tag')

    def __repr__(self):
        return '&lt;Post %s&gt;' % self.title
</code></pre>

<p>上面这段代码取自Lunar框架的<a rel="nofollow" href="https://github.com/jasonlvhit/lunar/tree/master/tests/orm">ORM测试</a>和一个<a rel="nofollow" href="https://github.com/jasonlvhit/lunar/tree/master/examples/blog">博客的example</a>，这段代码定义了一个Post类，代表了数据库中的一张表，类中的一系列属性分别对应着表中的列数据。</p>

<p>一个peewee或者SQLAlchemy类似语法的一个ORM框架语句类似下面这样：</p>

<pre><code>py</code><code>    p = Post.get(id=1)
</code></pre>

<p>返回的结果是Post类的实例，这个实例，p.id返回的不是一个PrimaryKeyField，而是一个int类型值，其他的与数据库关联的类属性也是同样。</p>

<p>orm框架本质上是sql语句或者数据库模式(schema)和python对象之间的转换器或者翻译器，这有些类似于编译器结构。</p>

<p>在这里，Post是我们创建的一个orm类，post拥有若干数据操作方法，通过调用类似这样的更加人性化或者直观的api，代替传统的sql语句和对象映射。orm框架将语句翻译为sql语句，执行，并在最后将语句转换为post类的实例。</p>

<p>可能从这个角度看来，实现orm框架并不是什么tough的任务，让我们用上面提到的这个例子来看</p>

<pre><code>py</code><code> p = Post.get(id=1)
</code></pre>

<p>这条语句翻译成的sql语句为</p>

<pre><code>select * from post where id=1;
</code></pre>

<p>可以看到的是，get方法会使用一个select语句，翻译程序将post类的表名和条件分别组合到select语句中，嗅觉灵敏的pythoner会发现这是一个典型的Post类的classmethod，直接通过类来调用这个方法，我们可以快速的写出这个函数的伪代码:</p>

<pre><code>py</code><code>class Model(Meta):

    ...

    @classmethod
    def get(cls, *args, **kwargs):
        # get method only supposes to be used by querying by id.
        # UserModel.get(id=2)
        # return a single instance.
        sql = "select * from %s"
        if kwargs:
            sql += "where %s"
        rs = db.execute(sql %(cls.__tablename__, ' and '.join(['='.join([k, v]) 
            for k, v in kwargs.items()])))
        return make_instance(rs, descriptor) #descriptor describe the format of rs.

</code></pre>

<p>从本质上，所有的翻译工作都可以这样来完成。但是在重构后的代码中可能会掩盖掉很多细节。</p>

<p>其实這大概是实现一个orm框架的全部了，只是我们还需要一点python中很酷炫的一个编程概念来解决一个问题。</p>

<p>考虑实现ORM框架的create_all方法，创建所有ORM框架规范下类的实际数据库表，这是熟悉SQLAlchemy的Pythoner都会比较熟悉的一个方法。</p>

<p>create_all方法要求所有继承了db.Model类的子类全部注册在db的一个属性中，比如<strong>tabledict</strong>，这样create_all方法在调用时可以使用db中的<strong>tabledict</strong>属性，将所有注册的类编译为SQL语句并执行。</p>

<p>直观的来看，我们需要控制类创建的行为。例如Post类，在这个类被创建的时候，将Post类写入<strong>tabledict</strong>。</p>

<p>那么怎么控制一个类被创建的时候的行为？答案是使用元编程，Python中有多种实现元编程的方式，descriptor或者metaclass等方式都是实现元编程的方式，在这里，我们使用元类(metaclass)。关于metaclass，网络上最经典的文章莫过于StackOverflow上的<a rel="nofollow" href="http://stackoverflow.com/questions/100003/what-is-a-metaclass-in-python/6581949#6581949">这篇回答</a>，强烈推荐给所有的人看。这里我先直接给出伪码：</p>

<pre><code>py</code><code>class MetaModel(type):
    def __new__(cls, name, bases, attrs):
        cls = super(MetaModel, cls).__new__(cls, name, bases, attrs)

        ...

        cls_dict = cls.__dict__
        if '__tablename__' in cls_dict.keys():
            setattr(cls, '__tablename__', cls_dict['__tablename__'])
        else:
            setattr(cls, '__tablename__', cls.__name__.lower())

        if hasattr(cls, 'db'):
            getattr(cls, 'db').__tabledict__[cls.__tablename__] = cls

        ...

        return cls

class Model(MetaModel('NewBase', (object, ), {})): #python3 compatibility
    def __init__(self, **kwargs):

        ...

        for k, v in kwargs.items():
            setattr(self, k, v))

        ...

</code></pre>

<p>这种方式定义的Model，在创建的时候，会由MetaModel控制创建过程，最后返回整个类，在创建过程中，我们将表名称和类本身全部塞入了db的一个属性中。这样create_all方法便可以直接使用tabledict中的类属性直接创建所有的表：</p>

<pre><code>py</code><code>class Database(threading.local):
    ...

    def create_all(self):
        for k, v in self.__tabledict__.items():
            if issubclass(v, self.Model):
                self.create_table(v)
</code></pre>

<p>OK,到这里，几乎ORM的所有核心技术全部介绍完毕。ORM并不是一个很tough的工作，但是也并不是很简单。ORM框架的实现是一个解决一系列问题的过程，其实思考的过程是最为激动人心的。</p>

<h2>模板引擎</h2>

<p>模板引擎是另外一个比较大和tough的模块。Python同样有很多出色的模板引擎，当下最为流行莫过于<a rel="nofollow" href="http://www.makotemplates.org/">Mako</a>和<a rel="nofollow" href="https://github.com/mitsuhiko/jinja2">Jinja2</a>，国外的Reddit和国内的豆瓣公司大量的使用了Mako作为模板引擎进行网页渲染。Jinja2因为具有强大的性能支撑和沙箱模式，在Python社区中也很流行。</p>

<p>Python模板引擎的核心功能是把标记语言编译成为可执行的代码，执行一些逻辑或者操作，返回模板文件的渲染结果，往往是字符串。模板引擎的实现同样类似于传统的编译器结构，模板引擎首先会使用一个词法分析模块分析出所有的token，并分类标记；在这之后，会使用一个类似于编译器中的语法分析的模块分析token序列，调用相应的操作，对于不同的token，我们需要单独编写一个处理程序(类似于SDT)，来处理token的输出。</p>

<p>最简单的例子：</p>

<pre><code>py</code><code>    t = lunar.Template('Hello {{ name }}').render(name='lunar')
</code></pre>

<p>这段代码，我们期待的输出是"Hello lunar"，name会被lunar替换掉。根据上面我提到的模板引擎的工作流程，首先，我们使用词法分析程序对这段模板语言做模板编译，分割所有的字符串(实际实现的时候并非如此)，给每个单词赋给一个属性，例如上面这段模板语言经过最基础的词法分析会得到下面这个结果：</p>

<pre><code>&lt;'Hello' PlainText&gt;
&lt;' ' Operator&gt; # Blank Space
&lt;'name' Variable&gt; 

</code></pre>

<p>有了“词法分析”得到的序列，我们开始遍历这个序列中的所有token，对每一个token进行处理。</p>

<pre><code>py</code><code>for token in tokens:
    if isinstance(token, PlainText):
        processPlainText(token)
    elif isinstance(token, Variable):
        processVariable(token)

    ...

</code></pre>

<p>一些模板引擎将模板标记语言编译为Python代码，使用<strong>exec</strong>函数执行，最后将结果嵌套回来。例如上面这段代码，我们可以依次对token进行类似下面这样的处理：</p>

<pre><code>py</code><code>def processPlainText(token):
    return "_stdout.append('" +token+ "')"

def processVariable(token):
    return "_stdout.append(" + token +")"
</code></pre>

<p>看到这里你可能会觉得莫名其妙，对于一连串的token序列，经过处理后的字符串类似于下面这样，看完后你的状态肯定还是莫名其妙：</p>

<pre><code>py</code><code>intermediate = ""
intermediate += "_stdout.append('Hello')"
intermediate += "_stdout.append(' ')"
intermediate += "_stdout.append(name)"
</code></pre>

<p>回到上面提到的那个函数exec，我们<strong>使用exec函数执行上面的这段字符串</strong>，这在本质上其实是一种很危险的行为。exec函数接受一个命名空间，或者说上下文(context)参数，我们对这段代码做类似下面的处理：</p>

<pre><code>py</code><code>context = {}
context['_stdout'] = []
context['name'] = 'lunar'

exec(intermediate, context)

return ''.join(context['_stdout'])
</code></pre>

<p>context是一个字典，在真正的模板渲染时，我们把所有需要的上下文参数全部update到context中，传给exec函数进行执行，exec函数会在context中进行更改，最后我们可以取到context中经过修改后的所有的值。在这里，上面两个代码片段中的_stdout在context中作为一个空列表存在，所以在执行完exec后，context中的stdout会带回我们需要的结果。</p>

<p>具体来看，将render中的context传入exec，这里exec会执行一个变换：</p>

<pre><code>_stdout.append(name) -&gt; exec(intermediate, {name:'lunar'}) -&gt; _stdout.append('lunar')
</code></pre>

<p>经过这个神奇的变化之后(搞毛，就是替换了一下嘛)，我们就得到了模板渲染后需要的结果，一个看似是标记语言执行后的结果。</p>

<p>让我们看一个稍微复杂一些的模板语句，比如if...else...，经过处理后的中间代码会类似于下面这样:</p>

<pre><code>&lt;html&gt;
{% if a &gt; 2 %}
    {{ a }}
{% else %}
    {{ a * 3 }}
{% endif %}
&lt;/html&gt;
</code></pre>

<p>中间代码：</p>

<pre><code>py</code><code>intermediate = "_stdout.append('&lt;html&gt;')\n"
intermediate += "if a &gt; 2 :\n"
intermediate += "   _stdout.append(a)\n"
intermediate += "else :\n"
intermediate += "   _stdout.append(a * 3)\n"
intermediate += "_stdout.append('&lt;/html&gt;')"
</code></pre>

<p>注意中间代码中的缩进！这是这一类型的模板引擎执行控制流的所有秘密，这段代码就是原生的Python代码，可执行的Python代码。模板引擎构建了一个从标记语言到Python原生语言的转换器，所以模板引擎往往能够做出一些看似很吓人，其实很low的功能，比如直接在模板引擎中写lambda函数：</p>

<pre><code>py</code><code>from lunar.template import Template

rendered = Template(
            '{{ list(map(lambda x: x * 2, [1, 2, 3])) }}').render()
</code></pre>

<p>但是！深入优化后的模板引擎往往没有这么简单，也不会使用这么粗暴的实现方式，众多模板引擎选择了自己写解释程序。把模板语言编译成AST，然后解析AST，返回结果。这样做有几点好处：</p>

<ul>
<li>自定义模板规则</li>
<li>利于性能调优，比如C语言优化</li>
</ul>
<p>当然，模板引擎界也有桑心病狂者，使用全部的C来实现，比如同样很有名的Cheetah。</p>

<p>或许因为代码很小的原因，我在Lunar中实现的这个模板引擎在多个benchmark测试下展现了还不错的性能，具体的benchmark大家可以在项目的template测试中找到，自己运行一下，这里给出一个基于我的机器的性能测试结果：</p>

<p>第一个结果是<a rel="nofollow" href="https://code.google.com/p/spitfire/source/browse/trunk/tests/perf/bigtable.py">Jonas BorgstrOm为SpitFire所写的benchmarks</a>：</p>

<pre><code>Linux Platform
-------------------------------------------------------
Genshi tag builder                            239.56 ms
Genshi template                               133.26 ms
Genshi template + tag builder                 261.40 ms
Mako Template                                  44.64 ms
Djange template                               335.10 ms
Cheetah template                               29.56 ms
StringIO                                       33.63 ms
cStringIO                                       7.68 ms
list concat                                     3.25 ms
Lunar template                                 23.46 ms
Jinja2 template                                 8.41 ms
Tornado Template                               24.01 ms
-------------------------------------------------------

Windows Platform
-------------------------------------------------------
Mako Template                                 209.74 ms
Cheetah template                              103.80 ms
StringIO                                       42.96 ms
cStringIO                                      11.62 ms
list concat                                     4.22 ms
Lunar template                                 27.56 ms
Jinja2 template                                27.16 ms
-------------------------------------------------------
</code></pre>

<p>第二个结果是Jinja2中mitsuhiko的benchmark测试：</p>

<pre><code>    Linux Platform:
    ----------------------------------
    jinja               0.0052 seconds
    mako                0.0052 seconds
    tornado             0.0200 seconds
    django              0.2643 seconds
    genshi              0.1306 seconds
    lunar               0.0301 seconds
    cheetah             0.0256 seconds
    ----------------------------------

    Windows Platform:
    ----------------------------------
    ----------------------------------

    jinja               0.0216 seconds
    mako                0.0206 seconds
    tornado             0.0286 seconds
    lunar               0.0420 seconds
    cheetah             0.1043 seconds
    -----------------------------------
</code></pre>

<p>这个结果最吸引我的有下面几点：</p>

<ul>
<li>Jinja2真(TM)快！</li>
<li>Django真慢！</li>
<li>Mako的实现肯定有特殊的优化点，不同的benchmark差距过大！</li>
</ul>
<p>现在Lunar的代码还很脏，而且可以重构的地方还很多，相信重构后性能还会上一个台阶(谁知道呢？)。</p>

<h2>Router</h2>

<p>Router负责整个web请求的转发，将一个请求地址和处理函数匹配在一起。主流的Router有两种接口类型，一种是Django和Tornado类型的"字典式":</p>

<pre><code>py</code><code>url_rules = {
    '/': index,
    '/post/\d': post,
}
</code></pre>

<p>另外一种是Flask和Bottle这种小型框架偏爱的装饰器(decorator)类型的router：</p>

<pre><code>py</code><code>@app.route('/')
def index():
    pass

@app.route('/post/&lt;int:id&gt;')
def post(id):
    pass

</code></pre>

<p>router的实现还是很简单的，router的本质就是一个字典，把路由规则和函数连接在一起。这里有一些麻烦的是处理带参数的路由函数，例如上例中，post的id是可以从路由调用地址中直接获得的，调用/post/12会调用函数post(12)，在这里，传参是较为麻烦的一点。另外的一个难点是redirect和url_for的实现:</p>

<pre><code>py</code><code> return redirect(url_for(post, 1))
</code></pre>

<p>但其实也不难啦，感兴趣的可以看一下代码的实现。</p>

<p>Router的另外一个注意点是，使用装饰器方式实现的路由需要在app跑起来之前，让函数都注册到router中，所以往往需要一些很奇怪的代码，例如我在Lunar项目的example中写了一个blog，blog的<strong>init</strong>文件是像下面这样定义的：</p>

<pre><code>py</code><code>from lunar import lunar
from lunar import database

app = lunar.Lunar('blog')
app.config['DATABASE_NAME'] = 'blog.db'

db = database.Sqlite(app.config['DATABASE_NAME'])

from . import views
</code></pre>

<p>注意最后一行，最后一行代码需要import views中的所有函数，这样views中的函数才会注册到router中。这个痛点在Flask中同样存在。</p>

<h2>WSGI</h2>

<p>最后的最后，我们实现了这么多组件，我们还是需要来实现Python请求中最核心和基本的东西，一个WSGI接口：</p>

<pre><code>py</code><code>def app(environ, start_response):
     start_response('200 OK', [('Content-Type', 'text/plain')])
     yield "Hello world!\n"
</code></pre>

<p>WSGI接口很简单，实现一个app，接受两个参数environ和start_response，想返回什么就返回什么好了。关于WSGI的详细信息，可以查看<a rel="nofollow" href="https://www.python.org/dev/peps/pep-0333/">PEP333</a>和<a rel="nofollow" href="http://legacy.python.org/dev/peps/pep-3333/">PEP3333</a>。这里我说几点对WSGI这个东西自己的理解：</p>

<p><strong>计算机服务，或者说因特网服务的核心是什么？现在的我，会给出协议这个答案。我们会发现，计算机的底层，网络通信的底层都是很简单、很朴素的东西，无非是一些0和1，一些所谓字符串罢了。去构成这些服务，把我们连接在一起的是我们解释这些朴素的字符串的方式，我们把它们称为协议</strong>。</p>

<p>WSGI同样是一个协议，WSGI最大的优势是，所有实现WSGI接口的应用均可以运行在WSGI server上。通过这种方式，实现了Python WSGI应用的可移植。Django和Flask的程序可以混编在一起，在一个环境上运行。在我实现的框架Lunar中，使用了<a rel="nofollow" href="https://github.com/jasonlvhit/lunar/blob/master/lunar/server.py">多种WSGI server</a>进行测试。</p>

<p>在一些文章中，把类似于router，template engine等组件，包装在网络框架之中，WSGI应用之上的这些组件成为WSGI中间件，得益于WSGI接口的简单，编写WSGI中间件变得十分简单。在这里，最难的问题是如何处理各个模块的解耦。</p>

<p>考虑之前提到的模板引擎和ORM framework的实现，模板引擎和数据库ORM都需要获取应用的上下文(context)，这是实现整个框架的难点。也是项目未来重构的核心问题。</p>

<h2>结</h2>

<p>现在代码之烂是让我无法忍受的。最近开始读两本书，<a rel="nofollow" href="http://book.douban.com/subject/4199741/">代码整洁之道</a>和<a rel="nofollow" href="http://book.douban.com/subject/4262627/">重构</a>，自己在处理大型的软件体系，处理很多设计模式的问题的时候还是很弱逼。首先会拿模板引擎开刀，我有一个大体重构的方案，会很快改出来，力争去掉parser中的大条件判断，并且尝试做一些性能上的优化。</p>

<p>Lunar是一个学习过程中的实验品，这么无聊，总是要写一些代码的，免得毕业后再失了业。</p>

<p>在最后，还是要感谢亮叔<a rel="nofollow" href="https://github.com/skyline75489"></a><a rel="nofollow" href="https://github.com/skyline75489">https://github.com/skyline75489</a>，亮叔是我非常崇拜的一个Pythoner，或者说coder，一名天生的软件工匠。没有他这个项目不会有这么高的完整度，他改变了我对这个项目的态度。</p>

                </div>
                                                
                <div class="clearfix mt10">
                    <ul class="article-operation list-inline pull-left mt15"><li><a target="_blank"href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><img class="mb5" src="https://static.segmentfault.com/v-5bebf0aa/global/img/creativecommons-cc.svg" height="20"/></a></li><li class="dropdown js__content-ops hidden-xs" data-module="article"
                                data-id="1190000002442999"
                                data-typetext="文章"><a href="javascript:void(0);" class="dropdown-toggle text-muted" data-toggle="dropdown"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></a><ul class="dropdown-menu dropdown-menu-left"><li><a href="#911"
                                           data-toggle="modal"
                                           data-target="#911"
                                           data-action="report"
                                        >举报</a></li></ul></li></ul>
                    <div class="pull-right mt-10 hidden-xs">
                        <div class="widget-share__full" data-text="Lunar, 一个Python网络框架的实现"
 data-url="https://segmentfault.com/a/1190000002442999" data-shorturl="http://sfau.lt/b5kpHn"></div>


                    </div>
                </div>
                <div class="mt10 text-center mb30"><button type="button" id="mainLike" data-id="1190000002442999"
                                    class="btn btn-success btn-lg mr15 "><span id="mainLikeText">赞</span>&nbsp;&nbsp;<span class="seprator">|</span>&nbsp;&nbsp;
                                <span id="mainLikeNum">5 </span></button><button type="button" id="mainBookmark" data-type="article" data-id="1190000002442999"
                                    class="btn btn-default btn-lg "><span id="mainBookmarkText">收藏</span>&nbsp;&nbsp;<span class="seprator">|</span>&nbsp;&nbsp;<span id="mainBookmarkNum">18</span></button></div>                
                                <script type='text/javascript'>
                    OA_show(3);
                </script>

                <h4 class="pt20 mb15 mt0 border-top">你可能感兴趣的</h4>

                
                <div class="mb15 block">
                    <script type='text/javascript'>
                        OA_show(4);
                    </script>
                </div>

                                <div id="paradigm-article-related"></div>

                
        <div class="comments--news comments--default comments--article 
    " 
    data-id="1190000002442999" data-user-id="" data-author-id="1030000000392202 "
         data-is-admin="null" id="goToReplyArea">
                    <div class="mb10 clearfix">
                <strong class="comments-stat pull-left mr10">1 条评论</strong>

                                                    <div class="btn-group btn-group-xs pull-right comments-sort btn-group-menu" role="menu">
                        <a href="javascript:;" 
                           class="btn btn-default active" data-sort="default">默认排序</a>
                        <a href="javascript:;" 
                           class="btn btn-default" data-sort="desc">时间排序</a>
                    </div>
                            </div>
                <div class="comments-container">
                                <div class="comments-list">
                <div class="comments-item" data-id="1050000008338840">
            <div class="pull-left">
                <a href="/u/air_58a0839a58de9" target="_blank"><img class="avatar-32 " src="https://avatar-static.segmentfault.com/296/074/2960743406-58a12775218dc_big64" alt=""></a>
            </div>
            <div class="comments-content">
                <div class="comment-trigger">
                    <div class="pull-right comment-option">
                                                <a href="#911" class="ml10" data-toggle="modal" data-target="#911" data-action="report" data-action-text="举报" data-module="comment" data-id="1050000008338840" data-typetext="评论" data-placement="top" title="举报"><span class="glyphicon glyphicon-flag" aria-hidden="true"></span></a>
                                            </div>
                    <strong><a target="_blank" href="/u/air_58a0839a58de9">艾爔</a></strong>
                    <span class="comments-isAuthor hide"></span>
                    <span class="comments-date">  ·  2017年02月13日</span>
                </div>

                <div class="fmt mb10"><p>学习了。正在山寨中</p></div>

                <form action="/api/comment/1050000008338840/edit">
                    <div class="form-group">
                        <textarea class="editTextarea mono form-control mb10 hidden" rows="1" name="text" style="height: 28px; overflow: hidden; word-wrap: break-word;" >学习了。正在山寨中</textarea>
                    </div>
                </form>

                <p class="comment-ops not-reply">
                    <span class="comments-zan ">
                        <i class="fa fa-thumbs-up mr4" aria-hidden="true"></i>
                        <span class="comments-zan-text">赞</span>
                        <span class="comments-zan-value"></span>
                    </span>
                    
                    <span class="ml15 comments-reply-btn">回复</span>

                    <span class="pull-right editBtns hidden">
                      <button class="btn btn-link btn-xs cancel" type="button">取消</button>
                      <button class="btn btn-primary btn-xs edit ml10" type="button">保存</button>
                    </span>
                </p>

                <div class="reply-list reply-list--empty">

                    
                    <div class="reply-item reply-item--ops" data-obj="obj">
                        <a class="reply-inner-btn" href="javascript:;">添加回复</a>
                        
                    </div>
                </div>


            </div>
        </div>
            </div>
    <div class="comments-loading hide">载入中...</div>
        <div class="comments-more hide"><a href="javascript:;">显示更多评论</a></div>
    

                                    <div class="comments-box" id="goToReplyEditor">
                <div class="pull-left">
                    <img class="avatar-32 "
                         src="https://static.segmentfault.com/v-5bebf0aa/global/img/user-128.png"
                         alt=""/>
                </div>
                <div class="comments-box-content">
                    <form action="/api/article/1190000002442999/comments/add">
                        <div class="form-group mb0">
                            <textarea name="text" rows="3" class="form-control"placeholder="文明社会，理性评论"></textarea>
                            <div class="mt15 text-right">
                                <button type="button" class="hide"></button>
                                <button class=" btn btn-primary" type="button">发布评论</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
                                                        </div>
    </div>


                                    
                
                

            </div><!-- /.main -->


            <div class="col-md-3 side hidden-sm hidden-xs mt30">
                                                
                <div class="mb25 hidden-md hidden-sm hidden-xs">
    <img src="https://static.segmentfault.com/sponsor/20181120.png" alt="Planets" usemap ="#gridsMap" width=255 height=136>
    <map name="gridsMap" id="gridsMap"></map>
    <div style="text-align: center;"><a style="text-align:center; color:#9E9E9E; font-size:12px" href="/sponsor">想在上方展示你的广告？</a></div>
            <script async src="https://static.segmentfault.com/sponsor/20181120.js"></script>
    </div>

                                <style>
                    .job-recommend-area a:not(:last-of-type) {margin-bottom:10px; display: block}
                    .job-recommend-area a:hover {text-decoration: none;}
                </style>
                <div class="hidden-md">
                    <div class="job-recommend">
                      <h3 class="job-title">推广链接</h3>
                      <div class="job-recommend-area">
                                                <script type='text/javascript'>
                            OA_show(7);
                            OA_show(9);
                            OA_show(10);
                            OA_show(15);
                            OA_show(16);
                        </script>
                      </div>
                    </div>
                    <style>
                    .job-recommend {margin-bottom: 30px;}
                    .job-title {
                        font-size: 14px;
                        color: #017E66;
                        font-weight: 500;
                        background: #BFE6D7;
                        margin: 0;
                        padding-top: 6px;
                        padding-bottom: 6px;
                        text-align: center;
                    }
                    .job-recommend-area {
                      padding: 13px;
                      border: 3px solid #EBF7F3;
                      border-top: none;
                    }
                    </style>
                    
                                    </div>

                                
                <div class="hidden-md ad-should-be-fixed">
                    <div class="mb25 block">
                        <script type='text/javascript'>
                            OA_show(1);
                        </script>
                    </div>
                </div>
                <div class="post-nav hidden-xs">
                    <div class="panel panel-default widget-outline">
                        <div class="panel-heading">目录</div>
                        <div class="panel-body">
                            <div class="nav-body" style="overflow:scroll">
                                <div class="highlight-title"></div>
                                <ul class="articleIndex"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                
            </div><!-- /.side -->
        </div>
    </div>
</div>

<div id="shareToWeiboModal" class="modal" tabindex='-1'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">×</span><span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title">分享</h4>
            </div>
            <div class="modal-body">
                <p class="sfModal-content">
                    分享到微博？
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default dont-likeweibo" data-dismiss="modal">取消</button>
                <a href="" id="shareLink" class="btn btn-primary done-btn" target="_blank"
                   onclick="$('#shareToWeiboModal').modal('hide')">分享</a>
            </div>
        </div>
    </div>
</div>


<div class="modal widget-911" id="911" tabindex='-1'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button class="close" data-dismiss="modal" type="button">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <h4 class="modal-title"><span data-model="action"></span><span data-model="type"></span></h4>
      </div>
      <div class="modal-body">
        <form id="reportForm">
          <!-- 后台返回信息 -->
          <p class="alert alert-warning" data-model="returnMsg"></p>
          <div data-role="base">
            <p>
              <strong class="required">我要<span data-model="action"></span>该<span data-model="type"></span>，理由是：</strong>
            </p>
            <ul class="list-unstyled" data-model="list"></ul>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default pull-left" type="button" data-role="back" style="display:none">返回重选</button>
                <button class="btn btn-default" data-dismiss="modal" type="button">取消</button>
        <button class="btn btn-primary" data-role="submit" type="button">提交</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="modal widget-seo" id="seo" tabindex='-1'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title"><span data-model="action"></span><span data-model="type"></span></h4>
            </div>
            <div class="modal-body">
                <form id="seoForm">
                    <!-- 后台返回信息 -->
                    <p class="alert alert-warning" data-model="returnMsg"></p>
                    <div data-role="base">
                        <div class="form-group">
                            <label>SEO标题：</label><textarea style="min-height: 35px; width: 100%; max-height: 132px; overflow: hidden; overflow-wrap: break-word; height: 32px;" name="title" class="form-control" rows="1" placeholder="请输入SEO标题"></textarea>
                        </div>
                        <div class="form-group">
                            <label>SEO描述：</label><textarea style="min-height: 35px; max-height: 132px; overflow: hidden; overflow-wrap: break-word; height: 32px;" name="desc" class="form-control" rows="1" placeholder="请输入SEO描述"></textarea>
                        </div>
                        <div class="form-group">
                            <label>SEO keywords：</label><textarea style="min-height: 35px; max-height: 132px; overflow: hidden; overflow-wrap: break-word; height: 32px;" name="keywords" class="form-control" rows="1" placeholder="请输入SEO keywords"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal" type="button">取消</button>
                <button class="btn btn-primary" data-role="submit" type="button">提交</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

    <div id="loginBanner"  class="hidden-sm hidden-xs loginBanner">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 col-md-7">
                <h1 class="title">在 SegmentFault，学习技能、解决问题</h1>
                <p class="desc">每个月，我们帮助 1000 万的开发者解决各种各样的技术问题。并助力他们在技术能力、职业生涯、影响力上获得提升。</p>
            </div>
            <div class="col-lg-3 col-lg-offset-3 col-md-4 col-md-offset-1">
                <form class="register-form clearfix" action="/api/user/phone/register">

                    
                    <a href="/user/register" class="SFLogin btn btn-lg btn-primary mr15">免费注册</a>
                    <a href="/user/login" class="SFRegister btn btn-lg btn-primary">立即登录</a>
                </form>
            </div>
        </div>
    </div>
    </div>






<footer id="footer">
    <div class="container">
        <div class="row hidden-xs">
            <dl class="col-sm-2 site-link">
                <dt>产品</dt>
                
                <dd><a href="/questions/hottest?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=热门问答">热门问答</a></dd>
                <dd><a href="/blogs/hottest?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=热门专栏">热门专栏</a></dd>
                <dd><a href="/lives?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=热门讲堂">热门讲堂</a></dd>
                <dd><a href="/events?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=最新活动">最新活动</a></dd>
                <dd><a href="/groups?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=圈子">圈子</a></dd>
                <dd><a href="/jobs?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=找工作">找工作</a></dd>
                <dd><a href="/app?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=app">移动客户端</a></dd>
                
            </dl>
            
            <dl class="col-sm-2 site-link">
                <dt>资源</dt>
                <dd><a href="/weekly?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-weekly&utm_term=每周精选">每周精选</a></dd>
                <dd><a href="/users?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-users&utm_term=用户排行榜">用户排行榜</a></dd>
                <dd><a href="/badges?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-badges&utm_term=徽章">徽章</a></dd>
                <dd><a href="/faq?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-faq&utm_term=帮助中心">帮助中心</a></dd>
                <dd><a href="/repu?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-repu&utm_term=声望与权限">声望与权限</a></dd>
                <dd><a href="/community?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-community&utm_term=社区服务中心">社区服务中心</a></dd>
                <dd><a href="https://docs.segmentfault.com?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-docs&utm_term=开发手册">开发手册</a></dd>

   
            </dl>

            <dl class="col-sm-2 site-link">
                <dt>商务</dt>
                <dd><a href="https://business.segmentfault.com/services?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-services-rencai&utm_term=人才服务" target="_blank">人才服务</a></dd>
                <dd><a href="https://business.segmentfault.com/services?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-services-qiyeneixun&utm_term=企业服务" target="_blank">企业培训</a></dd>
                <dd><a href="https://business.segmentfault.com/services?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-services-huodongcehua&utm_term=活动策划" target="_blank">活动策划</a></dd>
                <dd><a href="https://business.segmentfault.com/ads?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-ads&utm_term=广告投放" target="_blank">广告投放</a></dd>
                <dd><a href="https://business.segmentfault.com/bc?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-bc&utm_term=区块链解决方案" target="_blank">区块链解决方案</a></dd>
                <dd><a href="https://business.segmentfault.com/contact?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-contact&utm_term=合作联系" target="_blank">合作联系</a></dd>
            </dl>
            
            <dl class="col-sm-2 site-link">
                <dt>关于</dt>
                <dd><a href="https://about.segmentfault.com/?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=about&utm_content=about-index&utm_term=关于我们">关于我们</a></dd>
                <dd><a href="https://about.segmentfault.com/careers.html?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=about&utm_content=about-careers&utm_term=加入我们">加入我们</a></dd>
                <dd><a href="https://about.segmentfault.com/contact.html?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=about&utm_content=about-contact&utm_term=联系我们">联系我们</a></dd>
            </dl>

            <dl class="col-sm-2 site-link">
                <dt>关注</dt>
                                <dd><a href="//segmentfault.com/blog/segmentfault" target="_blank">产品技术日志</a></dd>
                                <dd><a href="//segmentfault.com/blog/community_admin" target="_blank">社区运营日志</a></dd>
                                <dd><a href="//segmentfault.com/blog/segmentfault_news" target="_blank">市场运营日志</a></dd>
                                <dd><a href="//segmentfault.com/blog/segmentfault_team" target="_blank">团队日志</a></dd>
                                <dd><a href="//segmentfault.com/blog/interview" target="_blank">社区访谈</a></dd>
                                <dd>
                    <ul class="sn-inline">
                        <li>
                            <a class="entypo-wechart icon-sn-weixin weixin-popover-qrcode" data-toggle="popover" data-placement="top"  data-content="">微信</a>
                        </li>
                        <li>
                            <a href="http://weibo.com/segmentfault" target="_blank" class="entypo-weibo icon-sn-weibo" >新浪微博</a>
                        </li>
                        <li>
                            <a href="https://github.com/SegmentFault" target="_blank" class="entypo-facebook icon-sn-github">Github</a>
                        </li>
                        <li>
                            <a href="https://twitter.com/segment_fault" target="_blank" class="entypo-twitter icon-sn-twitter">Twitter</a>
                        </li>
                    </ul>
                </dd>
            </dl>

            <dl class="col-sm-2 site-link" id="license">
                <dt>条款</dt>
                <dd><a href="/tos">服务条款</a></dd>
                <dd><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">内容许可</a></dd>
                <dd>
                    <a href="/app" class="clearfix mt10 block"><img src="https://static.segmentfault.com/v-5bebf0aa/page/img/app/appQrcode.png" class="app-qrcode"></a>
                    <div class="app-download-desc">
                        <p>扫一扫下载 App</p>
                    </div>
                    
                </dd>
            </dl>
        </div>
        <div class="copyright">
            Copyright &copy; 2011-2018 SegmentFault. 当前呈现版本 17.06.16<br>
            <a href="http://www.miibeian.gov.cn/" rel="nofollow">浙ICP备 15005796号-2</a> &nbsp;
            <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010602002000" rel="nofollow">浙公网安备 33010602002000号</a>
            <span class="ml5">杭州堆栈科技有限公司版权所有</span>
            <P class="mt30">CDN 存储服务由 <a target="_blank" href="https://www.upyun.com/?utm_source=segmentfault&utm_medium=link&utm_campaign=upyun&md=segmentfault">又拍云</a> 赞助提供 </p>
        </div>
        <p class="text-center">
            <a class="js__view--selector hidden-sm hidden-md hidden-lg" data-action="mobile" href="javascript:;">移动版</a>
            <a class="js__view--selector hidden-sm hidden-md hidden-lg" data-action="desktop" href="javascript:;">桌面版</a>
        </p>
    </div>
</footer>

<div id="fixedTools" class="hidden-xs hidden-sm">
    <a id="backtop" class="hidden border-bottom" href="#">回顶部</a>
</div>

    <script id="loginModal" type="text/template">
    <div class="row bg-white login-modal">
        <div class="col-md-12 login-wrap">
            <form action="/api/user/login" method="POST" role="form" class="mt15">
                <div class="form-group hidden">
                                        <input type="text" class="form-control" name="remember" value="1"
                           autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="username" class="control-label">手机号 或 Email</label>
                    <input type="text" class="form-control" name="username" tabindex="1" required placeholder="11 位手机号 或 Email"
                           autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="control-label">密码</label><span class="pull-right"><a
                                href="/user/forgot" tabindex="4">忘记密码</a></span>
                    <input type="password" class="form-control" name="password" tabindex="2" required placeholder="请输入密码">
                </div>
                <div class="form-group">
                    <a
                            
                                                    href="/user/phoneLogin"
                            class="phoneLogin"
                                            >手机验证码登录</a>
                </div>
                <div class="form-group clearfix">
                    <button type="submit" class="btn-block btn btn-primary pull-right pl20 pr20" tabindex="3"
                            onclick='ga("send", "event", "email login button", "clicked", "login modal");'>登录
                    </button>
                </div>
            </form>
            <div class="text-muted text-center more-login-area">
    <span class="more-login-words">更多登录方式</span>
</div>
<div class="widget-login mb15 text-center">
    <a href="/user/oauth/google" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "google"});'><span
                class="icon-sn-google"></span></a>
    <a href="/user/oauth/github" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "github"});");'><span
                class="icon-sn-github"></span></a>
    <a href="/user/oauth/weibo" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "weibo"});'><span
                class="icon-sn-weibo"></span></a>
    <a href="/user/oauth/qq" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-qq"></span></a>
    <a href="/user/oauth/weixin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-weixin"></span></a>
    <a href="/user/oauth/linkedin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "linkedin"});'><span
                class="icon-sn-linkedin"></span></a>
    <span id="loginShowMore" style="cursor: pointer" class="mb5"><span class="icon-sn-dotted"></span></span>
    <a href="/user/oauth/twitter" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "twitter"});'><span
                class="icon-sn-twitter"></span></a>
    <a href="/user/oauth/facebook" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "facebook"});'><span
                class="icon-sn-facebook"></span></a>
    <a href="/user/oauth/douban" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "douban"});'><span
                class="icon-sn-douban"></span></a>
</div>
<div class="form-group clearfix">
    <a class="btn-block btn btn-default pull-right pl20 pr20 
                        SFLogin
             "

            
        onclick='ga("send", "event", "email login button", "clicked", "login modal");'>
                    注册新账号
            </a>
</div>
<p class="text-muted text-center mb15">登录即表示你同意网站的<a href="/tos" target="_blank">《服务条款》</a></p>        </div>
    </div>
</script>
    <script id="registerModal" type="text/template">
    <div class="row bg-white login-modal">
        <div class="col-md-12 login-wrap">
            
            <form action="/api/user/register" method="POST" role="form" class="mt15">
                <div class="form-group">
                    <label for="name" class="control-label">你的名字</label>
                    <input type="text" class="form-control" name="name" required placeholder="真实姓名或常用昵称">
                </div>
                
                <div class="form-group">
                    <label for="mail" class="control-label">手机号 或 Email</label>
                    <input type="text" class="form-control" id="login-name" name="mail" required placeholder="11 位手机号 或 Email">
                </div>
                
                <input type="text" class="hidden" name="register_type" value="mail">

                <div class="form-group">
                    <div class="phone-register-only hidden">
                        <div class="captchaInput mb10">
                            <input type="text" class="form-control" name="cap" placeholder="右侧的验证码" style="width:50%; display: inline; margin-right: 15px;">
                            <span class="mt10">
                                <a id="loginReloadCaptcha" href="javascript:void(0)">
                                <img src="/user/captcha?w=135&h=34" class="cap" width="135" height="34"/></a>
                            </span>
                        </div>
                        <div class="input-group">
                            <input name="code" type="text" class="form-control js-user-login__phone-code-value" placeholder="短信验证码">
                            <span class="input-group-btn">
                                <button class="btn btn-default js-user-login__phone-vaild-btn" style="width:96px;" type="button">
                                获取验证码</button>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password" class="control-label">密码</label>
                    <input type="password" class="form-control" name="password" required placeholder="不少于 6 位的密码">
                </div>
                <div class="form-group clearfix">
                    <button type="submit" class="btn-block btn btn-primary pl20 pr20 pull-right"
                            onclick='ga("send", "event", "email register button", "clicked", "login modal");'>注册
                    </button>
                </div>
                                <div class="text-muted text-center more-login-area">
    <span class="more-login-words">更多登录方式</span>
</div>
<div class="widget-login mb15 text-center">
    <a href="/user/oauth/google" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "google"});'><span
                class="icon-sn-google"></span></a>
    <a href="/user/oauth/github" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "github"});");'><span
                class="icon-sn-github"></span></a>
    <a href="/user/oauth/weibo" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "weibo"});'><span
                class="icon-sn-weibo"></span></a>
    <a href="/user/oauth/qq" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-qq"></span></a>
    <a href="/user/oauth/weixin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-weixin"></span></a>
    <a href="/user/oauth/linkedin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "linkedin"});'><span
                class="icon-sn-linkedin"></span></a>
    <span id="loginShowMore" style="cursor: pointer" class="mb5"><span class="icon-sn-dotted"></span></span>
    <a href="/user/oauth/twitter" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "twitter"});'><span
                class="icon-sn-twitter"></span></a>
    <a href="/user/oauth/facebook" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "facebook"});'><span
                class="icon-sn-facebook"></span></a>
    <a href="/user/oauth/douban" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "douban"});'><span
                class="icon-sn-douban"></span></a>
</div>
<div class="form-group clearfix">
    <a class="btn-block btn btn-default pull-right pl20 pr20 
                        SFRegister
             "

            
        onclick='ga("send", "event", "email login button", "clicked", "login modal");'>
                    已有账号登录
            </a>
</div>
<p class="text-muted text-center mb15">登录即表示你同意网站的<a href="/tos" target="_blank">《服务条款》</a></p>            </form>
        </div>
    </div>
</script>
    <script id="phoneLoginModal" type="text/template">

    <div class="row bg-white login-modal phonelogin-modal">
        <div class="col-md-12 login-wrap">
            <form action="/api/user/phonelogin" method="POST" role="form" class="mt15">
                <div class="form-group">
                    <label for="phone" class="control-label required">手机号</label>
                    <input type="text" class="form-control phonelogin--phone" name="phone" tabindex="1" required placeholder="11 位手机号"
                           autocomplete="off">
                    <span class="help-block"></span>
                </div>

                <div class="form-group">
                    <label for="authCode" class="control-label required">验证码</label>
                    <div class="input-group">
                        <input type="text" class="form-control bindphone--code" name="authCode" placeholder="短信验证码">
                        <span class="input-group-btn">
                            <button class="btn btn-default user-bind__phone-vaild-btn" type="button">获取验证码</button>
                        </span>
                    </div>
                    <div class="col-sm-3"></div>
                </div>

                <div class="form-group">
                    <a 
                                                            href="/user/login"
                                class="SFRegister"
                                                >密码登录（手机号或 Email）</a>
                </div>
                <div class="form-group clearfix">
                    <button type="submit" class="btn-block btn btn-primary pull-right pl20 pr20" tabindex="3"
                            onclick='ga("send", "event", "email login button", "clicked", "login modal");'>登录
                    </button>
                </div>
            </form>
            <div class="text-muted text-center more-login-area">
    <span class="more-login-words">更多登录方式</span>
</div>
<div class="widget-login mb15 text-center">
    <a href="/user/oauth/google" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "google"});'><span
                class="icon-sn-google"></span></a>
    <a href="/user/oauth/github" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "github"});");'><span
                class="icon-sn-github"></span></a>
    <a href="/user/oauth/weibo" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "weibo"});'><span
                class="icon-sn-weibo"></span></a>
    <a href="/user/oauth/qq" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-qq"></span></a>
    <a href="/user/oauth/weixin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-weixin"></span></a>
    <a href="/user/oauth/linkedin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "linkedin"});'><span
                class="icon-sn-linkedin"></span></a>
    <span id="loginShowMore" style="cursor: pointer" class="mb5"><span class="icon-sn-dotted"></span></span>
    <a href="/user/oauth/twitter" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "twitter"});'><span
                class="icon-sn-twitter"></span></a>
    <a href="/user/oauth/facebook" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "facebook"});'><span
                class="icon-sn-facebook"></span></a>
    <a href="/user/oauth/douban" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "douban"});'><span
                class="icon-sn-douban"></span></a>
</div>
<div class="form-group clearfix">
    <a class="btn-block btn btn-default pull-right pl20 pr20 
                        SFLogin
             "

            
        onclick='ga("send", "event", "email login button", "clicked", "login modal");'>
                    注册新账号
            </a>
</div>
<p class="text-muted text-center mb15">登录即表示你同意网站的<a href="/tos" target="_blank">《服务条款》</a></p>        </div>
    </div>
</script>
<script id="bindPhoneModal" type="text/template">
    <div class="bg-white bindphone-model">
        <div class="alert alert-warning" role="alert">
            为了保证账号安全，请先绑定手机
        </div>
        <div>
            <form class="form-horizontal form__bindphone-apply" style="background-color:#fff;padding:0;">
                <div class="form-group ">
                    <label for="phoneNumber" class="col-sm-3 control-label required" >手机号码</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control bindphone--phone" id="phoneNumber" name="phone" placeholder="仅只支持大陆手机号">
                    </div>
                    <div class="col-sm-3"></div>
                </div>
                <div class="form-group">
                    <label for="authCode" class="col-sm-3 control-label required">验证码</label>
                    <div class="col-sm-6">
                        <div class="input-group">
                            <input type="text" class="form-control bindphone--code" name="code" placeholder="短信验证码">
                            <span class="input-group-btn">
                                <button class="btn btn-default user-bind__phone-vaild-btn" type="button">获取验证码</button>
                            </span>
                        </div>
                    </div>
                    <div class="col-sm-3"></div>
                </div>
            </form>
        </div>

    </div>
</script>


<script>
    window.serverTime = 1542692384000;
</script>

<script>
    (function (w) {
        w.SF = {
            staticUrl: "https://static.segmentfault.com/v-5bebf0aa"
        };
        w.SF.token = (function () {
    var _N0DmPo = //'DoN'
'67f'+'5f8'//'pT'
+//'0Xi'
'84'+/* 'vf'//'vf' */''+//'L'
'L'+'e36'//'9z7'
+'6'//'M'
+//'p'
'a16'+'8b'//'Yr'
+//'zyO'
'c12'+'759'//'lH'
+'U4'//'U4'
+'n'//'n'
+''///*'xnn'*/'xnn'
+'c23'//'FVD'
+'1b'//'3T'
+'99'//'Vq1'
+'51'//'G'
, _Eh8 = [[8,9],[23,25],[23,24]];

    for (var i = 0; i < _Eh8.length; i ++) {
        _N0DmPo = _N0DmPo.substring(0, _Eh8[i][0]) + _N0DmPo.substring(_Eh8[i][1]);
    }

    return _N0DmPo;
})();;
    })(window);

                var lock = {
        type: "",
        text: '',
        table: {"ban_post":[1,"\u4f60\u5df2\u7ecf\u88ab\u7981\u8a00, \u65e0\u6cd5\u8fdb\u884c\u6b64\u64cd\u4f5c, \u5982\u6709\u7591\u4e49\u8bf7\u63d0\u4ea4\u7533\u8bc9, \u6216\u8005\u53d1\u90ae\u4ef6\u5230pr@segmentfault.com"]}
    };

        var ddosMode = false;
    
        (function (currentUrl) {
        if (typeof URL != 'undefined') {
            var baseUrl = new URL('https://segmentfault.com');

            if (baseUrl.protocol != currentUrl.protocol
                || baseUrl.host != currentUrl.host) {
                window.location.href = baseUrl.protocol + '//' + baseUrl.host
                    + currentUrl.pathname + currentUrl.search + currentUrl.hash;
            }
        }
    })(window.location);
    </script>

             <script crossorigin src="https://static.segmentfault.com/v-5bebf0aa/3rd/assets.js"></script>
                 
        <script crossorigin src="https://static.segmentfault.com/v-5bebf0aa/blog/script/post.min.js"></script>
            

<script>
if (!!navigator.userAgent.match(/MicroMessenger/i)) {
    require.config({
        paths: { weixin_jsapi: '//res.wx.qq.com/open/js/jweixin-1.2.0' }
    });

    require(['weixin_jsapi'], function (wx) {
        var share = {"title":"Lunar, \u4e00\u4e2aPython\u7f51\u7edc\u6846\u67b6\u7684\u5b9e\u73b0","desc":"Lunar\u662f\u4e00\u4e2aPython\u8bed\u8a00\u7684\u7f51\u7edc\u6846\u67b6\uff0c\u7c7b\u4f3c\u4e8eDjango\uff0cFlask\uff0cTornado\u7b49\u5f53\u4e0b\u6d41\u884c\u7684web framework\u3002\u6700\u521d\u6709\u8fd9\u4e2a\u60f3\u6cd5\u662f\u5728\u5927\u4e8c\u4e0b\u5b66\u671f\uff0c\u5f53\u65f6\u63a5\u89e6Python web\u7f16\u7a0b\u6709\u4e00\u6bb5\u65f6\u95f4\u3002\u6700\u65e9\u63a5\u89e6Python web\u7f16\u7a0b\u6216\u8bb8\u662f\u5728\u5927\u4e00\u4e0b\uff1f\u81ea\u89c9\u5f53...","link":"https:\/\/segmentfault.com\/a\/1190000002442999","imgUrl":"https:\/\/avatar-static.segmentfault.com\/113\/161\/1131611007-549ae2da30256_huge256"};
        share.title += ' - SegmentFault 思否';

        $.getJSON('/api/util/weixin/jsapi', function (o) {
            methods = o.data.jsApiList.slice();

            wx.config(o.data);
            wx.error(console.error);
            wx.ready(function () {
                methods.forEach(function (method) {
                    wx[method](share);
                });
            });
        });
    });
}
</script>

<script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-918487-8']);
    _gaq.push(['_trackPageview']);
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

                
        

            

    ga('create', 'UA-918487-8', 'auto', {
        'userID'
    : 0,
        'createdTime'
    : 0,
        'now'
    : 1542692384,
        'allowLinker'
    : true });
    ga('require', 'linker');
    ga('linker:autoLink', ['docs.segmentfault.com'] );
    ga('set', 'dimension1', 'guest');
    ga('send', 'pageview');

</script>

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?e23800c454aa573c0ccb16b52665ac26";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



</body>
</html>

