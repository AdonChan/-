

<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"/><meta name="renderer" content="webkit"/><meta property="qc:admins" content="15317273575564615446375"/><meta property="og:image" content="https://static.segmentfault.com/v-5bebf0aa/global/img/touch-icon.png"/><meta name="viewport"
              content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/><meta name="alexaVerifyID" content="LkzCRJ7rPEUwt6fVey2vhxiw1vQ"/><meta name="apple-itunes-app" content="app-id=958101793, app-argument="><title>Python 高级特性 - SegmentFault 业界资讯 - SegmentFault 思否</title><meta name="description" content="这章有关Python中被认为高级的特性——就是说并不是每个语言都有的，也是说它们可能在更复杂的程序或库中更有用，但不是说特别特殊或特别复杂。"/><meta name="keywords" content="python"/><link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="SegmentFault"/><link rel="shortcut icon" href="https://static.segmentfault.com/v-5bebf0aa/global/img/favicon.ico"/><link rel="apple-touch-icon" href="https://static.segmentfault.com/v-5bebf0aa/global/img/touch-icon.png"><meta name="msapplication-TileColor" content="#009a61"/><meta name="msapplication-square150x150logo" content="https://static.segmentfault.com/v-5bebf0aa/global/img/touch-icon.png"/><meta name="baidu_union_verify" content="bcf7fd80dca60d53d46d5b46e1b990ca"><link rel="alternate" type="application/atom+xml" title="SegmentFault 最新问题" href="/feeds/questions"><link rel="alternate" type="application/atom+xml" title="SegmentFault 最新文章" href="/feeds/blogs"><link rel="stylesheet" href="https://static.segmentfault.com/v-5bebf0aa/global/css/global.css"/><link rel="stylesheet" href="https://static.segmentfault.com/v-5bebf0aa/blog/css/blog.css"/><link rel="stylesheet" href="https://static.segmentfault.com/v-5bebf0aa/global/css/responsive.css"/><script type='text/javascript' src='https://sponsor.segmentfault.com/spcjs.php?id=1&block=1&repu=0&tag=python'></script></head><!-- 推荐引擎 --><script charset="utf-8" id="ParadigmSDK" src="https://nbrecsys.4paradigm.com/sdk/js/ParadigmSDK_v2.js" data="216" defSI="594"></script><script>
    ParadigmSDK.init("46e957bd9dea4acdaa15b4b64aff728f");
    ParadigmSDK.trackDetailPageShow();
</script><body data-mod="blog"
    class="blog-post "><!--[if lt IE 9]><div class="alert alert-danger topframe" role="alert">你的浏览器实在<strong>太太太太太太旧了</strong>，放学别走，升级完浏览器再说 <a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div><![endif]--><img id="icon4weChat" style="height: 0;width: 0;" src="https://static.segmentfault.com/v-5bebf0aa/global/img/touch-icon-512.png"><div id="gridMapHoverBox" style="position:absolute; border: 1px solid #009a61; z-index:99; font-size: 10px; background:#fff"></div><div class="global-nav sf-header sf-header--index"><div class="bottom-nav visible-xs visible-sm "><div class="opts"><a class="opts-group " href="/"><i class="fa fa-home" aria-hidden="true"></i><span>首页</span></a><a class="opts-group " href="/questions"><i class="fa fa-comments" aria-hidden="true"></i><span>问答</span></a><a class="opts-group active" href="/blogs"><i class="fa fa-pencil-square" aria-hidden="true"></i><span>专栏</span></a><a class="opts-group " href="/lives"><i class="fa fa-play-circle" aria-hidden="true"></i><span>讲堂</span></a><div class="opts-group"><div class="btn-group dropup"><i class="fa fa-bars dropdown hoverDropdown" data-toggle="dropdown" aria-hidden="true"><span>更多</span></i><ul class="dropdown-menu"><li><a href="/jobs">职位</a></li><li><a href="/events">活动</a></li><li><a href="/tags">标签</a></li><li><a href="/badges">徽章</a></li></ul></div></div></div></div><nav class="container nav"><div class="visible-xs visible-sm header-response"><a href="/search" style="display:block"><i class="fa fa-search" aria-hidden="true"></i></a><div class="sf-header__logo sf-header__logo--response"><h1><a href="/" style="height:24px; background-size: auto 24px;"></a></h1></div><a href="/user/login" class="pull-right login-btn"><i class="fa fa-user" aria-hidden="true"></i></a></div><script>
mobileScroll(
    function(direction) { 
        try {
            if (direction === 'down') {
                document.querySelector('.bottom-nav').classList.add('hidden')
            } else {
                document.querySelector('.bottom-nav').classList.remove('hidden')
            }
        } catch(err) {}
    }
);    
function mobileScroll( fn ) {
    var beforeScrollTop = document.documentElement.scrollTop || document.body.scrollTop,
        fn = fn || function() {};
    window.addEventListener("scroll", function() {
        var afterScrollTop = document.documentElement.scrollTop || document.body.scrollTop,
            delta = afterScrollTop - beforeScrollTop;
        if( delta === 0 ) return false;
        fn( delta > 0 ? "down" : "up" );
        beforeScrollTop = afterScrollTop;
    }, false);
}
</script><div class="row hidden-xs hidden-sm"><div class="col-sm-8 col-md-9 col-lg-9"><div class="sf-header__logo"><h1><a href="/">SegmentFault</a></h1></div><div><ul class="menu list-inline pull-left hidden-xs"><li class="menu__item"><a href="/" class="">首页</a></li><li class="menu__item"><a href="/questions" class="">问答</a></li><li class="menu__item"><a href="/blogs" class="active-nav">专栏</a></li><li class="menu__item"><a href="/lives" class="">讲堂</a></li><li class="menu__item menu__item--more dropdown"><a href="##" class="dropdown-toggle dropdownBtn" data-toggle="dropdown">
                                        发现<i class="fa fa-caret-down" style="font-size: 14px;margin-left: 5px;" aria-hidden="true"></i></a><div class="dropdown-block hidden"><ul class="dropdown-content-menu"><li><a href="/groups">圈子</a></li><li><a href="/events">活动</a></li><li><a href="/tags">标签</a></li><li><a href="/jobs">找工作</a></li><li><a href="/users">排行榜</a></li><li><a href="/badges">徽章</a></li><li><a href="/notes">笔记</a></li><li><a href="https://docs.segmentfault.com" target="_blank">开发手册<i style="line-height: 20px;font-size: 12px;color: #F5A623;" class="ml10 fa fa-external-link-square"></i></a></li><li><a href="https://business.segmentfault.com/ads?utm_source=sf-header" target="_blank">广告投放<i style="line-height: 20px;font-size: 12px;color: #F5A623;" class="ml10 fa fa-external-link-square"></i></a></li></ul></div></li><li class="menu__item visible-sm-inline-block"><a href="/search"><span class="glyphicon glyphicon-search" style="vertical-align: middle;"></span></a></li></ul><form action="/search" class="header-search  hidden-sm hidden-xs pull-right" ><button class="btn btn-link"><span class="sr-only">搜索</span><span class="glyphicon glyphicon-search"></span></button><input id="searchBox" name="q" type="text"  placeholder="搜索问题或关键字" class="form-control" value="" /></form></div></div><div class="col-sm-4 col-md-3 col-lg-3 text-right"><ul class="opts list-inline hidden-xs"><li class="opts__item"><a href="/user/login" class="SFRegister btn-signin" style="margin-bottom:2px;">立即登录</a><a href="/user/register" class="SFLogin ml10 btn-signup"
                                       onClick="_gaq.push(['_trackEvent', 'Button', 'Click', 'Login']);">免费注册</a></li></ul></div></div></nav></div>
    
<input id="articleId" value="1190000000498466" class="hidden" />

<div class="wrap" data-blogid="1200000000309635">
    <div class="container mt15" style="position:relative">
        <div class="row">
            <div class="col-xs-12 col-md-9 main ">
                                <ol class="breadcrumb mb15">
                    <li><a href="/blogs">专栏</a></li>
                                        <li><a href="/blog/news">SegmentFault 业界资讯</a></li>
                                        <li class="active">文章详情</li>
                </ol>
                                <div class="post-topheader custom- pt0">
                    <div class="mb20">
                        <div class="block-for-right-border">
                            <div class="row">
                                <div class="col-md-12 col-sm-12 col-xs-12">
                                

                                    <div class="post-topheader__info" data-username="weakish"
                                         data-userslug="weakish"
                                         data-useravatar="https://avatar-static.segmentfault.com/266/538/2665388308-1030000000323597_big64">


                                        <div class="article__author clearfix">
                                            <div class="article__authorleft">
                                                <a href="/u/weakish">
                                                    <img class="avatar-40" src="https://avatar-static.segmentfault.com/266/538/2665388308-1030000000323597_big64" alt="weakish">
                                                </a>
                                            </div>
                                            <div class="article__authorright">
                                                <div class="article__authormeta">
                                                <a href="/u/weakish" class="mr5 "><strong>weakish</strong></a>

                                                                                                <img src="https://static.segmentfault.com/v-5bebf0aa/global/img/rp.svg" class="mr5"><span style="color:#BF7158" class="mr10">22.8k</span>

                                                                                                发布于
                                                <a href="/blog/news">SegmentFault 业界资讯</a>
                                                
                                                
                                                <span class="hidden-xs">
                                                                                                                                                          <button type="button"
                                                               class="btn btn-xs btn-success follow-article ml10"
                                                               data-do="follow"
                                                               data-type="blog"
                                                               data-id="1200000000309635">关注专栏
                                                       </button>
                                                                                                                                                   </span>
                                                </div>
                                                
                                                <span style="display: block">
                                                    2014-05-08 发布
                                                </span>
                                            </div>
                                        </div>

                                        <h1 class="h1 post-topheader__info--title" id="articleTitle" data-id="1190000000498466">
                                            <a href="/a/1190000000498466"> Python 高级特性</a>
                                        </h1>

                                        <div class="content__tech hidden-xs">
                                            <a href="" class="blog-type-common blog-type-0-before" target="_blank" data-content="
                                                                                        翻译自 
                                                                                        "></a>
                                            
                                            <ul class="taglist--inline inline-block article__title--tag mr10">
                                                                                                    <li class="tagPopup mb5">
                                                        <a class="tag" href="/t/python/blogs" data-toggle="popover"
                                                                                data-img="https://avatar-static.segmentfault.com/378/252/3782524817-1040000000089534_big64" data-placement="top"
                                                                                data-original-title="python"
                                                                                data-id="1040000000089534">
                                                                                                                    <img src="https://avatar-static.segmentfault.com/252/177/2521771040-54cb53b372821_small">
                                                                                                                      python
                                                        </a>
                                                    </li>
                                                                                            </ul>

                                            <span>
                                                12.8k 次阅读
                                                &nbsp;&middot;&nbsp;
                                                读完需要 85 分钟 
                                                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- end .post-topheader -->

                <div class="visible-lg">
                    <div class="side-widget">
                        <div class="stream__item-zan btn btn-default mt0 mb15 ml0 mr0 pt0 pb0 pl0 pr0 " id="side-widget-votes-btn">
                            <span class="stream__item-zan-icon"></span>
                            <span class="stream__item-zan-number" id="side-widget-votes-num">4</span>
                        </div>

                        <i class="fa fa-bookmark item " id="side-widget-bookmarks-btn"></i>
                        <i class="fa fa-weibo item"></i>
                        <i class="fa fa-weixin item" data-toggle="popover" data-placement="right"></i>
                        <i class="fa fa-twitter item"></i>
                        <i class="fa fa-facebook item"></i>
                        <i class="fa fa-arrow-up item hidden"></i>
                    </div>
                </div>

                
                <div class="article fmt article__content" data-id="1190000000498466" data-license="cc">
                    
<p>这章有关Python中被认为高级的特性——就是说并不是每个语言都有的，也是说它们可能在更复杂的程序或库中更有用，但不是说特别特殊或特别复杂。</p>

<p>强调这点很重要：这一章仅仅关于语言自身——关于辅之以Python的标准库功能的特殊语法所支持的特性，不包括那些智能的外部模块实现。</p>

<p>在开发Python程序语言的过程中，它的语法，独一无二。因为它非常透明。建议的更改通过不同的角度评估并在公开邮件列表讨论，最终决定考虑到假设用例的重要性、添加更多特性的负担，其余语法的一致性、是否建议的变种易于读写和理解之间的平衡。这个过程由Python Enhancement Proposals(<a rel="nofollow" href="http://www.python.org/dev/peps/">PEPs</a>)的形式规范。最终这一章节中描述的特性在证明它们确实解决实际问题并且使用起来尽可能简单后被添加。</p>

<h2>迭代器(Iterators), 生成表达式(generator expressions)和生成器(generators)</h2>

<h3>迭代器</h3>

<blockquote>
  <p><strong>简单</strong></p>
  
  <p>重复工作是浪费，将不同“土生土长”的方法替换为标准特性换来的是更加易于阅读和操作。</p>
  
  <p>Guido van Rossum — <a rel="nofollow" href="http://www.artima.com/weblogs/viewpost.jsp?thread=86641">Adding Optional Static Typing to Python</a></p>
</blockquote>

<p>迭代器是依附于<a rel="nofollow" href="http://docs.python.org/dev/library/stdtypes.html#iterator-types">迭代协议</a>的对象——基本意味它有一个<code>next</code>方法(method)，当调用时，返回序列中的下一个项目。当无项目可返回时，引发(raise)<code>StopIteration</code>异常。</p>

<p>迭代对象允许一次循环。它保留单次迭代的状态(位置)，或从另一个角度讲，每次循环序列都需要一个迭代对象。这意味我们可以同时迭代同一个序列不只一次。将迭代逻辑和序列分离使我们有更多的迭代方式。</p>

<p>调用一个容器(container)的<code>__iter__</code>方法创建迭代对象是掌握迭代器最直接的方式。<code>iter</code>函数为我们节约一些按键。</p>

<pre><code>&gt;&gt;&gt; nums = [1,2,3]      # note that ... varies: these are different objects
&gt;&gt;&gt; iter(nums)                           
&lt;listiterator object at ...&gt;
&gt;&gt;&gt; nums.__iter__()                      
&lt;listiterator object at ...&gt;
&gt;&gt;&gt; nums.__reversed__()                  
&lt;listreverseiterator object at ...&gt;

&gt;&gt;&gt; it = iter(nums)
&gt;&gt;&gt; next(it)            # next(obj) simply calls obj.next()
1
&gt;&gt;&gt; it.next()
2
&gt;&gt;&gt; next(it)
3
&gt;&gt;&gt; next(it)
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
StopIteration
</code></pre>

<p>当在循环中使用时，<code>StopIteration</code>被接受并停止循环。但通过显式引发(invocation)，我们看到一旦迭代器元素被耗尽，存取它将引发异常。</p>

<p>使用<code>for...in</code>循环也使用<code>__iter__</code>方法。这允许我们透明地开始对一个序列迭代。但是如果我们已经有一个迭代器，我们想在for循环中能同样地使用它们。为了实现这点，迭代器除了<code>next</code>还有一个方法<code>__iter__</code>来返回迭代器自身(self)。</p>

<p>Python中对迭代器的支持无处不在：标准库中的所有序列和无序容器都支持。这个概念也被拓展到其它东西：例如<code>file</code>对象支持行的迭代。</p>

<pre><code>&gt;&gt;&gt; f = open('/etc/fstab')
&gt;&gt;&gt; f is f.__iter__()
True
</code></pre>

<p><code>file</code>自身就是迭代器，它的<code>__iter__</code>方法并不创建一个单独的对象：仅仅单线程的顺序读取被允许。</p>

<h3>生成表达式</h3>

<p>第二种创建迭代对象的方式是通过 <em>生成表达式(generator expression)</em> ，列表推导(list comprehension)的基础。为了增加清晰度，生成表达式总是封装在括号或表达式中。如果使用圆括号，则创建了一个生成迭代器(generator iterator)。如果是方括号，这一过程被‘短路’我们获得一个列表<code>list</code>。</p>

<pre><code>&gt;&gt;&gt; (i for i in nums)                    
&lt;generator object &lt;genexpr&gt; at 0x...&gt;
&gt;&gt;&gt; [i for i in nums]
[1, 2, 3]
&gt;&gt;&gt; list(i for i in nums)
[1, 2, 3]
</code></pre>

<p>在Python 2.7和 3.x中列表表达式语法被扩展到 <em>字典和集合表达式</em>。一个集合<code>set</code>当生成表达式是被大括号封装时被创建。一个字典<code>dict</code>在表达式包含<code>key:value</code>形式的键值对时被创建：</p>

<pre><code>&gt;&gt;&gt; {i for i in range(3)}   
set([0, 1, 2])
&gt;&gt;&gt; {i:i**2 for i in range(3)}   
{0: 0, 1: 1, 2: 4}
</code></pre>

<p>如果您不幸身陷古老的Python版本中，这个语法有点糟：</p>

<pre><code>&gt;&gt;&gt; set(i for i in 'abc')
set(['a', 'c', 'b'])
&gt;&gt;&gt; dict((i, ord(i)) for i in 'abc')
{'a': 97, 'c': 99, 'b': 98}
</code></pre>

<p>生成表达式相当简单，不用多说。只有一个陷阱值得提及：在版本小于3的Python中索引变量(<code>i</code>)会泄漏。</p>

<h3>生成器</h3>

<blockquote>
  <p><strong>生成器</strong></p>
  
  <p>生成器是产生一列结果而不是单一值的函数。</p>
  
  <p>David Beazley — <a rel="nofollow" href="http://www.dabeaz.com/coroutines/">A Curious Course on Coroutines and  Concurrency</a></p>
</blockquote>

<p>第三种创建迭代对象的方式是调用生成器函数。一个 <em>生成器(generator)</em> 是包含关键字<code>yield</code>的函数。值得注意，仅仅是这个关键字的出现完全改变了函数的本质：<code>yield</code>语句不必引发(invoke)，甚至不必可接触。但让函数变成了生成器。当一个函数被调用时，其中的指令被执行。而当一个生成器被调用时，执行在其中第一条指令之前停止。生成器的调用创建依附于迭代协议的生成器对象。就像常规函数一样，允许并发和递归调用。<br>
当<code>next</code>被调用时，函数执行到第一个<code>yield</code>。每次遇到<code>yield</code>语句获得一个作为<code>next</code>返回的值，在<code>yield</code>语句执行后，函数的执行又被停止。</p>

<pre><code>&gt;&gt;&gt; def f():
...   yield 1
...   yield 2
&gt;&gt;&gt; f()                                   
&lt;generator object f at 0x...&gt;
&gt;&gt;&gt; gen = f()
&gt;&gt;&gt; gen.next()
1
&gt;&gt;&gt; gen.next()
2
&gt;&gt;&gt; gen.next()
Traceback (most recent call last):
 File "&lt;stdin&gt;", line 1, in &lt;module&gt;
StopIteration
</code></pre>

<p>让我们遍历单个生成器函数调用的整个历程。</p>

<pre><code>&gt;&gt;&gt; def f():
...   print("-- start --")
...   yield 3
...   print("-- middle --")
...   yield 4
...   print("-- finished --")
&gt;&gt;&gt; gen = f()
&gt;&gt;&gt; next(gen)
-- start --
3
&gt;&gt;&gt; next(gen)
-- middle --
4
&gt;&gt;&gt; next(gen)                            
-- finished --
Traceback (most recent call last):
 ...
StopIteration
</code></pre>

<p>相比常规函数中执行<code>f()</code>立即让<code>print</code>执行，<code>gen</code>不执行任何函数体中语句就被赋值。只有当<code>gen.next()</code>被<code>next</code>调用，直到第一个<code>yield</code>部分的语句才被执行。第二个语句打印<code>-- middle --</code>并在遇到第二个yield时停止执行。第三个<code>next</code>打印<code>-- finished --</code>并且到函数末尾，因为没有<code>yield</code>，引发了异常。</p>

<p>当函数yield之后控制返回给调用者后发生了什么？每个生成器的状态被存储在生成器对象中。从这点看生成器函数，好像它是运行在单独的线程，但这仅仅是假象：执行是严格单线程的，但解释器保留和存储在下一个值请求之间的状态。</p>

<p>为何生成器有用？正如关于迭代器这部分强调的，生成器函数只是创建迭代对象的又一种方式。一切能被<code>yield</code>语句完成的东西也能被<code>next</code>方法完成。然而，使用函数让解释器魔力般地创建迭代器有优势。一个函数可以比需要<code>next</code>和<code>__iter__</code>方法的类定义短很多。更重要的是，相比不得不对迭代对象在连续<code>next</code>调用之间传递的实例(instance)属性来说，生成器的作者能更简单的理解局限在局部变量中的语句。</p>

<p>还有问题是为何迭代器有用？当一个迭代器用来驱动循环，循环变得简单。迭代器代码初始化状态，决定是否循环结束，并且找到下一个被提取到不同地方的值。这凸显了循环体——最值得关注的部分。除此之外，可以在其它地方重用迭代器代码。</p>

<h3>双向通信</h3>

<p>每个<code>yield</code>语句将一个值传递给调用者。这就是为何<a rel="nofollow" href="http://www.python.org/dev/peps/pep-0255">PEP 255</a>引入生成器(在Python2.2中实现)。但是相反方向的通信也很有用。一个明显的方式是一些外部(extern)语句，或者全局变量或共享可变对象。通过将先前无聊的<code>yield</code>语句变成表达式，直接通信因<a rel="nofollow" href="http://www.python.org/dev/peps/pep-0342">PEP 342</a>成为现实(在2.5中实现)。当生成器在yield语句之后恢复执行时，调用者可以对生成器对象调用一个方法，或者传递一个值 <em>给</em> 生成器，然后通过<code>yield</code>语句返回，或者通过一个不同的方法向生成器注入异常。</p>

<p>第一个新方法是<code>send(value)</code>，类似于<code>next()</code>，但是将<code>value</code>传递进作为yield表达式值的生成器中。事实上，<code>g.next()</code>和<code>g.send(None)</code>是等效的。</p>

<p>第二个新方法是<code>throw(type, value=None, traceback=None)</code>，等效于在yield语句处</p>

<pre><code>raise type, value, traceback
</code></pre>

<p>不像<code>raise</code>(从执行点立即引发异常)，<code>throw()</code>首先恢复生成器，然后仅仅引发异常。选用单次throw就是因为它意味着把异常放到其它位置，并且在其它语言中与异常有关。</p>

<p>当生成器中的异常被引发时发生什么？它可以或者显式引发，当执行某些语句时可以通过<code>throw()</code>方法注入到yield语句中。任一情况中，异常都以标准方式传播：它可以被<code>except</code>和<code>finally</code>捕获，或者造成生成器的中止并传递给调用者。</p>

<p>因完整性缘故，值得提及生成器迭代器也有<code>close()</code>方法，该方法被用来让本可以提供更多值的生成器立即中止。它用生成器的<code>__del__</code>方法销毁保留生成器状态的对象。</p>

<p>让我们定义一个只打印出通过send和throw方法所传递东西的生成器。</p>

<pre><code>&gt;&gt;&gt; import itertools
&gt;&gt;&gt; def g():
...     print '--start--'
...     for i in itertools.count():
...         print '--yielding %i--' % i
...         try:
...             ans = yield i
...         except GeneratorExit:
...             print '--closing--'
...             raise
...         except Exception as e:
...             print '--yield raised %r--' % e
...         else:
...             print '--yield returned %s--' % ans

&gt;&gt;&gt; it = g()
&gt;&gt;&gt; next(it)
--start--
--yielding 0--
0
&gt;&gt;&gt; it.send(11)
--yield returned 11--
--yielding 1--
1
&gt;&gt;&gt; it.throw(IndexError)
--yield raised IndexError()--
--yielding 2--
2
&gt;&gt;&gt; it.close()
--closing--
</code></pre>

<p><strong>注意： <code>next</code>还是<code>__next__</code>?</strong></p>

<p><strong>在Python 2.x中，接受下一个值的迭代器方法是<code>next</code>，它通过全局函数<code>next</code>显式调用，意即它应该调用<code>__next__</code>。就像全局函数<code>iter</code>调用<code>__iter__</code>。这种不一致在Python 3.x中被修复，<code>it.next</code>变成了<code>it.__next__</code>。对于其它生成器方法——<code>send</code>和<code>throw</code>情况更加复杂，因为它们不被解释器隐式调用。然而，有建议语法扩展让<code>continue</code>带一个将被传递给循环迭代器中<code>send</code>的参数。如果这个扩展被接受，可能<code>gen.send</code>会变成<code>gen.__send__</code>。最后一个生成器方法<code>close</code>显然被不正确的命名了，因为它已经被隐式调用。</strong></p>

<h3>链式生成器</h3>

<p><strong>注意： 这是<a rel="nofollow" href="http://www.python.org/dev/peps/pep-0380">PEP 380</a>的预览(还未被实现，但已经被Python3.3接受)</strong></p>

<p>比如说我们正写一个生成器，我们想要yield一个第二个生成器——一个子生成器(subgenerator)——生成的数。如果仅考虑产生(yield)的值，通过循环可以不费力的完成：</p>

<pre><code>subgen = some_other_generator()
for v in subgen:
    yield v
</code></pre>

<p>然而，如果子生成器需要调用<code>send()</code>、<code>throw()</code>和<code>close()</code>和调用者适当交互的情况下，事情就复杂了。<code>yield</code>语句不得不通过类似于前一章节部分定义的<code>try...except...finally</code>结构来保证“调试”生成器函数。这种代码在<a rel="nofollow" href="http://www.python.org/dev/peps/pep-0380#id13">PEP 380</a>中提供，现在足够拿出将在Python 3.3中引入的新语法了：</p>

<pre><code>yield from some_other_generator()
</code></pre>

<p>像上面的显式循环调用一样，重复从<code>some_other_generator</code>中产生值直到没有值可以产生，但是仍然向子生成器转发<code>send</code>、<code>throw</code>和<code>close</code>。</p>

<h2>装饰器</h2>

<blockquote>
  <p><strong>总结</strong></p>
  
  <p>这个语言中令人激动的特性几乎充满歉意的，考虑到它可能没这么有用。</p>

<pre><code>Bruce Eckel — An Introduction to Python Decorators
</code></pre>
</blockquote>

<p>因为函数或类都是对象，它们也能被四处传递。它们又是可变对象，可以被更改。在函数或类对象创建后但绑定到名字前更改之的行为为装饰(decorator)。</p>

<p>“装饰器”后隐藏了两种意思——一是函数起了装饰作用，例如，执行真正的工作，另一个是依附于装饰器语法的表达式，例如，at符号和装饰函数的名称。</p>

<p>函数可以通过函数装饰器语法装饰：</p>

<pre><code>@decorator             # ②
def function():        # ①
    pass
</code></pre>

<ul>
<li>函数以标准方式定义。①</li>
<li>以<code>@</code>做为定义为装饰器函数前缀的表达式②。在 @ 后的部分必须是简单的表达式，通常只是函数或类的名字。这一部分先求值，在下面的定义的函数准备好后，装饰器被新定义的函数对象作为单个参数调用。装饰器返回的值附着到被装饰的函数名。</li>
</ul>
<p>装饰器可以应用到函数和类上。对类语义很明晰——类定义被当作参数来调用装饰器，无论返回什么都赋给被装饰的名字。</p>

<p>在装饰器语法实现前(<a rel="nofollow" href="http://www.python.org/dev/peps/pep-0318">PEP 318</a>)，通过将函数和类对象赋给临时变量然后显式调用装饰器然后将返回值赋给函数名，可以完成同样的事。这似乎要打更多的字，也确实装饰器函数名用了两次同时临时变量要用至少三次，很容易出错。以上实例相当于：</p>

<pre><code>def function():                  # ①
    pass
function = decorator(function)   # ②
</code></pre>

<p>装饰器可以堆栈(stacked)——应用的顺序是从底到上或从里到外。就是说最初的函数被当作第一次参数器的参数，无论返回什么都被作为第二个装饰器的参数……无论最后一个装饰器返回什么都被依附到最初函数的名下。</p>

<p>装饰器语法因其可读性被选择。因为装饰器在函数头部前被指定，显然不是函数体的一部分，它只能对整个函数起作用。以@为前缀的表达式又让它明显到不容忽视(根据PEP叫在您脸上……：）)。当多个装饰器被应用时，每个放在不同的行非常易于阅读。</p>

<h3>代替和调整原始对象</h3>

<p>装饰器可以或者返回相同的函数或类对象或者返回完全不同的对象。第一种情况中，装饰器利用函数或类对象是可变的添加属性，例如向类添加文档字符串(docstring).装饰器甚至可以在不改变对象的情况下做有用的事，例如在全局注册表中注册装饰的类。在第二种情况中，简直无所不能：当什么不同的东西取代了被装饰的类或函数，新对象可以完全不同。然而这不是装饰器的目的：它们意在改变装饰对象而非做不可预料的事。因此当一个函数在装饰时被完全替代成不同的函数时，新函数通常在一些准备工作后调用原始函数。同样，当一个类被装饰成一个新类时，新类通常源于被装饰类。当装饰器的目的是“每次都”做什么，像记录每次对被装饰函数的调用，只有第二类装饰器可用。另一方面，如果第一类足够了，最好使用它因为更简单。</p>

<h3>实现类和函数装饰器</h3>

<p>对装饰器惟一的要求是它能够单参数调用。这意味着装饰器可以作为常规函数或带有<code>__call__</code>方法的类的实现，理论上，甚至lambda函数也行。</p>

<p>让我们比较函数和类方法。装饰器表达式(@后部分)可以只是名字。只有名字的方法很好(打字少，看起来整洁等)，但是只有当无需用参数定制装饰器时才可能。被写作函数的装饰器可以用以下两种方式：</p>

<pre><code>&gt;&gt;&gt; def simple_decorator(function):
...   print "doing decoration"
...   return function
&gt;&gt;&gt; @simple_decorator
... def function():
...   print "inside function"
doing decoration
&gt;&gt;&gt; function()
inside function

&gt;&gt;&gt; def decorator_with_arguments(arg):
...   print "defining the decorator"
...   def _decorator(function):
...       # in this inner function, arg is available too
...       print "doing decoration,", arg
...       return function
...   return _decorator
&gt;&gt;&gt; @decorator_with_arguments("abc")
... def function():
...   print "inside function"
defining the decorator
doing decoration, abc
&gt;&gt;&gt; function()
inside function
</code></pre>

<p>这两个装饰器属于返回被装饰函数的类别。如果它们想返回新的函数，需要额外的嵌套，最糟的情况下，需要三层嵌套。</p>

<pre><code>&gt;&gt;&gt; def replacing_decorator_with_args(arg):
...   print "defining the decorator"
...   def _decorator(function):
...       # in this inner function, arg is available too
...       print "doing decoration,", arg
...       def _wrapper(*args, **kwargs):
...           print "inside wrapper,", args, kwargs
...           return function(*args, **kwargs)
...       return _wrapper
...   return _decorator
&gt;&gt;&gt; @replacing_decorator_with_args("abc")
... def function(*args, **kwargs):
...     print "inside function,", args, kwargs
...     return 14
defining the decorator
doing decoration, abc
&gt;&gt;&gt; function(11, 12)
inside wrapper, (11, 12) {}
inside function, (11, 12) {}
14
</code></pre>

<p><code>_wrapper</code>函数被定义为接受所有位置和关键字参数。通常我们不知道哪些参数被装饰函数会接受，所以wrapper将所有东西都创递给被装饰函数。一个不幸的结果就是显式参数很迷惑人。</p>

<p>相比定义为函数的装饰器，定义为类的复杂装饰器更简单。当对象被创建，<code>__init__</code>方法仅仅允许返回<code>None</code>，创建的对象类型不能更改。这意味着当装饰器被定义为类时，使用无参数的形式没什么意义：最终被装饰的对象只是装饰类的一个实例而已，被构建器(constructor)调用返回，并不非常有用。讨论在装饰表达式中给出参数的基于类的装饰器，<code>__init__</code>方法被用来构建装饰器。</p>

<pre><code>&gt;&gt;&gt; class decorator_class(object):
...   def __init__(self, arg):
...       # this method is called in the decorator expression
...       print "in decorator init,", arg
...       self.arg = arg
...   def __call__(self, function):
...       # this method is called to do the job
...       print "in decorator call,", self.arg
...       return function
&gt;&gt;&gt; deco_instance = decorator_class('foo')
in decorator init, foo
&gt;&gt;&gt; @deco_instance
... def function(*args, **kwargs):
...   print "in function,", args, kwargs
in decorator call, foo
&gt;&gt;&gt; function()
in function, () {}
</code></pre>

<p>相对于正常规则(<a rel="nofollow" href="http://www.python.org/dev/peps/pep-0008">PEP 8</a>)由类写成的装饰器表现得更像函数，因此它们的名字以小写字母开始。</p>

<p>事实上，创建一个仅返回被装饰函数的新类没什么意义。对象应该有状态，这种装饰器在装饰器返回新对象时更有用。</p>

<pre><code>&gt;&gt;&gt; class replacing_decorator_class(object):
...   def __init__(self, arg):
...       # this method is called in the decorator expression
...       print "in decorator init,", arg
...       self.arg = arg
...   def __call__(self, function):
...       # this method is called to do the job
...       print "in decorator call,", self.arg
...       self.function = function
...       return self._wrapper
...   def _wrapper(self, *args, **kwargs):
...       print "in the wrapper,", args, kwargs
...       return self.function(*args, **kwargs)
&gt;&gt;&gt; deco_instance = replacing_decorator_class('foo')
in decorator init, foo
&gt;&gt;&gt; @deco_instance
... def function(*args, **kwargs):
...   print "in function,", args, kwargs
in decorator call, foo
&gt;&gt;&gt; function(11, 12)
in the wrapper, (11, 12) {}
in function, (11, 12) {}
</code></pre>

<p>像这样的装饰器可以做任何事，因为它能改变被装饰函数对象和参数，调用被装饰函数或不调用，最后改变返回值。</p>

<h3>复制原始函数的文档字符串和其它属性</h3>

<p>当新函数被返回代替装饰前的函数时，不幸的是原函数的函数名，文档字符串和参数列表都丢失了。这些属性可以部分通过设置<code>__doc__</code>(文档字符串)，<code>__module__</code>和<code>__name__</code>(函数的全称)、<code>__annotations__</code>(Python 3中关于参数和返回值的额外信息)移植到新函数上，这些工作可通过<code>functools.update_wrapper</code>自动完成。</p>

<pre><code>&gt;&gt;&gt; import functools
&gt;&gt;&gt; def better_replacing_decorator_with_args(arg):
...   print "defining the decorator"
...   def _decorator(function):
...       print "doing decoration,", arg
...       def _wrapper(*args, **kwargs):
...           print "inside wrapper,", args, kwargs
...           return function(*args, **kwargs)
...       return functools.update_wrapper(_wrapper, function)
...   return _decorator
&gt;&gt;&gt; @better_replacing_decorator_with_args("abc")
... def function():
...     "extensive documentation"
...     print "inside function"
...     return 14
defining the decorator
doing decoration, abc
&gt;&gt;&gt; function                           
&lt;function function at 0x...&gt;
&gt;&gt;&gt; print function.__doc__
extensive documentation
</code></pre>

<p>一件重要的东西是从可迁移属性列表中所缺少的：参数列表。参数的默认值可以通过<code>__defaults__</code>、<code>__kwdefaults__</code>属性更改，但是不幸的是参数列表本身不能被设置为属性。这意味着<code>help(function)</code>将显式无用的参数列表，使使用者迷惑不已。一个解决此问题有效但是丑陋的方式是使用<code>eval</code>动态创建wrapper。可以使用外部<code>external</code>模块自动实现。它提供了对<code>decorator</code>装饰器的支持，该装饰器接受wrapper并将之转换成保留函数签名的装饰器。</p>

<p>综上，装饰器应该总是使用<code>functools.update_wrapper</code>或者其它方式赋值函数属性。</p>

<h3>标准库中的示例</h3>

<p>首先要提及的是标准库中有一些实用的装饰器，有三种装饰器：</p>

<ul>
<li>
<p><code>classmethod</code>让一个方法变成“类方法”，即它能够无需创建实例调用。当一个常规方法被调用时，解释器插入实例对象作为第一个参数<code>self</code>。当类方法被调用时，类本身被给做第一个参数，一般叫<code>cls</code>。</p>

<p>类方法也能通过类命名空间读取，所以它们不必污染模块命名空间。类方法可用来提供替代的构建器(constructor):</p>

<pre><code>class Array(object):
    def __init__(self, data):
        self.data = data

    @classmethod
    def fromfile(cls, file):
        data = numpy.load(file)
        return cls(data)
</code></pre>

<p>这比用一大堆标记的<code>__init__</code>简单多了。</p>
</li>
<li><p><code>staticmethod</code>应用到方法上让它们“静态”，例如，本来一个常规函数，但通过类命名空间存取。这在函数仅在类中需要时有用(它的名字应该以<code>_</code>为前缀)，或者当我们想要用户以为方法连接到类时也有用——虽然对实现本身不必要。</p></li>
<li>
<p><code>property</code>是对getter和setter问题Python风格的答案。通过<code>property</code>装饰的方法变成在属性存取时自动调用的getter。</p>

<pre><code>&gt;&gt;&gt; class A(object):
...   @property
...   def a(self):
...     "an important attribute"
...     return "a value"
&gt;&gt;&gt; A.a                                   
&lt;property object at 0x...&gt;
&gt;&gt;&gt; A().a
'a value'
</code></pre>

<p>例如<code>A.a</code>是只读属性，它已经有文档了：<code>help(A)</code>包含从getter方法获取的属性<code>a</code>的文档字符串。将<code>a</code>定义为property使它能够直接被计算，并且产生只读的副作用，因为没有定义任何setter。</p>

<p>为了得到setter和getter，显然需要两个方法。从Python 2.6开始首选以下语法：</p>

<pre><code>class Rectangle(object):
    def __init__(self, edge):
        self.edge = edge

    @property
    def area(self):
        """Computed area.

        Setting this updates the edge length to the proper value.
        """
        return self.edge**2

    @area.setter
    def area(self, area):
        self.edge = area ** 0.5
</code></pre>

<p>通过<code>property</code>装饰器取代带一个属性(property)对象的getter方法，以上代码起作用。这个对象反过来有三个可用于装饰器的方法<code>getter</code>、<code>setter</code>和<code>deleter</code>。它们的作用就是设定属性对象的getter、setter和deleter(被存储为<code>fget</code>、<code>fset</code>和<code>fdel</code>属性(attributes))。当创建对象时，getter可以像上例一样设定。当定义setter时，我们已经在<code>area</code>中有property对象，可以通过<code>setter</code>方法向它添加setter，一切都在创建类时完成。</p>

<p>之后，当类实例创建后，property对象和特殊。当解释器执行属性存取、赋值或删除时，其执行被下放给property对象的方法。</p>

<p>为了让一切一清二楚[^5]，让我们定义一个“调试”例子：</p>

<pre><code>&gt;&gt;&gt; class D(object):
...    @property
...    def a(self):
...      print "getting", 1
...      return 1
...    @a.setter
...    def a(self, value):
...      print "setting", value
...    @a.deleter
...    def a(self):
...      print "deleting"
&gt;&gt;&gt; D.a                                    
&lt;property object at 0x...&gt;
&gt;&gt;&gt; D.a.fget                               
&lt;function a at 0x...&gt;
&gt;&gt;&gt; D.a.fset                               
&lt;function a at 0x...&gt;
&gt;&gt;&gt; D.a.fdel                               
&lt;function a at 0x...&gt;
&gt;&gt;&gt; d = D()               # ... varies, this is not the same `a` function
&gt;&gt;&gt; d.a
getting 1
1
&gt;&gt;&gt; d.a = 2
setting 2
&gt;&gt;&gt; del d.a
deleting
&gt;&gt;&gt; d.a
getting 1
1
</code></pre>

<p>属性(property)是对装饰器语法的一点扩展。使用装饰器的一大前提——命名不重复——被违反了，但是目前没什么更好的发明。为getter，setter和deleter方法使用相同的名字还是个好的风格。</p>
</li>
</ul>
<p>一些其它更新的例子包括：</p>

<ul>
<li>
<code>functools.lru_cache</code>记忆任意维持有限 参数：结果 对的缓存函数(Python<br>
3.2)</li>
<li>
<code>functools.total_ordering</code>是一个基于单个比较方法而填充丢失的比较(ordering)方法(<code>__lt__</code>,<code>__gt__</code>，<code>__le__</code>等等)的类装饰器。</li>
</ul>
<h3>函数的废弃</h3>

<p>比如说我们想在第一次调用我们不希望被调用的函数时在标准错误打印一个废弃函数警告。如果我们不想更改函数，我们可用装饰器</p>

<pre><code>class deprecated(object):
    """Print a deprecation warning once on first use of the function.

    &gt;&gt;&gt; @deprecated()                    # doctest: +SKIP
    ... def f():
    ...     pass
    &gt;&gt;&gt; f()                              # doctest: +SKIP
    f is deprecated
    """
    def __call__(self, func):
        self.func = func
        self.count = 0
        return self._wrapper
    def _wrapper(self, *args, **kwargs):
        self.count += 1
        if self.count == 1:
            print self.func.__name__, 'is deprecated'
        return self.func(*args, **kwargs)
</code></pre>

<p>也可以实现成函数：</p>

<pre><code>def deprecated(func):
    """Print a deprecation warning once on first use of the function.

    &gt;&gt;&gt; @deprecated                      # doctest: +SKIP
    ... def f():
    ...     pass
    &gt;&gt;&gt; f()                              # doctest: +SKIP
    f is deprecated
    """
    count = [0]
    def wrapper(*args, **kwargs):
        count[0] += 1
        if count[0] == 1:
            print func.__name__, 'is deprecated'
        return func(*args, **kwargs)
    return wrapper
</code></pre>

<h3>while-loop移除装饰器</h3>

<p>例如我们有个返回列表的函数，这个列表由循环创建。如果我们不知道需要多少对象，实现这个的标准方法如下：</p>

<pre><code>def find_answers():
    answers = []
    while True:
        ans = look_for_next_answer()
        if ans is None:
            break
        answers.append(ans)
    return answers
</code></pre>

<p>只要循环体很紧凑，这很好。一旦事情变得更复杂，正如真实的代码中发生的那样，这就很难读懂了。我们可以通过<code>yield</code>语句简化它，但之后用户不得不显式调用嗯<code>list(find_answers())</code>。</p>

<p>我们可以创建一个为我们构建列表的装饰器：</p>

<pre><code>def vectorized(generator_func):
    def wrapper(*args, **kwargs):
        return list(generator_func(*args, **kwargs))
    return functools.update_wrapper(wrapper, generator_func)
</code></pre>

<p>然后函数变成这样：</p>

<pre><code>@vectorized
def find_answers():
    while True:
        ans = look_for_next_answer()
        if ans is None:
            break
        yield ans
</code></pre>

<h3>插件注册系统</h3>

<p>这是一个仅仅把它放进全局注册表中而不更改类的类装饰器，它属于返回被装饰对象的装饰器。</p>

<pre><code>class WordProcessor(object):
    PLUGINS = []
    def process(self, text):
        for plugin in self.PLUGINS:
            text = plugin().cleanup(text)
        return text

    @classmethod
    def plugin(cls, plugin):
        cls.PLUGINS.append(plugin)

@WordProcessor.plugin
class CleanMdashesExtension(object):
    def cleanup(self, text):
        return text.replace('&amp;mdash;', u'\N{em dash}')
</code></pre>

<p>这里我们使用装饰器完成插件注册。我们通过一个名词调用装饰器而不是一个动词，因为我们用它来声明我们的类是<code>WordProcessor</code>的一个插件。<code>plugin</code>方法仅仅将类添加进插件列表。</p>

<p>关于插件自身说下：它用真正的Unicode中的破折号符号替代HTML中的破折号。它利用<a rel="nofollow" href="http://docs.python.org/2.7/reference/lexical_analysis.html#string-literals">unicode literal notation</a>通过它在unicode数据库中的名称(“EM DASH”)插入一个符号。如果直接插入Unicode符号，将不可能区分所插入的和源程序中的破折号。</p>

<h3>更多例子和参考</h3>

<ul>
<li>
<a rel="nofollow" href="http://www.python.org/dev/peps/pep-0318">PEP 310</a>(函数和方法装饰语法)</li>
<li>
<a rel="nofollow" href="http://www.python.org/dev/peps/pep-3129">PEP 3129</a>(类装饰语法)</li>
<li>
<a rel="nofollow" href="http://wiki.python.org/moin/PythonDecoratorLibrary"></a><a rel="nofollow" href="http://wiki.python.org/moin/PythonDecoratorLibrary">http://wiki.python.org/moin/PythonDecoratorLibrary</a>
</li>
<li>
<a rel="nofollow" href="http://docs.python.org/dev/library/functools.html"></a><a rel="nofollow" href="http://docs.python.org/dev/library/functools.html">http://docs.python.org/dev/library/functools.html</a>
</li>
<li>
<a rel="nofollow" href="http://pypi.python.org/pypi/decorator"></a><a rel="nofollow" href="http://pypi.python.org/pypi/decorator">http://pypi.python.org/pypi/decorator</a>
</li>
<li>Bruce Eckel<br><br><ul>
<li>
<a rel="nofollow" href="http://www.artima.com/weblogs/viewpost.jsp?thread=240808">装饰器I</a>:介绍Python装饰器</li>
<li>
<a rel="nofollow" href="http://www.artima.com/weblogs/viewpost.jsp?thread=240845">Python装饰器II</a>：装饰器参数</li>
<li>
<a rel="nofollow" href="http://www.artima.com/weblogs/viewpost.jsp?thread=241209">Python装饰器III</a>：一个基于装饰器构建的系统</li>
</ul>
</li>
</ul>
<h2>上下文管理器</h2>

<p>上下文管理器是可以在<code>with</code>语句中使用，拥有<code>__enter__</code>和<code>__exit__</code>方法的对象。</p>

<pre><code>with manager as var:
    do_something(var)
</code></pre>

<p>相当于以下情况的简化：</p>

<pre><code>var = manager.__enter__()
try:
    do_something(var)
finally:
    manager.__exit__()
</code></pre>

<p>换言之，<a rel="nofollow" href="http://www.python.org/dev/peps/pep-0343">PEP 343</a>中定义的上下文管理器协议允许将无聊的<code>try...except...finally</code>结构抽象到一个单独的类中，仅仅留下关注的<code>do_something</code>部分。</p>

<ol>
<li>
<code>__enter__</code>方法首先被调用。它可以返回赋给<code>var</code>的值。<code>as</code>部分是可选的：如果它不出现，<code>enter</code>的返回值简单地被忽略。</li>
<li>
<code>with</code>语句下的代码被执行。就像<code>try</code>子句，它们或者成功执行到底，或者<code>break</code>，<code>continue</code>或<code>return</code>，或者可以抛出异常。无论哪种情况，该块结束后，<code>__exit__</code>方法被调用。如果抛出异常，异常信息被传递给<code>__exit__</code>，这将在下一章节讨论。通常情况下，异常可被忽略，就像在<code>finally</code>子句中一样，并且将在<code>__exit__</code>结束后重新抛出。</li>
</ol>
<p>比如说我们想确认一个文件在完成写操作之后被立即关闭：</p>

<pre><code>&gt;&gt;&gt; class closing(object):
...   def __init__(self, obj):
...     self.obj = obj
...   def __enter__(self):
...     return self.obj
...   def __exit__(self, *args):
...     self.obj.close()
&gt;&gt;&gt; with closing(open('/tmp/file', 'w')) as f:
...   f.write('the contents\n')
</code></pre>

<p>这里我们确保了当<code>with</code>块退出时调用了<code>f.close()</code>。因为关闭文件是非常常见的操作，该支持已经出现在<code>file</code>类之中。它有一个<code>__exit__</code>方法调用<code>close</code>，并且本身可作为上下文管理器。</p>

<pre><code>&gt;&gt;&gt; with open('/tmp/file', 'a') as f:
...   f.write('more contents\n')
</code></pre>

<p><code>try...finally</code>常见的用法是释放资源。各种不同的情况实现相似：在<code>__enter__</code>阶段资源被获得，在<code>__exit__</code>阶段释放，如果抛出异常也被传递。正如文件操作，往往这是对象使用后的自然操作，内置支持使之很方便。每一个版本，Python都在更多的地方提供支持。</p>

<ul>
<li>所有类似文件的对象：<br><br><ul>
<li>
<code>file</code> ➔ 自动关闭</li>
<li>
<code>fileinput</code>,<code>tempfile</code>(py &gt;= 3.2)</li>
<li>
<code>bz2.BZ2File</code>，<code>gzip.GzipFile</code>,<br><code>tarfile.TarFile</code>,<code>zipfile.ZipFile</code>
</li>
<li>
<code>ftplib</code>, <code>nntplib</code> ➔ 关闭连接(py &gt;= 3.2)</li>
</ul>
</li>
<li>锁<br><br><ul>
<li>
<code>multiprocessing.RLock</code> ➔ 锁定和解锁</li>
<li><code>multiprocessing.Semaphore</code></li>
<li>
<code>memoryview</code> ➔ 自动释放(py &gt;= 3.2 或 3.3)</li>
</ul>
</li>
<li>
<code>decimal.localcontext</code>➔ 暂时更改计算精度</li>
<li>
<code>_winreg.PyHKEY</code> ➔ 打开和关闭Hive Key</li>
<li>
<code>warnings.catch_warnings</code> ➔ 暂时杀死(kill)警告</li>
<li>
<code>contextlib.closing</code> ➔ 如上例，调用<code>close</code>
</li>
<li>并行编程<br><br><ul>
<li>
<code>concurrent.futures.ThreadPoolExecutor</code> ➔<br>
并行调用然后杀掉线程池(py &gt;= 3.2)</li>
<li>
<code>concurrent.futures.ProcessPoolExecutor</code> ➔<br>
并行调用并杀死进程池(py &gt;= 3.2)</li>
<li>
<code>nogil</code> ➔ 暂时解决GIL问题(仅仅cyphon ：（)</li>
</ul>
</li>
</ul>
<h3>捕获异常</h3>

<p>当一个异常在<code>with</code>块中抛出时，它作为参数传递给<code>__exit__</code>。三个参数被使用，和<code>sys.exc_info()</code>返回的相同：类型、值和回溯(traceback)。当没有异常抛出时，三个参数都是<code>None</code>。上下文管理器可以通过从<code>__exit__</code>返回一个真(True)值来“吞下”异常。例外可以轻易忽略，因为如果<code>__exit__</code>不使用<code>return</code>直接结束，返回<code>None</code>——一个假(False)值，之后在<code>__exit__</code>结束后重新抛出。</p>

<p>捕获异常的能力创造了有意思的可能性。一个来自单元测试的经典例子——我们想确保一些代码抛出正确种类的异常：</p>

<pre><code>class assert_raises(object):
    # based on pytest and unittest.TestCase
    def __init__(self, type):
        self.type = type
    def __enter__(self):
        pass
    def __exit__(self, type, value, traceback):
        if type is None:
            raise AssertionError('exception expected')
        if issubclass(type, self.type):
            return True # swallow the expected exception
        raise AssertionError('wrong exception type')

with assert_raises(KeyError):
    {}['foo']
</code></pre>

<h3>使用生成器定义上下文管理器</h3>

<p>当讨论生成器时，据说我们相比实现为类的迭代器更倾向于生成器，因为它们更短小方便，状态被局部保存而非实例和变量中。另一方面，正如双向通信章节描述的那样，生成器和它的调用者之间的数据流可以是双向的。包括异常，可以直接传递给生成器。我们想将上下文管理器实现为特殊的生成器函数。事实上，生成器协议被设计成支持这个用例。</p>

<pre><code>@contextlib.contextmanager
def some_generator(&lt;arguments&gt;):
    &lt;setup&gt;
    try:
        yield &lt;value&gt;
    finally:
        &lt;cleanup&gt;
</code></pre>

<p><code>contextlib.contextmanager</code>装饰一个生成器并转换为上下文管理器。生成器必须遵循一些被包装(wrapper)函数强制执行的法则——最重要的是它至少<code>yield</code>一次。<code>yield</code>之前的部分从<code>__enter__</code>执行，上下文管理器中的代码块当生成器停在<code>yield</code>时执行，剩下的在<code>__exit__</code>中执行。如果异常被抛出，解释器通过<code>__exit__</code>的参数将之传递给包装函数，包装函数于是在yield语句处抛出异常。通过使用生成器，上下文管理器变得更短小精炼。</p>

<p>让我们用生成器重写<code>closing</code>的例子：</p>

<pre><code>@contextlib.contextmanager
def closing(obj):
    try:
        yield obj
    finally:
        obj.close()
</code></pre>

<p>再把<code>assert_raises</code>改写成生成器：</p>

<pre><code>@contextlib.contextmanager
def assert_raises(type):
    try:
        yield
    except type:
        return
    except Exception as value:
        raise AssertionError('wrong exception type')
    else:
        raise AssertionError('exception expected')
</code></pre>

<p>这里我们用装饰器将生成函数转化为上下文管理器！</p>

<hr>
<p>原文 <a rel="nofollow" href="http://scipy-lectures.github.com/advanced/advanced_python/index.html">Advanced Python Constructs</a><br>
翻译 <a rel="nofollow" href="http://reverland.org/python/2013/03/13/advanced-python-constructs/">reverland</a></p>

                </div>
                                                
                <div class="clearfix mt10">
                    <ul class="article-operation list-inline pull-left mt15"><li><a target="_blank"href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><img class="mb5" src="https://static.segmentfault.com/v-5bebf0aa/global/img/creativecommons-cc.svg" height="20"/></a></li><li class="dropdown js__content-ops hidden-xs" data-module="article"
                                data-id="1190000000498466"
                                data-typetext="文章"><a href="javascript:void(0);" class="dropdown-toggle text-muted" data-toggle="dropdown"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></a><ul class="dropdown-menu dropdown-menu-left"><li><a href="#911"
                                           data-toggle="modal"
                                           data-target="#911"
                                           data-action="report"
                                        >举报</a></li></ul></li></ul>
                    <div class="pull-right mt-10 hidden-xs">
                        <div class="widget-share__full" data-text="Python 高级特性"
 data-url="https://segmentfault.com/a/1190000000498466" data-shorturl="http://sfau.lt/b5cfPW"></div>


                    </div>
                </div>
                <div class="mt10 text-center mb30"><button type="button" id="mainLike" data-id="1190000000498466"
                                    class="btn btn-success btn-lg mr15 "><span id="mainLikeText">赞</span>&nbsp;&nbsp;<span class="seprator">|</span>&nbsp;&nbsp;
                                <span id="mainLikeNum">4 </span></button><button type="button" id="mainBookmark" data-type="article" data-id="1190000000498466"
                                    class="btn btn-default btn-lg "><span id="mainBookmarkText">收藏</span>&nbsp;&nbsp;<span class="seprator">|</span>&nbsp;&nbsp;<span id="mainBookmarkNum">47</span></button><br><button type="button" data-id="1190000000498466"
                                        class="btn btn-danger btn-lg mt15 article__reward-btn">
                                    赞赏支持
                                </button></div><div class="mt30 mb30 text-center article__reward-info"><span class="mr10">如果觉得我的文章对你有用，请随意赞赏</span></div>                
                                <script type='text/javascript'>
                    OA_show(3);
                </script>

                <h4 class="pt20 mb15 mt0 border-top">你可能感兴趣的</h4>

                
                <div class="mb15 block">
                    <script type='text/javascript'>
                        OA_show(4);
                    </script>
                </div>

                                <div id="paradigm-article-related"></div>

                
        <div class="comments--news comments--default comments--article 
    " 
    data-id="1190000000498466" data-user-id="" data-author-id="1030000000323597 "
         data-is-admin="null" id="goToReplyArea">
                    <div class="mb10 clearfix">
                <strong class="comments-stat pull-left mr10">1 条评论</strong>

                                                    <div class="btn-group btn-group-xs pull-right comments-sort btn-group-menu" role="menu">
                        <a href="javascript:;" 
                           class="btn btn-default active" data-sort="default">默认排序</a>
                        <a href="javascript:;" 
                           class="btn btn-default" data-sort="desc">时间排序</a>
                    </div>
                            </div>
                <div class="comments-container">
                                <div class="comments-list">
                <div class="comments-item" data-id="1050000002462518">
            <div class="pull-left">
                <a href="/u/shiweifu" target="_blank"><img class="avatar-32 " src="https://avatar-static.segmentfault.com/462/544/462544448-5abc468cd28d1_big64" alt=""></a>
            </div>
            <div class="comments-content">
                <div class="comment-trigger">
                    <div class="pull-right comment-option">
                                                <a href="#911" class="ml10" data-toggle="modal" data-target="#911" data-action="report" data-action-text="举报" data-module="comment" data-id="1050000002462518" data-typetext="评论" data-placement="top" title="举报"><span class="glyphicon glyphicon-flag" aria-hidden="true"></span></a>
                                            </div>
                    <strong><a target="_blank" href="/u/shiweifu">shiweifu</a></strong>
                    <span class="comments-isAuthor hide"></span>
                    <span class="comments-date">  ·  2015年01月04日</span>
                </div>

                <div class="fmt mb10">
<p>总结的很好，感谢 lz 分享</p>
</div>

                <form action="/api/comment/1050000002462518/edit">
                    <div class="form-group">
                        <textarea class="editTextarea mono form-control mb10 hidden" rows="1" name="text" style="height: 28px; overflow: hidden; word-wrap: break-word;" >总结的很好，感谢 lz 分享</textarea>
                    </div>
                </form>

                <p class="comment-ops not-reply">
                    <span class="comments-zan ">
                        <i class="fa fa-thumbs-up mr4" aria-hidden="true"></i>
                        <span class="comments-zan-text">赞</span>
                        <span class="comments-zan-value"></span>
                    </span>
                    
                    <span class="ml15 comments-reply-btn">回复</span>

                    <span class="pull-right editBtns hidden">
                      <button class="btn btn-link btn-xs cancel" type="button">取消</button>
                      <button class="btn btn-primary btn-xs edit ml10" type="button">保存</button>
                    </span>
                </p>

                <div class="reply-list reply-list--empty">

                    
                    <div class="reply-item reply-item--ops" data-obj="obj">
                        <a class="reply-inner-btn" href="javascript:;">添加回复</a>
                        
                    </div>
                </div>


            </div>
        </div>
            </div>
    <div class="comments-loading hide">载入中...</div>
        <div class="comments-more hide"><a href="javascript:;">显示更多评论</a></div>
    

                                    <div class="comments-box" id="goToReplyEditor">
                <div class="pull-left">
                    <img class="avatar-32 "
                         src="https://static.segmentfault.com/v-5bebf0aa/global/img/user-128.png"
                         alt=""/>
                </div>
                <div class="comments-box-content">
                    <form action="/api/article/1190000000498466/comments/add">
                        <div class="form-group mb0">
                            <textarea name="text" rows="3" class="form-control"placeholder="文明社会，理性评论"></textarea>
                            <div class="mt15 text-right">
                                <button type="button" class="hide"></button>
                                <button class=" btn btn-primary" type="button">发布评论</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
                                                        </div>
    </div>


                                    
                
                

            </div><!-- /.main -->


            <div class="col-md-3 side hidden-sm hidden-xs mt30">
                                                
                <div class="mb25 hidden-md hidden-sm hidden-xs">
    <img src="https://static.segmentfault.com/sponsor/20181120.png" alt="Planets" usemap ="#gridsMap" width=255 height=136>
    <map name="gridsMap" id="gridsMap"></map>
    <div style="text-align: center;"><a style="text-align:center; color:#9E9E9E; font-size:12px" href="/sponsor">想在上方展示你的广告？</a></div>
            <script async src="https://static.segmentfault.com/sponsor/20181120.js"></script>
    </div>

                                <style>
                    .job-recommend-area a:not(:last-of-type) {margin-bottom:10px; display: block}
                    .job-recommend-area a:hover {text-decoration: none;}
                </style>
                <div class="hidden-md">
                    <div class="job-recommend">
                      <h3 class="job-title">推广链接</h3>
                      <div class="job-recommend-area">
                                                <script type='text/javascript'>
                            OA_show(7);
                            OA_show(9);
                            OA_show(10);
                            OA_show(15);
                            OA_show(16);
                        </script>
                      </div>
                    </div>
                    <style>
                    .job-recommend {margin-bottom: 30px;}
                    .job-title {
                        font-size: 14px;
                        color: #017E66;
                        font-weight: 500;
                        background: #BFE6D7;
                        margin: 0;
                        padding-top: 6px;
                        padding-bottom: 6px;
                        text-align: center;
                    }
                    .job-recommend-area {
                      padding: 13px;
                      border: 3px solid #EBF7F3;
                      border-top: none;
                    }
                    </style>
                    
                                    </div>

                                
                <div class="hidden-md ad-should-be-fixed">
                    <div class="mb25 block">
                        <script type='text/javascript'>
                            OA_show(1);
                        </script>
                    </div>
                </div>
                <div class="post-nav hidden-xs">
                    <div class="panel panel-default widget-outline">
                        <div class="panel-heading">目录</div>
                        <div class="panel-body">
                            <div class="nav-body" style="overflow:scroll">
                                <div class="highlight-title"></div>
                                <ul class="articleIndex"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                
            </div><!-- /.side -->
        </div>
    </div>
</div>

<div id="shareToWeiboModal" class="modal" tabindex='-1'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">×</span><span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title">分享</h4>
            </div>
            <div class="modal-body">
                <p class="sfModal-content">
                    分享到微博？
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default dont-likeweibo" data-dismiss="modal">取消</button>
                <a href="" id="shareLink" class="btn btn-primary done-btn" target="_blank"
                   onclick="$('#shareToWeiboModal').modal('hide')">分享</a>
            </div>
        </div>
    </div>
</div>


<div class="modal widget-911" id="911" tabindex='-1'>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button class="close" data-dismiss="modal" type="button">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <h4 class="modal-title"><span data-model="action"></span><span data-model="type"></span></h4>
      </div>
      <div class="modal-body">
        <form id="reportForm">
          <!-- 后台返回信息 -->
          <p class="alert alert-warning" data-model="returnMsg"></p>
          <div data-role="base">
            <p>
              <strong class="required">我要<span data-model="action"></span>该<span data-model="type"></span>，理由是：</strong>
            </p>
            <ul class="list-unstyled" data-model="list"></ul>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default pull-left" type="button" data-role="back" style="display:none">返回重选</button>
                <button class="btn btn-default" data-dismiss="modal" type="button">取消</button>
        <button class="btn btn-primary" data-role="submit" type="button">提交</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<div class="modal widget-seo" id="seo" tabindex='-1'>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title"><span data-model="action"></span><span data-model="type"></span></h4>
            </div>
            <div class="modal-body">
                <form id="seoForm">
                    <!-- 后台返回信息 -->
                    <p class="alert alert-warning" data-model="returnMsg"></p>
                    <div data-role="base">
                        <div class="form-group">
                            <label>SEO标题：</label><textarea style="min-height: 35px; width: 100%; max-height: 132px; overflow: hidden; overflow-wrap: break-word; height: 32px;" name="title" class="form-control" rows="1" placeholder="请输入SEO标题"></textarea>
                        </div>
                        <div class="form-group">
                            <label>SEO描述：</label><textarea style="min-height: 35px; max-height: 132px; overflow: hidden; overflow-wrap: break-word; height: 32px;" name="desc" class="form-control" rows="1" placeholder="请输入SEO描述"></textarea>
                        </div>
                        <div class="form-group">
                            <label>SEO keywords：</label><textarea style="min-height: 35px; max-height: 132px; overflow: hidden; overflow-wrap: break-word; height: 32px;" name="keywords" class="form-control" rows="1" placeholder="请输入SEO keywords"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal" type="button">取消</button>
                <button class="btn btn-primary" data-role="submit" type="button">提交</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

    <div id="loginBanner"  class="hidden-sm hidden-xs loginBanner">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 col-md-7">
                <h1 class="title">在 SegmentFault，学习技能、解决问题</h1>
                <p class="desc">每个月，我们帮助 1000 万的开发者解决各种各样的技术问题。并助力他们在技术能力、职业生涯、影响力上获得提升。</p>
            </div>
            <div class="col-lg-3 col-lg-offset-3 col-md-4 col-md-offset-1">
                <form class="register-form clearfix" action="/api/user/phone/register">

                    
                    <a href="/user/register" class="SFLogin btn btn-lg btn-primary mr15">免费注册</a>
                    <a href="/user/login" class="SFRegister btn btn-lg btn-primary">立即登录</a>
                </form>
            </div>
        </div>
    </div>
    </div>






<footer id="footer">
    <div class="container">
        <div class="row hidden-xs">
            <dl class="col-sm-2 site-link">
                <dt>产品</dt>
                
                <dd><a href="/questions/hottest?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=热门问答">热门问答</a></dd>
                <dd><a href="/blogs/hottest?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=热门专栏">热门专栏</a></dd>
                <dd><a href="/lives?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=热门讲堂">热门讲堂</a></dd>
                <dd><a href="/events?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=最新活动">最新活动</a></dd>
                <dd><a href="/groups?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=圈子">圈子</a></dd>
                <dd><a href="/jobs?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=找工作">找工作</a></dd>
                <dd><a href="/app?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=product&utm_content=footer-links-hottest-questions&utm_term=app">移动客户端</a></dd>
                
            </dl>
            
            <dl class="col-sm-2 site-link">
                <dt>资源</dt>
                <dd><a href="/weekly?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-weekly&utm_term=每周精选">每周精选</a></dd>
                <dd><a href="/users?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-users&utm_term=用户排行榜">用户排行榜</a></dd>
                <dd><a href="/badges?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-badges&utm_term=徽章">徽章</a></dd>
                <dd><a href="/faq?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-faq&utm_term=帮助中心">帮助中心</a></dd>
                <dd><a href="/repu?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-repu&utm_term=声望与权限">声望与权限</a></dd>
                <dd><a href="/community?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-community&utm_term=社区服务中心">社区服务中心</a></dd>
                <dd><a href="https://docs.segmentfault.com?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=resource&utm_content=footer-links-docs&utm_term=开发手册">开发手册</a></dd>

   
            </dl>

            <dl class="col-sm-2 site-link">
                <dt>商务</dt>
                <dd><a href="https://business.segmentfault.com/services?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-services-rencai&utm_term=人才服务" target="_blank">人才服务</a></dd>
                <dd><a href="https://business.segmentfault.com/services?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-services-qiyeneixun&utm_term=企业服务" target="_blank">企业培训</a></dd>
                <dd><a href="https://business.segmentfault.com/services?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-services-huodongcehua&utm_term=活动策划" target="_blank">活动策划</a></dd>
                <dd><a href="https://business.segmentfault.com/ads?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-ads&utm_term=广告投放" target="_blank">广告投放</a></dd>
                <dd><a href="https://business.segmentfault.com/bc?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-bc&utm_term=区块链解决方案" target="_blank">区块链解决方案</a></dd>
                <dd><a href="https://business.segmentfault.com/contact?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=business&utm_content=footer-links-contact&utm_term=合作联系" target="_blank">合作联系</a></dd>
            </dl>
            
            <dl class="col-sm-2 site-link">
                <dt>关于</dt>
                <dd><a href="https://about.segmentfault.com/?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=about&utm_content=about-index&utm_term=关于我们">关于我们</a></dd>
                <dd><a href="https://about.segmentfault.com/careers.html?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=about&utm_content=about-careers&utm_term=加入我们">加入我们</a></dd>
                <dd><a href="https://about.segmentfault.com/contact.html?utm_source=sf-footer&utm_medium=footer-nav&utm_campaign=about&utm_content=about-contact&utm_term=联系我们">联系我们</a></dd>
            </dl>

            <dl class="col-sm-2 site-link">
                <dt>关注</dt>
                                <dd><a href="//segmentfault.com/blog/segmentfault" target="_blank">产品技术日志</a></dd>
                                <dd><a href="//segmentfault.com/blog/community_admin" target="_blank">社区运营日志</a></dd>
                                <dd><a href="//segmentfault.com/blog/segmentfault_news" target="_blank">市场运营日志</a></dd>
                                <dd><a href="//segmentfault.com/blog/segmentfault_team" target="_blank">团队日志</a></dd>
                                <dd><a href="//segmentfault.com/blog/interview" target="_blank">社区访谈</a></dd>
                                <dd>
                    <ul class="sn-inline">
                        <li>
                            <a class="entypo-wechart icon-sn-weixin weixin-popover-qrcode" data-toggle="popover" data-placement="top"  data-content="">微信</a>
                        </li>
                        <li>
                            <a href="http://weibo.com/segmentfault" target="_blank" class="entypo-weibo icon-sn-weibo" >新浪微博</a>
                        </li>
                        <li>
                            <a href="https://github.com/SegmentFault" target="_blank" class="entypo-facebook icon-sn-github">Github</a>
                        </li>
                        <li>
                            <a href="https://twitter.com/segment_fault" target="_blank" class="entypo-twitter icon-sn-twitter">Twitter</a>
                        </li>
                    </ul>
                </dd>
            </dl>

            <dl class="col-sm-2 site-link" id="license">
                <dt>条款</dt>
                <dd><a href="/tos">服务条款</a></dd>
                <dd><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">内容许可</a></dd>
                <dd>
                    <a href="/app" class="clearfix mt10 block"><img src="https://static.segmentfault.com/v-5bebf0aa/page/img/app/appQrcode.png" class="app-qrcode"></a>
                    <div class="app-download-desc">
                        <p>扫一扫下载 App</p>
                    </div>
                    
                </dd>
            </dl>
        </div>
        <div class="copyright">
            Copyright &copy; 2011-2018 SegmentFault. 当前呈现版本 17.06.16<br>
            <a href="http://www.miibeian.gov.cn/" rel="nofollow">浙ICP备 15005796号-2</a> &nbsp;
            <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010602002000" rel="nofollow">浙公网安备 33010602002000号</a>
            <span class="ml5">杭州堆栈科技有限公司版权所有</span>
            <P class="mt30">CDN 存储服务由 <a target="_blank" href="https://www.upyun.com/?utm_source=segmentfault&utm_medium=link&utm_campaign=upyun&md=segmentfault">又拍云</a> 赞助提供 </p>
        </div>
        <p class="text-center">
            <a class="js__view--selector hidden-sm hidden-md hidden-lg" data-action="mobile" href="javascript:;">移动版</a>
            <a class="js__view--selector hidden-sm hidden-md hidden-lg" data-action="desktop" href="javascript:;">桌面版</a>
        </p>
    </div>
</footer>

<div id="fixedTools" class="hidden-xs hidden-sm">
    <a id="backtop" class="hidden border-bottom" href="#">回顶部</a>
</div>

    <script id="loginModal" type="text/template">
    <div class="row bg-white login-modal">
        <div class="col-md-12 login-wrap">
            <form action="/api/user/login" method="POST" role="form" class="mt15">
                <div class="form-group hidden">
                                        <input type="text" class="form-control" name="remember" value="1"
                           autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="username" class="control-label">手机号 或 Email</label>
                    <input type="text" class="form-control" name="username" tabindex="1" required placeholder="11 位手机号 或 Email"
                           autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="control-label">密码</label><span class="pull-right"><a
                                href="/user/forgot" tabindex="4">忘记密码</a></span>
                    <input type="password" class="form-control" name="password" tabindex="2" required placeholder="请输入密码">
                </div>
                <div class="form-group">
                    <a
                            
                                                    href="/user/phoneLogin"
                            class="phoneLogin"
                                            >手机验证码登录</a>
                </div>
                <div class="form-group clearfix">
                    <button type="submit" class="btn-block btn btn-primary pull-right pl20 pr20" tabindex="3"
                            onclick='ga("send", "event", "email login button", "clicked", "login modal");'>登录
                    </button>
                </div>
            </form>
            <div class="text-muted text-center more-login-area">
    <span class="more-login-words">更多登录方式</span>
</div>
<div class="widget-login mb15 text-center">
    <a href="/user/oauth/google" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "google"});'><span
                class="icon-sn-google"></span></a>
    <a href="/user/oauth/github" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "github"});");'><span
                class="icon-sn-github"></span></a>
    <a href="/user/oauth/weibo" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "weibo"});'><span
                class="icon-sn-weibo"></span></a>
    <a href="/user/oauth/qq" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-qq"></span></a>
    <a href="/user/oauth/weixin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-weixin"></span></a>
    <a href="/user/oauth/linkedin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "linkedin"});'><span
                class="icon-sn-linkedin"></span></a>
    <span id="loginShowMore" style="cursor: pointer" class="mb5"><span class="icon-sn-dotted"></span></span>
    <a href="/user/oauth/twitter" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "twitter"});'><span
                class="icon-sn-twitter"></span></a>
    <a href="/user/oauth/facebook" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "facebook"});'><span
                class="icon-sn-facebook"></span></a>
    <a href="/user/oauth/douban" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "douban"});'><span
                class="icon-sn-douban"></span></a>
</div>
<div class="form-group clearfix">
    <a class="btn-block btn btn-default pull-right pl20 pr20 
                        SFLogin
             "

            
        onclick='ga("send", "event", "email login button", "clicked", "login modal");'>
                    注册新账号
            </a>
</div>
<p class="text-muted text-center mb15">登录即表示你同意网站的<a href="/tos" target="_blank">《服务条款》</a></p>        </div>
    </div>
</script>
    <script id="registerModal" type="text/template">
    <div class="row bg-white login-modal">
        <div class="col-md-12 login-wrap">
            
            <form action="/api/user/register" method="POST" role="form" class="mt15">
                <div class="form-group">
                    <label for="name" class="control-label">你的名字</label>
                    <input type="text" class="form-control" name="name" required placeholder="真实姓名或常用昵称">
                </div>
                
                <div class="form-group">
                    <label for="mail" class="control-label">手机号 或 Email</label>
                    <input type="text" class="form-control" id="login-name" name="mail" required placeholder="11 位手机号 或 Email">
                </div>
                
                <input type="text" class="hidden" name="register_type" value="mail">

                <div class="form-group">
                    <div class="phone-register-only hidden">
                        <div class="captchaInput mb10">
                            <input type="text" class="form-control" name="cap" placeholder="右侧的验证码" style="width:50%; display: inline; margin-right: 15px;">
                            <span class="mt10">
                                <a id="loginReloadCaptcha" href="javascript:void(0)">
                                <img src="/user/captcha?w=135&h=34" class="cap" width="135" height="34"/></a>
                            </span>
                        </div>
                        <div class="input-group">
                            <input name="code" type="text" class="form-control js-user-login__phone-code-value" placeholder="短信验证码">
                            <span class="input-group-btn">
                                <button class="btn btn-default js-user-login__phone-vaild-btn" style="width:96px;" type="button">
                                获取验证码</button>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password" class="control-label">密码</label>
                    <input type="password" class="form-control" name="password" required placeholder="不少于 6 位的密码">
                </div>
                <div class="form-group clearfix">
                    <button type="submit" class="btn-block btn btn-primary pl20 pr20 pull-right"
                            onclick='ga("send", "event", "email register button", "clicked", "login modal");'>注册
                    </button>
                </div>
                                <div class="text-muted text-center more-login-area">
    <span class="more-login-words">更多登录方式</span>
</div>
<div class="widget-login mb15 text-center">
    <a href="/user/oauth/google" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "google"});'><span
                class="icon-sn-google"></span></a>
    <a href="/user/oauth/github" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "github"});");'><span
                class="icon-sn-github"></span></a>
    <a href="/user/oauth/weibo" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "weibo"});'><span
                class="icon-sn-weibo"></span></a>
    <a href="/user/oauth/qq" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-qq"></span></a>
    <a href="/user/oauth/weixin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-weixin"></span></a>
    <a href="/user/oauth/linkedin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "linkedin"});'><span
                class="icon-sn-linkedin"></span></a>
    <span id="loginShowMore" style="cursor: pointer" class="mb5"><span class="icon-sn-dotted"></span></span>
    <a href="/user/oauth/twitter" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "twitter"});'><span
                class="icon-sn-twitter"></span></a>
    <a href="/user/oauth/facebook" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "facebook"});'><span
                class="icon-sn-facebook"></span></a>
    <a href="/user/oauth/douban" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "douban"});'><span
                class="icon-sn-douban"></span></a>
</div>
<div class="form-group clearfix">
    <a class="btn-block btn btn-default pull-right pl20 pr20 
                        SFRegister
             "

            
        onclick='ga("send", "event", "email login button", "clicked", "login modal");'>
                    已有账号登录
            </a>
</div>
<p class="text-muted text-center mb15">登录即表示你同意网站的<a href="/tos" target="_blank">《服务条款》</a></p>            </form>
        </div>
    </div>
</script>
    <script id="phoneLoginModal" type="text/template">

    <div class="row bg-white login-modal phonelogin-modal">
        <div class="col-md-12 login-wrap">
            <form action="/api/user/phonelogin" method="POST" role="form" class="mt15">
                <div class="form-group">
                    <label for="phone" class="control-label required">手机号</label>
                    <input type="text" class="form-control phonelogin--phone" name="phone" tabindex="1" required placeholder="11 位手机号"
                           autocomplete="off">
                    <span class="help-block"></span>
                </div>

                <div class="form-group">
                    <label for="authCode" class="control-label required">验证码</label>
                    <div class="input-group">
                        <input type="text" class="form-control bindphone--code" name="authCode" placeholder="短信验证码">
                        <span class="input-group-btn">
                            <button class="btn btn-default user-bind__phone-vaild-btn" type="button">获取验证码</button>
                        </span>
                    </div>
                    <div class="col-sm-3"></div>
                </div>

                <div class="form-group">
                    <a 
                                                            href="/user/login"
                                class="SFRegister"
                                                >密码登录（手机号或 Email）</a>
                </div>
                <div class="form-group clearfix">
                    <button type="submit" class="btn-block btn btn-primary pull-right pl20 pr20" tabindex="3"
                            onclick='ga("send", "event", "email login button", "clicked", "login modal");'>登录
                    </button>
                </div>
            </form>
            <div class="text-muted text-center more-login-area">
    <span class="more-login-words">更多登录方式</span>
</div>
<div class="widget-login mb15 text-center">
    <a href="/user/oauth/google" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "google"});'><span
                class="icon-sn-google"></span></a>
    <a href="/user/oauth/github" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "github"});");'><span
                class="icon-sn-github"></span></a>
    <a href="/user/oauth/weibo" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "weibo"});'><span
                class="icon-sn-weibo"></span></a>
    <a href="/user/oauth/qq" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-qq"></span></a>
    <a href="/user/oauth/weixin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "qq"});'><span
                class="icon-sn-weixin"></span></a>
    <a href="/user/oauth/linkedin" class=""
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "linkedin"});'><span
                class="icon-sn-linkedin"></span></a>
    <span id="loginShowMore" style="cursor: pointer" class="mb5"><span class="icon-sn-dotted"></span></span>
    <a href="/user/oauth/twitter" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "twitter"});'><span
                class="icon-sn-twitter"></span></a>
    <a href="/user/oauth/facebook" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "facebook"});'><span
                class="icon-sn-facebook"></span></a>
    <a href="/user/oauth/douban" class=" hidden"
       onclick='ga("send", "event", "3rd login button", "clicked", "login modal", {media: "douban"});'><span
                class="icon-sn-douban"></span></a>
</div>
<div class="form-group clearfix">
    <a class="btn-block btn btn-default pull-right pl20 pr20 
                        SFLogin
             "

            
        onclick='ga("send", "event", "email login button", "clicked", "login modal");'>
                    注册新账号
            </a>
</div>
<p class="text-muted text-center mb15">登录即表示你同意网站的<a href="/tos" target="_blank">《服务条款》</a></p>        </div>
    </div>
</script>
<script id="bindPhoneModal" type="text/template">
    <div class="bg-white bindphone-model">
        <div class="alert alert-warning" role="alert">
            为了保证账号安全，请先绑定手机
        </div>
        <div>
            <form class="form-horizontal form__bindphone-apply" style="background-color:#fff;padding:0;">
                <div class="form-group ">
                    <label for="phoneNumber" class="col-sm-3 control-label required" >手机号码</label>
                    <div class="col-sm-6">
                        <input type="text" class="form-control bindphone--phone" id="phoneNumber" name="phone" placeholder="仅只支持大陆手机号">
                    </div>
                    <div class="col-sm-3"></div>
                </div>
                <div class="form-group">
                    <label for="authCode" class="col-sm-3 control-label required">验证码</label>
                    <div class="col-sm-6">
                        <div class="input-group">
                            <input type="text" class="form-control bindphone--code" name="code" placeholder="短信验证码">
                            <span class="input-group-btn">
                                <button class="btn btn-default user-bind__phone-vaild-btn" type="button">获取验证码</button>
                            </span>
                        </div>
                    </div>
                    <div class="col-sm-3"></div>
                </div>
            </form>
        </div>

    </div>
</script>


<script>
    window.serverTime = 1542694927000;
</script>

<script>
    (function (w) {
        w.SF = {
            staticUrl: "https://static.segmentfault.com/v-5bebf0aa"
        };
        w.SF.token = (function () {
    var _1wYfMe = 'jh'//'jh'
+'2b4'//'8x'
+'9bb'//'dx'
+/* 'C'//'C' */''+//'d'
'2'+/* 'Xj'//'Xj' */''+'9'//'32'
+'e24'//'z8'
+//'dp'
'fb'+//'V'
'V'+'973'//'Z'
+//'noE'
'f'+//'W'
'22'+'17'//'I2X'
+//'vs1'
'2'+//'gxl'
'gxl'+''///*'xw3'*/'xw3'
+'c6'//'w'
+'dLB'//'dLB'
+'f3'//'8'
+//'klM'
'af'+'o'//'o'
+//'u'
'e'+'c6'//'JBX'
+//'C7'
'C7'+'2'//'o9s'
, _q2zuyH = [[0,2],[13,14],[22,25],[24,27],[28,29],[31,33]];

    for (var i = 0; i < _q2zuyH.length; i ++) {
        _1wYfMe = _1wYfMe.substring(0, _q2zuyH[i][0]) + _1wYfMe.substring(_q2zuyH[i][1]);
    }

    return _1wYfMe;
})();;
    })(window);

                var lock = {
        type: "",
        text: '',
        table: {"ban_post":[1,"\u4f60\u5df2\u7ecf\u88ab\u7981\u8a00, \u65e0\u6cd5\u8fdb\u884c\u6b64\u64cd\u4f5c, \u5982\u6709\u7591\u4e49\u8bf7\u63d0\u4ea4\u7533\u8bc9, \u6216\u8005\u53d1\u90ae\u4ef6\u5230pr@segmentfault.com"]}
    };

        var ddosMode = false;
    
        (function (currentUrl) {
        if (typeof URL != 'undefined') {
            var baseUrl = new URL('https://segmentfault.com');

            if (baseUrl.protocol != currentUrl.protocol
                || baseUrl.host != currentUrl.host) {
                window.location.href = baseUrl.protocol + '//' + baseUrl.host
                    + currentUrl.pathname + currentUrl.search + currentUrl.hash;
            }
        }
    })(window.location);
    </script>

             <script crossorigin src="https://static.segmentfault.com/v-5bebf0aa/3rd/assets.js"></script>
                 
        <script crossorigin src="https://static.segmentfault.com/v-5bebf0aa/blog/script/post.min.js"></script>
            

<script>
if (!!navigator.userAgent.match(/MicroMessenger/i)) {
    require.config({
        paths: { weixin_jsapi: '//res.wx.qq.com/open/js/jweixin-1.2.0' }
    });

    require(['weixin_jsapi'], function (wx) {
        var share = {"title":"Python \u9ad8\u7ea7\u7279\u6027","desc":"\u8fd9\u7ae0\u6709\u5173Python\u4e2d\u88ab\u8ba4\u4e3a\u9ad8\u7ea7\u7684\u7279\u6027\u2014\u2014\u5c31\u662f\u8bf4\u5e76\u4e0d\u662f\u6bcf\u4e2a\u8bed\u8a00\u90fd\u6709\u7684\uff0c\u4e5f\u662f\u8bf4\u5b83\u4eec\u53ef\u80fd\u5728\u66f4\u590d\u6742\u7684\u7a0b\u5e8f\u6216\u5e93\u4e2d\u66f4\u6709\u7528\uff0c\u4f46\u4e0d\u662f\u8bf4\u7279\u522b\u7279\u6b8a\u6216\u7279\u522b\u590d\u6742\u3002","link":"https:\/\/segmentfault.com\/a\/1190000000498466","imgUrl":"https:\/\/avatar-static.segmentfault.com\/266\/538\/2665388308-1030000000323597_huge256"};
        share.title += ' - SegmentFault 思否';

        $.getJSON('/api/util/weixin/jsapi', function (o) {
            methods = o.data.jsApiList.slice();

            wx.config(o.data);
            wx.error(console.error);
            wx.ready(function () {
                methods.forEach(function (method) {
                    wx[method](share);
                });
            });
        });
    });
}
</script>

<script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-918487-8']);
    _gaq.push(['_trackPageview']);
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

                
        

            

    ga('create', 'UA-918487-8', 'auto', {
        'userID'
    : 0,
        'createdTime'
    : 0,
        'now'
    : 1542694928,
        'allowLinker'
    : true });
    ga('require', 'linker');
    ga('linker:autoLink', ['docs.segmentfault.com'] );
    ga('set', 'dimension1', 'guest');
    ga('send', 'pageview');

</script>

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?e23800c454aa573c0ccb16b52665ac26";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>



</body>
</html>

